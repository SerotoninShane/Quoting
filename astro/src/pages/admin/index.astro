---
import AppHeader from '../../components/AppHeader.astro';
import TabSection from '../../components/TabSection.astro';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Krasiva Windows & Doors - Admin Control Panel</title>
  <link rel="stylesheet" href="/styles/shared.css">
  <style>
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header-actions {
      display: flex;
      gap: var(--gap);
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }

    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 1.5rem;
      border-bottom: var(--border);
      flex-wrap: wrap;
    }

    .tab {
      padding: 10px 16px;
      background: var(--bg-header);
      border: var(--border);
      border-bottom: none;
      cursor: pointer;
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: -1px;
      margin-right: -1px;
      transition: all var(--transition);
    }

    .tab:hover {
      background: #ffffff;
      color: var(--text-primary);
    }

    .tab.active {
      color: var(--text-primary);
      background: #ffffff;
      border-bottom: 1px solid #ffffff;
      font-weight: 600;
    }

    :global(.tab-content) {
      display: none;
      background: var(--bg-surface);
      padding: 1.5rem;
      border: var(--border);
      border-top: none;
      border-radius: 0 0 8px 8px;
      box-shadow: var(--shadow);
    }

    :global(.tab-content.active) {
      display: block;
    }
    h2 {
      margin-top: 1.5rem;
    }

    input, select, textarea {
      width: 100%;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
      margin-bottom: 0;
    }

    .form-row .form-group {
      margin-bottom: 0;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 20px;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      display: block;
    }

    .version-history {
      max-height: 400px;
      overflow-y: auto;
      border: var(--border);
      border-radius: 6px;
      padding: 1rem;
      background: var(--bg-surface);
      box-shadow: var(--shadow);
    }

    .version-item {
      padding: 12px;
      border-bottom: var(--border);
      font-size: 13px;
    }

    .version-item:last-child {
      border-bottom: none;
    }

    .version-timestamp {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(2px);
    }

    .modal-content {
      background: var(--bg-surface);
      margin: 5% auto;
      padding: 1.5rem;
      border: var(--border);
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      border-bottom: var(--border);
      padding-bottom: 12px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      color: var(--text-primary);
    }

    .modal-close {
      font-size: 1.5rem;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      color: var(--text-secondary);
      transition: color var(--transition);
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .card {
      background: var(--bg-surface);
      border: var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow);
    }

    .card h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      color: var(--text-primary);
    }
  </style>
</head>
<body>
  <div class="container">
    <AppHeader
      title="Admin Control Panel"
      subtitle="Full access to pricing configuration, versioning, and data management."
      linkHref="/sales"
      linkLabel="Sales Page"
      actionsClass="header-actions"
    >
      <button slot="actions" class="btn-success" onclick="publishVersion()">Publish Pricing Version</button>
    </AppHeader>

    <div id="alerts"></div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('manufacturers', event)">Manufacturers</button>
      <button class="tab" onclick="switchTab('productLines', event)">Product Lines</button>
      <button class="tab" onclick="switchTab('products', event)">Products</button>
      <button class="tab" onclick="switchTab('addons', event)">Addons</button>
      <button class="tab" onclick="switchTab('versions', event)">Version History</button>
      <button class="tab" onclick="switchTab('settings', event)">Settings</button>
    </div>

    <TabSection id="manufacturers" title="Manufacturers" active>
      <div class="form-row">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="mfg-name" placeholder="e.g., Andersen Windows">
        </div>
      </div>
      <button class="btn-primary" onclick="addManufacturer()">+ Add Manufacturer</button>
      <div id="mfg-table"></div>
    </TabSection>

    <TabSection id="productLines" title="Product Lines">
      <div class="form-row">
        <div class="form-group">
          <label>Manufacturer</label>
          <select id="pl-manufacturer"></select>
        </div>
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="pl-name" placeholder="e.g., 400 Series">
        </div>
      </div>
      <button class="btn-primary" onclick="addProductLine()">+ Add Product Line</button>
      <div id="pl-table"></div>
    </TabSection>

    <TabSection id="products" title="Products">
      <div class="form-row">
        <div class="form-group">
          <label>Product Type</label>
          <select id="prod-type">
            <option value="Window">Window</option>
            <option value="Door">Door</option>
            <option value="Sliding Door">Sliding Door</option>
            <option value="Bifold Door">Bifold Door</option>
            <option value="Sidelite">Sidelite</option>
            <option value="French Door">French Door</option>
          </select>
        </div>
        <div class="form-group">
          <label>Product Line</label>
          <select id="prod-line"></select>
        </div>
        <div class="form-group">
          <label>Type Code</label>
          <input type="text" id="prod-code" placeholder="e.g., SH, DH">
        </div>
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="prod-name" placeholder="e.g., Single Hung">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Pricing Model</label>
          <select id="prod-model" onchange="togglePricingFields()">
            <option value="UI">UI-Based</option>
            <option value="FLAT">Flat Price</option>
          </select>
        </div>
        <div class="form-group" id="prod-ui-rate-group">
          <label>UI Rate ($)</label>
          <input type="number" id="prod-ui-rate" step="0.01" placeholder="12.50">
        </div>
        <div class="form-group" id="prod-flat-price-group" style="display:none;">
          <label>Flat Price ($)</label>
          <input type="number" id="prod-flat-price" step="0.01" placeholder="2500">
        </div>
        <div class="form-group">
          <label>Minimum UI</label>
          <input type="number" id="prod-min-ui" placeholder="100">
        </div>
        <div class="form-group">
          <label>Maximum UI (blank = unlimited)</label>
          <input type="number" id="prod-max-ui" placeholder="500">
        </div>
      </div>
      <button class="btn-primary" onclick="addProduct()">+ Add Product</button>
      <div id="prod-table"></div>
    </TabSection>

    <TabSection id="addons" title="Addons">
      <div class="form-row">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="addon-name" placeholder="e.g., Colonial Grids">
        </div>
        <div class="form-group">
          <label>Pricing Model</label>
          <select id="addon-model" onchange="toggleAddonPricingFields()">
            <option value="UI">UI-Based</option>
            <option value="FLAT">Flat Price</option>
          </select>
        </div>
        <div class="form-group" id="addon-ui-rate-group">
          <label>UI Rate ($)</label>
          <input type="number" id="addon-ui-rate" step="0.01" placeholder="2.00">
        </div>
        <div class="form-group" id="addon-flat-price-group" style="display:none;">
          <label>Flat Price ($)</label>
          <input type="number" id="addon-flat-price" step="0.01" placeholder="350">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Exclusive Group (optional)</label>
          <input type="text" id="addon-exclusive" placeholder="e.g., glass_type">
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="checkbox" id="addon-mandatory" style="width: auto;">
            Mandatory
          </label>
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="checkbox" id="addon-hidden" style="width: auto;">
            Hidden from Customer
          </label>
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="checkbox" id="addon-job-based" style="width: auto;">
            Job Based (Global - apply to all quotes)
          </label>
        </div>
      </div>
      <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; font-size: 0.95rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;">Restrictions (Optional)</h3>
      <div class="form-row">
        <div class="form-group">
          <label>Allowed Product Types (leave blank for all)</label>
          <input type="text" id="addon-product-types" placeholder="e.g., Window, Door (comma-separated)">
        </div>
        <div class="form-group">
          <label>Allowed Product Lines (leave blank for all)</label>
          <input type="text" id="addon-product-lines" placeholder="e.g., Premium, Standard (comma-separated)">
        </div>
        <div class="form-group">
          <label>Max Size (sq ft, leave blank for unlimited)</label>
          <input type="number" id="addon-max-size" step="0.01" placeholder="21">
        </div>
        <div class="form-group">
          <label>Min Size (sq ft, leave blank for no minimum)</label>
          <input type="number" id="addon-min-size" step="0.01" placeholder="0">
        </div>
      </div>
      <button class="btn-primary" onclick="addAddon()">+ Add Addon</button>
      <div id="addon-table"></div>
    </TabSection>

    <TabSection id="versions" title="Pricing Version History" description="Manage and export previous pricing configurations.">
      <div style="display: flex; gap: 8px; margin-bottom: 1.5rem;">
        <button class="btn-secondary" onclick="exportVersionData()">Export Version</button>
        <button class="btn-secondary" onclick="importVersionData()">Import Version</button>
      </div>
      <div class="version-history" id="version-list"></div>
    </TabSection>

    <TabSection id="settings" title="Global Settings" description="Configure global rules that apply to all quotes.">
      <div class="form-row">
        <div class="form-group">
          <label>Minimum Window UI (inches)</label>
          <input type="number" id="setting-minimum-ui" min="0" step="1" placeholder="65">
          <small>All windows must have at least this many united inches (width + height)</small>
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="checkbox" id="setting-alerts-enabled" style="width: auto;">
            Enable Success Alerts
          </label>
          <small>Show notification messages when actions are completed</small>
        </div>
      </div>
      <div class="rules-panel">
        <div style="display:flex; align-items:center; justify-content: space-between; gap: 8px;">
          <div>
            <h3 style="margin: 0; font-size: 0.95rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;">Rules</h3>
            <div style="font-size: 12px; color: var(--text-secondary);">Use conditions to auto-apply mandatory addons</div>
          </div>
          <button class="btn-secondary" type="button" onclick="addRule()">+ Add Rule</button>
        </div>
        <div id="rules-list" style="margin-top: 12px;"></div>
      </div>
      <button class="btn-primary" onclick="saveGlobalSettings()">Save Settings</button>
      <div id="settings-status"></div>
    </TabSection>
  </div>

  <input type="file" id="version-import-file" accept=".json,.csv" style="display:none;" onchange="handleVersionImport()">

  <script type="module">
    import { PricingEngine } from '/pricing_engine.js';
    import { DataStorage } from '/data_storage.js';
    import { showAlert as showAlertShared, showModal } from '/shared/ui_helpers.js';

    // Initialize
    DataStorage.initializeSampleData();
    window.storage = DataStorage;
    window.engine = PricingEngine;

    // Global functions for UI
    window.switchTab = (tabName, evt) => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      const target = evt && (evt.currentTarget || evt.target);
      if (target && target.classList) target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      renderAll();
    };

    window.showAlert = (message, type = 'success') => {
      const settings = DataStorage.getGlobalSettings();
      const alertsEnabled = settings && settings.alertsEnabled !== false;
      showAlertShared(message, type, { enabled: alertsEnabled });
    };
    window.showModal = showModal;

    window.togglePricingFields = () => {
      const model = document.getElementById('prod-model').value;
      document.getElementById('prod-ui-rate-group').style.display = model === 'UI' ? '' : 'none';
      document.getElementById('prod-flat-price-group').style.display = model === 'FLAT' ? '' : 'none';
    };

    window.toggleAddonPricingFields = () => {
      const model = document.getElementById('addon-model').value;
      document.getElementById('addon-ui-rate-group').style.display = model === 'UI' ? '' : 'none';
      document.getElementById('addon-flat-price-group').style.display = model === 'FLAT' ? '' : 'none';
    };

    // Edit functionality
    window.openEditModal = (type, id) => {
      const items = DataStorage.get(type === 'mfg' ? DataStorage.KEYS.MANUFACTURERS : 
                                     type === 'line' ? DataStorage.KEYS.PRODUCT_LINES : 
                                     type === 'prod' ? DataStorage.KEYS.PRODUCTS :
                                     DataStorage.KEYS.ADDONS);
      const item = items[id];
      if (!item) return;

      let html = `<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.35); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);" id="edit-modal" onclick="if(event.target.id === 'edit-modal') this.remove()">
        <div style="background: white; padding: 1.5rem; border-radius: 8px; max-width: 500px; width: 90%; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">`;
      
      if (type === 'mfg') {
        html += `
          <h2>Edit Manufacturer</h2>
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="edit-mfg-name" value="${item.name}">
          </div>
          <div style="display: flex; gap: 8px; margin-top: 1.5rem;">
            <button class="btn-primary" onclick="saveEditedItem('mfg', '${id}')">Save</button>
            <button class="btn-secondary" onclick="document.getElementById('edit-modal').remove()">Cancel</button>
          </div>`;
      } else if (type === 'line') {
        html += `
          <h2>Edit Product Line</h2>
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="edit-line-name" value="${item.name}">
          </div>
          <div style="display: flex; gap: 8px; margin-top: 1.5rem;">
            <button class="btn-primary" onclick="saveEditedItem('line', '${id}')">Save</button>
            <button class="btn-secondary" onclick="document.getElementById('edit-modal').remove()">Cancel</button>
          </div>`;
      } else if (type === 'prod') {
        const lines = DataStorage.getProductLines();
        const productLineName = lines[item.productLineId]?.name || 'N/A';
        html += `
          <h2>Edit Product</h2>
          <div class="form-group">
            <label>Product Type (Immutable)</label>
            <div style="padding: 0.75rem; background: #f4f4f5; border-radius: 4px; border: 1px solid rgba(0,0,0,0.08); color: #666; font-weight: 500;">${item.productType}</div>
            <small style="display: block; margin-top: 0.5rem; color: #999;">Product type cannot be changed. It controls which addons are available for this product.</small>
          </div>
          <div class="form-group">
            <label>Product Line (Immutable)</label>
            <div style="padding: 0.75rem; background: #f4f4f5; border-radius: 4px; border: 1px solid rgba(0,0,0,0.08); color: #666; font-weight: 500;">${productLineName}</div>
            <small style="display: block; margin-top: 0.5rem; color: #999;">Product line cannot be changed after creation.</small>
          </div>
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="edit-prod-name" value="${item.name}">
          </div>
          <div class="form-group">
            <label>Product Type Code</label>
            <input type="text" id="edit-prod-code" value="${item.productTypeCode}">
          </div>
          <div class="form-group">
            <label>Pricing Model</label>
            <select id="edit-prod-model" onchange="window.toggleEditPricingFields()">
              <option value="UI" ${item.pricingModel === 'UI' ? 'selected' : ''}>UI Based</option>
              <option value="FLAT" ${item.pricingModel === 'FLAT' ? 'selected' : ''}>Flat Price</option>
            </select>
          </div>
          <div id="edit-prod-rate-group" class="form-group" ${item.pricingModel !== 'UI' ? 'style="display:none;"' : ''}>
            <label>UI Rate ($/UI)</label>
            <input type="number" step="0.01" id="edit-prod-ui-rate" value="${item.uiRate || ''}">
          </div>
          <div id="edit-prod-price-group" class="form-group" ${item.pricingModel !== 'FLAT' ? 'style="display:none;"' : ''}>
            <label>Flat Price</label>
            <input type="number" step="0.01" id="edit-prod-flat-price" value="${item.flatPrice || ''}">
          </div>
          <div class="form-group">
            <label>Minimum UI</label>
            <input type="number" id="edit-prod-min-ui" value="${item.minimumUI || ''}">
          </div>
          <div class="form-group">
            <label>Maximum UI (leave blank for unlimited)</label>
            <input type="number" id="edit-prod-max-ui" value="${item.maximumUI || ''}">
          </div>
          <div style="display: flex; gap: 8px; margin-top: 1.5rem;">
            <button class="btn-primary" onclick="saveEditedItem('prod', '${id}')">Save</button>
            <button class="btn-secondary" onclick="document.getElementById('edit-modal').remove()">Cancel</button>
          </div>`;
      } else if (type === 'addon') {
        html += `
          <h2>Edit Addon</h2>
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="edit-addon-name" value="${item.name}">
          </div>
          <div class="form-group">
            <label>Pricing Model</label>
            <select id="edit-addon-model" onchange="window.toggleEditAddonPricingFields()">
              <option value="UI" ${item.pricingModel === 'UI' ? 'selected' : ''}>UI Based</option>
              <option value="FLAT" ${item.pricingModel === 'FLAT' ? 'selected' : ''}>Flat Price</option>
            </select>
          </div>
          <div id="edit-addon-rate-group" class="form-group" ${item.pricingModel !== 'UI' ? 'style="display:none;"' : ''}>
            <label>UI Rate ($/UI)</label>
            <input type="number" step="0.01" id="edit-addon-ui-rate" value="${item.uiRate || ''}">
          </div>
          <div id="edit-addon-price-group" class="form-group" ${item.pricingModel !== 'FLAT' ? 'style="display:none;"' : ''}>
            <label>Flat Price</label>
            <input type="number" step="0.01" id="edit-addon-flat-price" value="${item.flatPrice || ''}">
          </div>
          <div class="form-group">
            <label>Exclusive Group (optional)</label>
            <input type="text" id="edit-addon-exclusive" value="${item.exclusiveGroup || ''}">
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="edit-addon-mandatory" ${item.mandatory ? 'checked' : ''} style="width: auto;">
              Mandatory
            </label>
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="edit-addon-hidden" ${item.hiddenFromCustomer ? 'checked' : ''} style="width: auto;">
              Hidden from Customer
            </label>
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="edit-addon-job-based" ${item.isJobBased ? 'checked' : ''} style="width: auto;">
              Job Based (Global - apply to all quotes)
            </label>
          </div>
          <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; font-size: 0.95rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;">Restrictions (Optional)</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Allowed Product Types</label>
              <input type="text" id="edit-addon-product-types" value="${(item.allowedProductTypes || []).join(', ')}" placeholder="e.g., Window, Door">
            </div>
            <div class="form-group">
              <label>Allowed Product Lines</label>
              <input type="text" id="edit-addon-product-lines" value="${(item.allowedProductLines || []).join(', ')}" placeholder="e.g., Premium, Standard">
            </div>
            <div class="form-group">
              <label>Max Size (sq ft)</label>
              <input type="number" step="0.01" id="edit-addon-max-size" value="${item.maxSize || ''}">
            </div>
            <div class="form-group">
              <label>Min Size (sq ft)</label>
              <input type="number" step="0.01" id="edit-addon-min-size" value="${item.minSize || ''}">
            </div>
          </div>
          <div style="display: flex; gap: 8px; margin-top: 1.5rem;">
            <button class="btn-primary" onclick="saveEditedItem('addon', '${id}')">Save</button>
            <button class="btn-secondary" onclick="document.getElementById('edit-modal').remove()">Cancel</button>
          </div>`;
      }
      
      html += `</div></div>`;
      document.body.insertAdjacentHTML('beforeend', html);
    };

    window.toggleEditPricingFields = () => {
      const model = document.getElementById('edit-prod-model').value;
      document.getElementById('edit-prod-rate-group').style.display = model === 'UI' ? '' : 'none';
      document.getElementById('edit-prod-price-group').style.display = model === 'FLAT' ? '' : 'none';
    };

    window.toggleEditAddonPricingFields = () => {
      const model = document.getElementById('edit-addon-model').value;
      document.getElementById('edit-addon-rate-group').style.display = model === 'UI' ? '' : 'none';
      document.getElementById('edit-addon-price-group').style.display = model === 'FLAT' ? '' : 'none';
    };

    window.saveEditedItem = (type, id) => {
      if (type === 'mfg') {
        const name = document.getElementById('edit-mfg-name').value.trim();
        if (!name) return showAlert('Please enter a name', 'error');
        const manufacturers = DataStorage.getManufacturers();
        manufacturers[id].name = name;
        DataStorage.set(DataStorage.KEYS.MANUFACTURERS, manufacturers);
      } else if (type === 'line') {
        const name = document.getElementById('edit-line-name').value.trim();
        if (!name) return showAlert('Please enter a name', 'error');
        const lines = DataStorage.getProductLines();
        lines[id].name = name;
        DataStorage.set(DataStorage.KEYS.PRODUCT_LINES, lines);
      } else if (type === 'prod') {
        const name = document.getElementById('edit-prod-name').value.trim();
        const code = document.getElementById('edit-prod-code').value.trim();
        const model = document.getElementById('edit-prod-model').value;
        if (!name || !code) return showAlert('Please fill all required fields', 'error');
        const products = DataStorage.getProducts();
        products[id].name = name;
        products[id].productTypeCode = code;
        products[id].pricingModel = model;
        // Note: productType and productLineId are NOT edited - they're immutable and control addon availability
        products[id].minimumUI = parseInt(document.getElementById('edit-prod-min-ui').value) || 0;
        products[id].maximumUI = parseInt(document.getElementById('edit-prod-max-ui').value) || null;
        if (model === 'UI') {
          products[id].uiRate = parseFloat(document.getElementById('edit-prod-ui-rate').value) || 0;
          delete products[id].flatPrice;
        } else {
          products[id].flatPrice = parseFloat(document.getElementById('edit-prod-flat-price').value) || 0;
          delete products[id].uiRate;
        }
        DataStorage.set(DataStorage.KEYS.PRODUCTS, products);
      } else if (type === 'addon') {
        const name = document.getElementById('edit-addon-name').value.trim();
        const model = document.getElementById('edit-addon-model').value;
        if (!name) return showAlert('Please enter a name', 'error');
        const addons = DataStorage.getAddons();
        addons[id].name = name;
        addons[id].pricingModel = model;
        addons[id].exclusiveGroup = document.getElementById('edit-addon-exclusive').value.trim() || null;
        addons[id].mandatory = document.getElementById('edit-addon-mandatory').checked;
        addons[id].hiddenFromCustomer = document.getElementById('edit-addon-hidden').checked;
        addons[id].isJobBased = document.getElementById('edit-addon-job-based').checked;
        
        // Parse restrictions
        const productTypesStr = document.getElementById('edit-addon-product-types').value.trim();
        addons[id].allowedProductTypes = productTypesStr 
          ? productTypesStr.split(',').map(t => t.trim()).filter(t => t)
          : null;
        
        const productLinesStr = document.getElementById('edit-addon-product-lines').value.trim();
        addons[id].allowedProductLines = productLinesStr
          ? productLinesStr.split(',').map(l => l.trim()).filter(l => l)
          : null;
        
        addons[id].maxSize = document.getElementById('edit-addon-max-size').value
          ? parseFloat(document.getElementById('edit-addon-max-size').value)
          : null;
        
        addons[id].minSize = document.getElementById('edit-addon-min-size').value
          ? parseFloat(document.getElementById('edit-addon-min-size').value)
          : null;
        
        if (model === 'UI') {
          addons[id].uiRate = parseFloat(document.getElementById('edit-addon-ui-rate').value) || 0;
          delete addons[id].flatPrice;
        } else {
          addons[id].flatPrice = parseFloat(document.getElementById('edit-addon-flat-price').value) || 0;
          delete addons[id].uiRate;
        }
        DataStorage.set(DataStorage.KEYS.ADDONS, addons);
      }
      document.getElementById('edit-modal').remove();
      renderAll();
      showAlert('Item updated successfully');
    };

    // Helper function to create human-readable slugs
    const slugify = (text) => {
      return text
        .toLowerCase()
        .trim()
        .replace(/[^\w\s-]/g, '') // Remove special chars
        .replace(/\s+/g, '_') // Replace spaces with underscores
        .replace(/_+/g, '_') // Replace multiple underscores with single
        .substring(0, 20); // Limit to 20 chars
    };

    // CRUD operations
    window.addManufacturer = () => {
      const name = document.getElementById('mfg-name').value.trim();
      if (!name) return showAlert('Please enter a name', 'error');

      const manufacturers = DataStorage.getManufacturers();
      const slug = slugify(name);
      const id = `mfg_${slug}`;
      manufacturers[id] = { id, name };
      DataStorage.set(DataStorage.KEYS.MANUFACTURERS, manufacturers);
      
      document.getElementById('mfg-name').value = '';
      renderAll();
      showAlert('Manufacturer added');
    };

    window.addProductLine = () => {
      const manufacturerId = document.getElementById('pl-manufacturer').value;
      const name = document.getElementById('pl-name').value.trim();
      if (!manufacturerId || !name) return showAlert('Please fill all fields', 'error');

      const lines = DataStorage.getProductLines();
      const slug = slugify(name);
      const id = `line_${slug}`;
      lines[id] = { id, manufacturerId, name };
      DataStorage.set(DataStorage.KEYS.PRODUCT_LINES, lines);
      
      document.getElementById('pl-name').value = '';
      renderAll();
      showAlert('Product line added');
    };

    window.addProduct = () => {
      const productType = document.getElementById('prod-type').value;
      const productLineId = document.getElementById('prod-line').value;
      const productTypeCode = document.getElementById('prod-code').value.trim();
      const name = document.getElementById('prod-name').value.trim();
      const pricingModel = document.getElementById('prod-model').value;
      const minimumUI = parseInt(document.getElementById('prod-min-ui').value) || 0;
      const maximumUI = parseInt(document.getElementById('prod-max-ui').value) || null;

      if (!productType || !productLineId || !productTypeCode || !name) {
        return showAlert('Please fill all required fields', 'error');
      }

      const products = DataStorage.getProducts();
      const slug = slugify(name);
      const id = `prod_${slug}`;
      const product = {
        id,
        productType,
        productLineId,
        productTypeCode,
        name,
        pricingModel,
        minimumUI,
        maximumUI,
        allowedAddons: []
      };

      if (pricingModel === 'UI') {
        product.uiRate = parseFloat(document.getElementById('prod-ui-rate').value) || 0;
      } else {
        product.flatPrice = parseFloat(document.getElementById('prod-flat-price').value) || 0;
      }

      products[id] = product;
      DataStorage.set(DataStorage.KEYS.PRODUCTS, products);
      
      document.getElementById('prod-code').value = '';
      document.getElementById('prod-name').value = '';
      document.getElementById('prod-ui-rate').value = '';
      document.getElementById('prod-flat-price').value = '';
      document.getElementById('prod-min-ui').value = '';
      document.getElementById('prod-max-ui').value = '';
      renderAll();
      showAlert('Product added');
    };

    window.addAddon = () => {
      const name = document.getElementById('addon-name').value.trim();
      const pricingModel = document.getElementById('addon-model').value;
      const exclusiveGroup = document.getElementById('addon-exclusive').value.trim() || null;
      const mandatory = document.getElementById('addon-mandatory').checked;
      const hiddenFromCustomer = document.getElementById('addon-hidden').checked;
      const isJobBased = document.getElementById('addon-job-based').checked;
      
      // Parse restrictions
      const productTypesStr = document.getElementById('addon-product-types').value.trim();
      const allowedProductTypes = productTypesStr 
        ? productTypesStr.split(',').map(t => t.trim()).filter(t => t)
        : null;
      
      const productLinesStr = document.getElementById('addon-product-lines').value.trim();
      const allowedProductLines = productLinesStr
        ? productLinesStr.split(',').map(l => l.trim()).filter(l => l)
        : null;
      
      const maxSize = document.getElementById('addon-max-size').value ? 
        parseFloat(document.getElementById('addon-max-size').value) : null;
      const minSize = document.getElementById('addon-min-size').value ?
        parseFloat(document.getElementById('addon-min-size').value) : null;

      if (!name) return showAlert('Please enter a name', 'error');

      const addons = DataStorage.getAddons();
      const slug = slugify(name);
      const id = `addon_${slug}`;
      const addon = {
        id,
        name,
        pricingModel,
        exclusiveGroup,
        mandatory,
        hiddenFromCustomer,
        isJobBased,
        allowedProductTypes,
        allowedProductLines,
        maxSize,
        minSize
      };

      if (pricingModel === 'UI') {
        addon.uiRate = parseFloat(document.getElementById('addon-ui-rate').value) || 0;
      } else {
        addon.flatPrice = parseFloat(document.getElementById('addon-flat-price').value) || 0;
      }

      addons[id] = addon;
      DataStorage.set(DataStorage.KEYS.ADDONS, addons);
      
      document.getElementById('addon-name').value = '';
      document.getElementById('addon-ui-rate').value = '';
      document.getElementById('addon-flat-price').value = '';
      document.getElementById('addon-exclusive').value = '';
      document.getElementById('addon-mandatory').checked = false;
      document.getElementById('addon-hidden').checked = false;
      document.getElementById('addon-job-based').checked = false;
      document.getElementById('addon-product-types').value = '';
      document.getElementById('addon-product-lines').value = '';
      document.getElementById('addon-max-size').value = '';
      document.getElementById('addon-min-size').value = '';
      renderAll();
      showAlert('Addon added');
    };

    window.deleteItem = (type, id) => {
      if (!confirm('Are you sure you want to delete this item?')) return;
      
      const key = {
        manufacturer: DataStorage.KEYS.MANUFACTURERS,
        productLine: DataStorage.KEYS.PRODUCT_LINES,
        product: DataStorage.KEYS.PRODUCTS,
        addon: DataStorage.KEYS.ADDONS
      }[type];

      const items = DataStorage.get(key);
      delete items[id];
      DataStorage.set(key, items);
      renderAll();
      showAlert('Item deleted');
    };

    window.publishVersion = (skipAlertAndExport) => {
      const name = prompt('Version name (optional):') || '';
      const notes = prompt('Version notes (optional):') || '';
      const version = DataStorage.publishPricingVersion(notes);
      if (name) {
        version.name = name;
        const versions = DataStorage.getPricingVersions();
        const idx = versions.findIndex(v => v.id === version.id);
        if (idx !== -1) {
          versions[idx].name = name;
          DataStorage.set(DataStorage.KEYS.PRICING_VERSIONS, versions);
        }
      }
      renderAll();
      
      if (skipAlertAndExport) {
        // Called from export flow - trigger export immediately
        setTimeout(() => {
          showExportFormatChoice(version.id);
        }, 100);
      } else {
        showAlert(`Version ${name || version.id} published successfully`);
      }
    };

    window.editVersion = (versionId) => {
      const versions = DataStorage.getPricingVersions();
      const version = versions.find(v => v.id === versionId);
      if (!version) return;

      const content = `
        <div class="form-group">
          <label>Version Name</label>
          <input type="text" id="edit-version-name" value="${version.name || ''}" placeholder="e.g., Q1 2026 Pricing">
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="edit-version-notes" style="width: 100%; padding: 10px 12px; border: var(--border); border-radius: 6px; font-family: inherit; font-size: 14px; resize: vertical; height: 100px;">${version.notes || ''}</textarea>
        </div>
      `;

      showModal('Edit Version', content, [
        { label: 'Save', type: 'primary', onclick: () => saveVersionEdit('${versionId}') },
        { label: 'Cancel', type: 'secondary', onclick: () => {} }
      ]);
    };

    window.saveVersionEdit = (versionId) => {
      const name = document.getElementById('edit-version-name').value.trim();
      const notes = document.getElementById('edit-version-notes').value.trim();
      
      const versions = DataStorage.getPricingVersions();
      const idx = versions.findIndex(v => v.id === versionId);
      if (idx !== -1) {
        if (name) versions[idx].name = name;
        if (notes) versions[idx].notes = notes;
        DataStorage.set(DataStorage.KEYS.PRICING_VERSIONS, versions);
        renderAll();
        showAlert('Version updated successfully');
      }
      // Close all modals
      document.querySelectorAll('[id^="modal-"]').forEach(m => m.remove());
    };

    window.deleteVersion = (versionId) => {
      if (!confirm('Are you sure you want to delete this version? This cannot be undone.')) return;
      
      const versions = DataStorage.getPricingVersions();
      const filtered = versions.filter(v => v.id !== versionId);
      DataStorage.set(DataStorage.KEYS.PRICING_VERSIONS, filtered);
      renderAll();
      showAlert('Version deleted successfully');
    };

    window.loadVersion = (versionId) => {
      if (!confirm('Load this version? Current unsaved changes will be replaced.')) return;
      
      const versions = DataStorage.getPricingVersions();
      const version = versions.find(v => v.id === versionId);
      if (!version) return;

      // Load version data
      DataStorage.set(DataStorage.KEYS.MANUFACTURERS, version.manufacturers || {});
      DataStorage.set(DataStorage.KEYS.PRODUCT_LINES, version.productLines || {});
      DataStorage.set(DataStorage.KEYS.PRODUCTS, version.products || {});
      DataStorage.set(DataStorage.KEYS.ADDONS, version.addons || {});
      
      renderAll();
      showAlert('Version loaded successfully. Current data replaced.');
    };

    window.showExportFormatChoice = (versionId) => {
      const versions = DataStorage.getPricingVersions();
      const version = versions.find(v => v.id === versionId);
      if (!version) return;

      const content = `
        <div class="form-group">
          <label>Select Format</label>
          <select id="export-format" style="width: 100%;">
            <option value="json">JSON</option>
            <option value="csv">CSV</option>
          </select>
        </div>
      `;

      showModal('Export Format', content, [
        { label: 'Export', type: 'primary', onclick: () => doExportVersionDirect(versionId) },
        { label: 'Cancel', type: 'secondary', onclick: () => {} }
      ]);
    };

    window.doExportVersionDirect = (versionId) => {
      const format = document.getElementById('export-format').value;
      const versions = DataStorage.getPricingVersions();
      const version = versions.find(v => v.id === versionId);
      if (!version) return;

      let content, filename, type;

      if (format === 'json') {
        content = JSON.stringify(version, null, 2);
        filename = `${version.name || version.id}.json`;
        type = 'application/json';
      } else {
        // CSV format
        let csv = '';
        
        // Export Manufacturers
        csv += 'MANUFACTURERS\n';
        csv += 'ID,Name\n';
        Object.values(version.manufacturers || {}).forEach(m => {
          csv += `"${m.id}","${m.name}"\n`;
        });
        csv += '\n';
        
        // Export Product Lines
        csv += 'PRODUCT LINES\n';
        csv += 'ID,Manufacturer ID,Name\n';
        Object.values(version.productLines || {}).forEach(pl => {
          csv += `"${pl.id}","${pl.manufacturerId}","${pl.name}"\n`;
        });
        csv += '\n';
        
        // Export Products
        csv += 'PRODUCTS\n';
        csv += 'ID,Product Line ID,Product Type,Type Code,Name,Pricing Model,UI Rate,Flat Price,Minimum UI,Maximum UI\n';
        Object.values(version.products || {}).forEach(p => {
          const uiRate = p.uiRate || '';
          const flatPrice = p.flatPrice || '';
          const maxUI = p.maximumUI || '';
          csv += `"${p.id}","${p.productLineId}","${p.productType}","${p.productTypeCode}","${p.name}","${p.pricingModel}","${uiRate}","${flatPrice}","${p.minimumUI}","${maxUI}"\n`;
        });
        csv += '\n';
        
        // Export Addons
        csv += 'ADDONS\n';
        csv += 'ID,Name,Pricing Model,UI Rate,Flat Price,Exclusive Group,Mandatory,Hidden From Customer,Job Based,Allowed Product Types,Allowed Product Lines,Min Size,Max Size\n';
        Object.values(version.addons || {}).forEach(a => {
          const uiRate = a.uiRate || '';
          const flatPrice = a.flatPrice || '';
          const exclusiveGroup = a.exclusiveGroup || '';
          const minSize = a.minSize || '';
          const maxSize = a.maxSize || '';
          const productTypes = (a.allowedProductTypes || []).join('; ');
          const productLines = (a.allowedProductLines || []).join('; ');
          csv += `"${a.id}","${a.name}","${a.pricingModel}","${uiRate}","${flatPrice}","${exclusiveGroup}","${a.mandatory ? 'YES' : 'NO'}","${a.hiddenFromCustomer ? 'YES' : 'NO'}","${a.isJobBased ? 'YES' : 'NO'}","${productTypes}","${productLines}","${minSize}","${maxSize}"\n`;
        });

        content = csv;
        filename = `${version.name || version.id}.csv`;
        type = 'text/csv';
      }

      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      showAlert('Version exported successfully');
      // Close all modals
      document.querySelectorAll('[id^="modal-"]').forEach(m => m.remove());
    };

    window.exportVersionData = () => {
      const versions = DataStorage.getPricingVersions();
      
      const content = `
        <p style="color: #666; margin-bottom: 1.5rem; margin-top: 0;">What would you like to export?</p>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <button id="export-save-current" style="text-align: left; padding: 12px 16px; border: none; background: var(--bg-header); cursor: pointer; border-radius: 6px;">
            <div style="font-weight: 600;">Save Current Version</div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Publish current work and export immediately</div>
          </button>
          <button id="export-existing" style="text-align: left; padding: 12px 16px; border: none; background: var(--bg-header); cursor: pointer; border-radius: 6px;">
            <div style="font-weight: 600;">Export Existing Version</div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Choose from previously saved versions</div>
          </button>
        </div>
      `;

      showModal('Export Version', content, [
        { label: 'Cancel', type: 'secondary', onclick: () => {} }
      ]);
      
      // Attach button handlers
      setTimeout(() => {
        const saveBtn = document.getElementById('export-save-current');
        const existingBtn = document.getElementById('export-existing');
        if (saveBtn) saveBtn.onclick = () => { 
          document.querySelectorAll('[id^="modal-"]').forEach(m => m.remove()); 
          saveCurrentAsVersion(); 
        };
        if (existingBtn) existingBtn.onclick = () => { 
          document.querySelectorAll('[id^="modal-"]').forEach(m => m.remove()); 
          exportExistingVersion(); 
        };
      }, 50);
    };

    window.saveCurrentAsVersion = () => {
      publishVersion(true);
    };

    window.exportVersionById = (versionId) => {
      const versions = DataStorage.getPricingVersions();
      const version = versions.find(v => v.id === versionId);
      if (!version) {
        return showAlert('Version not found', 'error');
      }

      const content = `
        <div class="form-group">
          <label>Export Format</label>
          <select id="export-format-direct" style="width: 100%;">
            <option value="json">JSON</option>
            <option value="csv">CSV</option>
          </select>
        </div>
      `;

      showModal('Export Version', content, [
        { label: 'Export', type: 'primary', onclick: function() { performDirectExport(versionId); } },
        { label: 'Cancel', type: 'secondary', onclick: () => {} }
      ]);
    };

    window.performDirectExport = (versionId) => {
      const format = document.getElementById('export-format-direct').value;
      performDirectExportWithFormat(versionId, format);
    };

    window.performDirectExportWithFormat = (versionId, format) => {
      try {
        const versions = DataStorage.getPricingVersions();
        const version = versions.find(v => v.id === versionId);
        if (!version) {
          showAlert('Version not found', 'error');
          return;
        }

        let content, filename, type;

        if (format === 'json') {
          content = JSON.stringify(version, null, 2);
          filename = `${version.name || version.id}.json`;
          type = 'application/json';
        } else {
          // CSV format
          let csv = '';
          
          // Export Manufacturers
          csv += 'MANUFACTURERS\n';
          csv += 'ID,Name\n';
          Object.values(version.manufacturers || {}).forEach(m => {
            csv += `"${m.id}","${m.name}"\n`;
          });
          csv += '\n';
          
          // Export Product Lines
          csv += 'PRODUCT LINES\n';
          csv += 'ID,Manufacturer ID,Name\n';
          Object.values(version.productLines || {}).forEach(pl => {
            csv += `"${pl.id}","${pl.manufacturerId}","${pl.name}"\n`;
          });
          csv += '\n';
          
          // Export Products
          csv += 'PRODUCTS\n';
          csv += 'ID,Product Line ID,Product Type,Type Code,Name,Pricing Model,UI Rate,Flat Price,Minimum UI,Maximum UI\n';
          Object.values(version.products || {}).forEach(p => {
            const uiRate = p.uiRate || '';
            const flatPrice = p.flatPrice || '';
            const maxUI = p.maximumUI || '';
            csv += `"${p.id}","${p.productLineId}","${p.productType}","${p.productTypeCode}","${p.name}","${p.pricingModel}","${uiRate}","${flatPrice}","${p.minimumUI}","${maxUI}"\n`;
          });
          csv += '\n';
          
          // Export Addons
          csv += 'ADDONS\n';
          csv += 'ID,Name,Pricing Model,UI Rate,Flat Price,Exclusive Group,Mandatory,Hidden From Customer,Job Based,Allowed Product Types,Allowed Product Lines,Min Size,Max Size\n';
          Object.values(version.addons || {}).forEach(a => {
            const uiRate = a.uiRate || '';
            const flatPrice = a.flatPrice || '';
            const exclusiveGroup = a.exclusiveGroup || '';
            const minSize = a.minSize || '';
            const maxSize = a.maxSize || '';
            const productTypes = (a.allowedProductTypes || []).join('; ');
            const productLines = (a.allowedProductLines || []).join('; ');
            csv += `"${a.id}","${a.name}","${a.pricingModel}","${uiRate}","${flatPrice}","${exclusiveGroup}","${a.mandatory ? 'YES' : 'NO'}","${a.hiddenFromCustomer ? 'YES' : 'NO'}","${a.isJobBased ? 'YES' : 'NO'}","${productTypes}","${productLines}","${minSize}","${maxSize}"\n`;
          });

          content = csv;
          filename = `${version.name || version.id}.csv`;
          type = 'text/csv';
        }

        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        
        setTimeout(() => {
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        }, 100);

        showAlert('Version exported successfully');
        // Close all modals
        document.querySelectorAll('[id^="modal-"]').forEach(m => m.remove());
      } catch (error) {
        console.error('Export error:', error);
        showAlert('Export failed: ' + error.message, 'error');
      }
    };

    window.exportExistingVersion = () => {
      const versions = DataStorage.getPricingVersions();
      if (versions.length === 0) {
        return showAlert('No versions to export', 'error');
      }

      const versionSelect = versions.map((v, idx) => `<option value="${v.id}">${v.name || v.id} (${new Date(v.timestamp).toLocaleDateString()})</option>`).join('');
      
      const content = `
        <div class="form-group">
          <label>Select Version</label>
          <select id="version-to-export-select" style="width: 100%;">${versionSelect}</select>
        </div>
        <div class="form-group">
          <label>Export Format</label>
          <select id="export-format-select" style="width: 100%;">
            <option value="json">JSON</option>
            <option value="csv">CSV</option>
          </select>
        </div>
      `;

      const modalId = showModal('Export Existing Version', content, [
        { label: 'Export', type: 'primary', onclick: function() {} },
        { label: 'Cancel', type: 'secondary', onclick: () => {} }
      ]);

      // Immediately after modal is created, attach the proper handler
      setTimeout(() => {
        const btnId = `btn-${modalId}-0`;
        const btnElement = document.getElementById(btnId);
        if (btnElement) {
          btnElement.onclick = (e) => {
            e.preventDefault();
            const versionId = document.getElementById('version-to-export-select').value;
            const format = document.getElementById('export-format-select').value;
            // Remove the modal
            const modal = document.getElementById(modalId);
            if (modal) modal.remove();
            // Then export
            performDirectExportWithFormat(versionId, format);
          };
        }
      }, 10);
    };

    window.importVersionData = () => {
      if (currentDataHasChanges()) {
        const content = `
          <p style="margin-top: 0;">You have unsaved changes. Would you like to save your current version before importing?</p>
        `;
        
        showModal('Save Current Version?', content, [
          { label: 'Save & Import', type: 'primary', onclick: () => saveCurrentVersionBeforeImport() },
          { label: 'Discard & Import', type: 'secondary', onclick: () => document.getElementById('version-import-file').click() },
          { label: 'Cancel', type: 'secondary', onclick: () => {} }
        ]);
      } else {
        document.getElementById('version-import-file').click();
      }
    };

    window.saveCurrentVersionBeforeImport = () => {
      const content = `
        <div class="form-group">
          <label>Version Name</label>
          <input type="text" id="save-version-name" placeholder="e.g., Current Pricing" value="Auto-save ${new Date().toLocaleString()}">
        </div>
        <div class="form-group">
          <label>Version Notes (Optional)</label>
          <textarea id="save-version-notes" style="width: 100%; padding: 10px 12px; border: var(--border); border-radius: 6px; font-family: inherit; font-size: 14px; resize: vertical; height: 80px;" placeholder="Add notes about this version..."></textarea>
        </div>
      `;

      showModal('Save Current Version', content, [
        { label: 'Save & Import', type: 'primary', onclick: () => confirmSaveVersionBeforeImport() },
        { label: 'Cancel', type: 'secondary', onclick: () => {} }
      ]);
    };

    window.confirmSaveVersionBeforeImport = () => {
      const name = document.getElementById('save-version-name').value.trim() || `Auto-save ${new Date().toLocaleString()}`;
      const notes = document.getElementById('save-version-notes').value.trim();
      const version = DataStorage.publishPricingVersion(notes);
      version.name = name;
      const versions = DataStorage.getPricingVersions();
      const idx = versions.findIndex(v => v.id === version.id);
      if (idx !== -1) {
        versions[idx].name = name;
        DataStorage.set(DataStorage.KEYS.PRICING_VERSIONS, versions);
      }
      showAlert('Version saved. You can now import new data.');
      // Close any open modals and trigger import
      document.querySelectorAll('[id^="modal-"]').forEach(m => m.remove());
      setTimeout(() => {
        document.getElementById('version-import-file').click();
      }, 500);
    };

    window.handleVersionImport = () => {
      const file = document.getElementById('version-import-file').files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const content = e.target.result;
          
          if (file.name.endsWith('.json')) {
            // Handle JSON import
            const versionData = JSON.parse(content);
            
            // Validate it's a version object
            if (!versionData.id || !versionData.manufacturers) {
              return showAlert('Invalid version JSON format', 'error');
            }
            
            // Load the version data
            DataStorage.set(DataStorage.KEYS.MANUFACTURERS, versionData.manufacturers || {});
            DataStorage.set(DataStorage.KEYS.PRODUCT_LINES, versionData.productLines || {});
            DataStorage.set(DataStorage.KEYS.PRODUCTS, versionData.products || {});
            DataStorage.set(DataStorage.KEYS.ADDONS, versionData.addons || {});
            
            renderAll();
            showAlert('Version imported from JSON successfully');
          } else if (file.name.endsWith('.csv')) {
            // Handle CSV import
            const lines = content.trim().split('\n');
            const data = {
              manufacturers: {},
              productLines: {},
              products: {},
              addons: {}
            };
            
            let currentSection = null;
            
            for (let i = 0; i < lines.length; i++) {
              const line = lines[i].trim();
              
              if (line === 'MANUFACTURERS') {
                currentSection = 'manufacturers';
                i++; // skip header line
                continue;
              } else if (line === 'PRODUCT LINES') {
                currentSection = 'productLines';
                i++; // skip header line
                continue;
              } else if (line === 'PRODUCTS') {
                currentSection = 'products';
                i++; // skip header line
                continue;
              } else if (line === 'ADDONS') {
                currentSection = 'addons';
                i++; // skip header line
                continue;
              } else if (line === '') {
                continue;
              }
              
              // Parse CSV line
              const values = [];
              let current = '';
              let inQuotes = false;
              
              for (let j = 0; j < line.length; j++) {
                const char = line[j];
                if (char === '"') {
                  inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                  values.push(current.trim());
                  current = '';
                } else {
                  current += char;
                }
              }
              values.push(current.trim());
              
              if (currentSection === 'manufacturers' && values.length >= 2) {
                const id = values[0].replace(/"/g, '');
                const name = values[1].replace(/"/g, '');
                data.manufacturers[id] = { id, name };
              } else if (currentSection === 'productLines' && values.length >= 3) {
                const id = values[0].replace(/"/g, '');
                const manufacturerId = values[1].replace(/"/g, '');
                const name = values[2].replace(/"/g, '');
                data.productLines[id] = { id, manufacturerId, name };
              } else if (currentSection === 'products' && values.length >= 5) {
                const id = values[0].replace(/"/g, '');
                const productLineId = values[1].replace(/"/g, '');
                const productType = values[2].replace(/"/g, '');
                const productTypeCode = values[3].replace(/"/g, '');
                const name = values[4].replace(/"/g, '');
                const pricingModel = values[5].replace(/"/g, '');
                const uiRate = values[6] ? parseFloat(values[6].replace(/"/g, '')) : undefined;
                const flatPrice = values[7] ? parseFloat(values[7].replace(/"/g, '')) : undefined;
                const minimumUI = values[8] ? parseInt(values[8].replace(/"/g, '')) : 0;
                const maximumUI = values[9] && values[9].replace(/"/g, '') ? parseInt(values[9].replace(/"/g, '')) : null;
                
                const product = {
                  id, productLineId, productType, productTypeCode, name, pricingModel, minimumUI, maximumUI
                };
                if (pricingModel === 'UI' && uiRate !== undefined) product.uiRate = uiRate;
                if (pricingModel === 'FLAT' && flatPrice !== undefined) product.flatPrice = flatPrice;
                
                data.products[id] = product;
              } else if (currentSection === 'addons' && values.length >= 4) {
                const id = values[0].replace(/"/g, '');
                const name = values[1].replace(/"/g, '');
                const pricingModel = values[2].replace(/"/g, '');
                const uiRate = values[3] ? parseFloat(values[3].replace(/"/g, '')) : undefined;
                const flatPrice = values[4] ? parseFloat(values[4].replace(/"/g, '')) : undefined;
                const exclusiveGroup = values[5].replace(/"/g, '') || null;
                const mandatory = values[6].replace(/"/g, '').toUpperCase() === 'YES';
                const hiddenFromCustomer = values[7].replace(/"/g, '').toUpperCase() === 'YES';
                const isJobBased = values[8].replace(/"/g, '').toUpperCase() === 'YES';
                const productTypesStr = values[9].replace(/"/g, '');
                const productLinesStr = values[10].replace(/"/g, '');
                const minSize = values[11] && values[11].replace(/"/g, '') ? parseFloat(values[11].replace(/"/g, '')) : null;
                const maxSize = values[12] && values[12].replace(/"/g, '') ? parseFloat(values[12].replace(/"/g, '')) : null;
                
                const addon = {
                  id, name, pricingModel, exclusiveGroup, mandatory, hiddenFromCustomer, isJobBased,
                  minSize, maxSize
                };
                
                if (pricingModel === 'UI' && uiRate !== undefined) addon.uiRate = uiRate;
                if (pricingModel === 'FLAT' && flatPrice !== undefined) addon.flatPrice = flatPrice;
                
                addon.allowedProductTypes = productTypesStr ? productTypesStr.split(';').map(t => t.trim()).filter(t => t) : null;
                addon.allowedProductLines = productLinesStr ? productLinesStr.split(';').map(l => l.trim()).filter(l => l) : null;
                
                data.addons[id] = addon;
              }
            }
            
            // Load the imported data
            DataStorage.set(DataStorage.KEYS.MANUFACTURERS, data.manufacturers);
            DataStorage.set(DataStorage.KEYS.PRODUCT_LINES, data.productLines);
            DataStorage.set(DataStorage.KEYS.PRODUCTS, data.products);
            DataStorage.set(DataStorage.KEYS.ADDONS, data.addons);
            
            renderAll();
            showAlert('Version imported from CSV successfully');
          } else {
            showAlert('Please select a JSON or CSV file', 'error');
          }
          
          document.getElementById('version-import-file').value = '';
        } catch (error) {
          showAlert(`Import failed: ${error.message}`, 'error');
          console.error(error);
        }
      };
      reader.readAsText(file);
    };

    window.currentDataHasChanges = () => {
      // Simple check - if current working data differs from last published version
      // For now, always prompt to be safe
      return true;
    };

    // Render functions
    function renderAll() {
      renderManufacturers();
      renderProductLines();
      renderProducts();
      renderAddons();
      renderVersions();
      renderSettings();
      populateDropdowns();
    }

    function renderManufacturers() {
      const manufacturers = DataStorage.getManufacturers();
      const html = `
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${Object.values(manufacturers).map(m => `
              <tr>
                <td>${m.id}</td>
                <td>${m.name}</td>
                <td><button class="btn-primary" onclick="openEditModal('mfg', '${m.id}')">Edit</button> <button class="btn-danger" onclick="deleteItem('manufacturer', '${m.id}')">Delete</button></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('mfg-table').innerHTML = html;
    }

    function renderProductLines() {
      const lines = DataStorage.getProductLines();
      const manufacturers = DataStorage.getManufacturers();
      const html = `
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Manufacturer</th>
              <th>Name</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${Object.values(lines).map(l => `
              <tr>
                <td>${l.id}</td>
                <td>${manufacturers[l.manufacturerId]?.name || 'N/A'}</td>
                <td>${l.name}</td>
                <td><button class="btn-primary" onclick="openEditModal('line', '${l.id}')">Edit</button> <button class="btn-danger" onclick="deleteItem('productLine', '${l.id}')">Delete</button></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('pl-table').innerHTML = html;
    }

    function renderProducts() {
      const products = DataStorage.getProducts();
      const lines = DataStorage.getProductLines();
      const html = `
        <table>
          <thead>
            <tr>
              <th>Code</th>
              <th>Product Line</th>
              <th>Name</th>
              <th>Model</th>
              <th>Rate/Price</th>
              <th>Min UI</th>
              <th>Max UI</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${Object.values(products).map(p => `
              <tr>
                <td>${p.productTypeCode}</td>
                <td>${lines[p.productLineId]?.name || 'N/A'}</td>
                <td>${p.name}</td>
                <td>${p.pricingModel}</td>
                <td>${p.pricingModel === 'UI' ? `$${p.uiRate}/UI` : `$${p.flatPrice}`}</td>
                <td>${p.minimumUI}</td>
                <td>${p.maximumUI ? p.maximumUI : 'Unlimited'}</td>
                <td><button class="btn-primary" onclick="openEditModal('prod', '${p.id}')">Edit</button> <button class="btn-danger" onclick="deleteItem('product', '${p.id}')">Delete</button></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('prod-table').innerHTML = html;
    }

    function renderAddons() {
      const addons = DataStorage.getAddons();
      const html = `
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Model</th>
              <th>Rate/Price</th>
              <th>Exclusive Group</th>
              <th>Mandatory</th>
              <th>Hidden</th>
              <th>Job Based</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${Object.values(addons).map(a => `
              <tr>
                <td>${a.name}</td>
                <td>${a.pricingModel}</td>
                <td>${a.pricingModel === 'UI' ? `$${a.uiRate}/UI` : `$${a.flatPrice}`}</td>
                <td>${a.exclusiveGroup || '-'}</td>
                <td>${a.mandatory ? '' : ''}</td>
                <td>${a.hiddenFromCustomer ? '' : ''}</td>
                <td>${a.isJobBased ? '' : ''}</td>
                <td><button class="btn-primary" onclick="openEditModal('addon', '${a.id}')">Edit</button> <button class="btn-danger" onclick="deleteItem('addon', '${a.id}')">Delete</button></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('addon-table').innerHTML = html;
    }

    function renderVersions() {
      const versions = DataStorage.getPricingVersions();
      const html = versions.reverse().map((v, idx) => `
        <div class="version-item">
          <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
            <div style="flex: 1;">
              <strong>${v.name || v.id}</strong>
              <div class="version-timestamp">${new Date(v.timestamp).toLocaleString()}</div>
              <div>${v.notes || '<em>No notes</em>'}</div>
              <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">
                ${Object.keys(v.manufacturers || {}).length} manufacturers, 
                ${Object.keys(v.products || {}).length} products, 
                ${Object.keys(v.addons || {}).length} addons
              </div>
            </div>
            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
              <button class="btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="editVersion('${v.id}')">Edit</button>
              <button class="btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="exportVersionById('${v.id}')">Export</button>
              <button class="btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="loadVersion('${v.id}')">Load</button>
              <button class="btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteVersion('${v.id}')">Delete</button>
            </div>
          </div>
        </div>
      `).join('');
      document.getElementById('version-list').innerHTML = html || '<p>No versions published yet.</p>';
    }

    function getRuleTemplate() {
      return {
        id: `rule_${Date.now()}_${Math.floor(Math.random() * 1000)}`,
        name: '',
        appliesTo: 'line',
        addonId: '',
        enabled: true,
        conditions: [getConditionTemplate()]
      };
    }

    function getConditionTemplate() {
      return {
        id: `cond_${Date.now()}_${Math.floor(Math.random() * 1000)}`,
        type: 'houseAge',
        operator: '>=',
        value: ''
      };
    }

    function buildOptions(options, selectedValue = '') {
      return options.map(opt => {
        const value = typeof opt === 'string' ? opt : opt.value;
        const label = typeof opt === 'string' ? opt : opt.label;
        const selected = value === selectedValue ? 'selected' : '';
        return `<option value="${value}" ${selected}>${label}</option>`;
      }).join('');
    }

    function getRulesFromUI() {
      const ruleElements = Array.from(document.querySelectorAll('.rule-row'));
      if (ruleElements.length === 0) return null;
      return ruleElements.map(ruleEl => {
        const ruleId = ruleEl.getAttribute('data-rule-id');
        const name = ruleEl.querySelector('.rule-name')?.value?.trim() || '';
        const appliesTo = ruleEl.querySelector('.rule-applies-to')?.value || 'line';
        const addonId = ruleEl.querySelector('.rule-addon-id')?.value || '';
        const enabled = ruleEl.querySelector('.rule-enabled')?.checked !== false;
        const conditionEls = Array.from(ruleEl.querySelectorAll('.rule-condition'));
        const conditions = conditionEls.map(condEl => {
          const type = condEl.querySelector('.rule-condition-type')?.value || 'houseAge';
          const operator = condEl.querySelector('.rule-condition-operator')?.value || '>=';
          let value = '';
          if (type === 'productLine') {
            value = condEl.querySelector('.rule-condition-value-line')?.value || '';
          } else if (type === 'product') {
            value = condEl.querySelector('.rule-condition-value-product')?.value || '';
          } else if (type === 'addonSelected') {
            value = condEl.querySelector('.rule-condition-value-addon')?.value || '';
          } else {
            value = condEl.querySelector('.rule-condition-value-number')?.value || '';
          }
          return {
            id: condEl.getAttribute('data-condition-id') || `cond_${Date.now()}`,
            type,
            operator,
            value
          };
        });
        return {
          id: ruleId || `rule_${Date.now()}`,
          name,
          appliesTo,
          addonId,
          enabled,
          conditions
        };
      });
    }

    function renderRules(rulesOverride = null) {
      const settings = DataStorage.getGlobalSettings();
      const rules = Array.isArray(rulesOverride)
        ? rulesOverride
        : (Array.isArray(settings.rules) ? settings.rules : []);
      const products = DataStorage.getProducts();
      const lines = DataStorage.getProductLines();
      const addons = DataStorage.getAddons();

      const lineOptions = [{ value: '', label: 'Select product line...' }].concat(
        Object.values(lines).map(line => ({ value: line.id, label: line.name }))
      );
      const productOptions = [{ value: '', label: 'Select product...' }].concat(
        Object.values(products).map(product => ({ value: product.id, label: product.name }))
      );
      const addonOptions = [{ value: '', label: 'Select addon...' }].concat(
        Object.values(addons).map(addon => ({ value: addon.id, label: addon.name }))
      );

      const html = rules.map(rule => {
        const conditionsHtml = (rule.conditions || []).map(condition => {
          return `
            <div class="rule-condition" data-rule-id="${rule.id}" data-condition-id="${condition.id}">
              <select class="rule-condition-type" onchange="updateConditionVisibility('${rule.id}','${condition.id}')">
                ${buildOptions([
                  { value: 'houseAge', label: 'House age (years)' },
                  { value: 'ui', label: 'Total UI' },
                  { value: 'area', label: 'Area (sq ft)' },
                  { value: 'productLine', label: 'Product line' },
                  { value: 'product', label: 'Product' },
                  { value: 'addonSelected', label: 'Addon selected' }
                ], condition.type)}
              </select>
              <select class="rule-condition-operator">
                ${buildOptions([
                  { value: '>=', label: '>=' },
                  { value: '>', label: '>' },
                  { value: '<=', label: '<=' },
                  { value: '<', label: '<' },
                  { value: '==', label: '=' },
                  { value: '!=', label: '' }
                ], condition.operator || '>=')}
              </select>
              <input type="number" class="rule-condition-value-number" placeholder="Value" value="${condition.value ?? ''}">
              <select class="rule-condition-value-line">
                ${buildOptions(lineOptions, condition.value)}
              </select>
              <select class="rule-condition-value-product">
                ${buildOptions(productOptions, condition.value)}
              </select>
              <select class="rule-condition-value-addon">
                ${buildOptions(addonOptions, condition.value)}
              </select>
              <button class="btn-danger" type="button" onclick="removeRuleCondition('${rule.id}','${condition.id}')">Remove</button>
            </div>
          `;
        }).join('');

        return `
          <div class="rule-row" data-rule-id="${rule.id}">
            <div class="rule-header">
              <input type="text" class="rule-name" placeholder="Rule name" value="${rule.name || ''}" style="flex: 1; min-width: 180px;">
              <select class="rule-applies-to">
                ${buildOptions([
                  { value: 'line', label: 'Line Item' },
                  { value: 'job', label: 'Job' }
                ], rule.appliesTo || 'line')}
              </select>
              <select class="rule-addon-id">
                ${buildOptions(addonOptions, rule.addonId || '')}
              </select>
              <label style="display:flex; align-items:center; gap:6px; font-size: 12px; color: var(--text-secondary);">
                <input type="checkbox" class="rule-enabled" ${rule.enabled !== false ? 'checked' : ''}>
                Enabled
              </label>
              <button class="btn-danger" type="button" onclick="deleteRule('${rule.id}')">Delete</button>
            </div>
            <div style="font-size: 12px; color: var(--text-secondary);">All conditions must match (AND)</div>
            <div class="rule-conditions">
              ${conditionsHtml || ''}
            </div>
            <div style="margin-top: 8px;">
              <button class="btn-secondary" type="button" onclick="addRuleCondition('${rule.id}')">+ Add Condition</button>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('rules-list').innerHTML = html || '<p style="color: var(--text-secondary); font-size: 13px;">No rules yet.</p>';

      // Update visibility for all conditions
      rules.forEach(rule => {
        (rule.conditions || []).forEach(condition => {
          updateConditionVisibility(rule.id, condition.id);
        });
      });
    }

    window.addRule = () => {
      const currentRules = getRulesFromUI();
      const rules = Array.isArray(currentRules)
        ? currentRules
        : (Array.isArray(DataStorage.getGlobalSettings().rules) ? DataStorage.getGlobalSettings().rules : []);
      rules.push(getRuleTemplate());
      renderRules(rules);
    };

    window.addRuleCondition = (ruleId) => {
      const currentRules = getRulesFromUI();
      const rules = Array.isArray(currentRules)
        ? currentRules
        : (Array.isArray(DataStorage.getGlobalSettings().rules) ? DataStorage.getGlobalSettings().rules : []);
      const rule = rules.find(r => r.id === ruleId);
      if (!rule) return;
      rule.conditions = rule.conditions || [];
      rule.conditions.push(getConditionTemplate());
      renderRules(rules);
    };

    window.removeRuleCondition = (ruleId, conditionId) => {
      const currentRules = getRulesFromUI();
      const rules = Array.isArray(currentRules)
        ? currentRules
        : (Array.isArray(DataStorage.getGlobalSettings().rules) ? DataStorage.getGlobalSettings().rules : []);
      const rule = rules.find(r => r.id === ruleId);
      if (!rule) return;
      rule.conditions = (rule.conditions || []).filter(c => c.id !== conditionId);
      if (rule.conditions.length === 0) {
        rule.conditions.push(getConditionTemplate());
      }
      renderRules(rules);
    };

    window.deleteRule = (ruleId) => {
      const currentRules = getRulesFromUI();
      const rules = Array.isArray(currentRules)
        ? currentRules
        : (Array.isArray(DataStorage.getGlobalSettings().rules) ? DataStorage.getGlobalSettings().rules : []);
      const nextRules = rules.filter(r => r.id !== ruleId);
      renderRules(nextRules);
    };

    window.updateConditionVisibility = (ruleId, conditionId) => {
      const row = document.querySelector(`.rule-condition[data-rule-id="${ruleId}"][data-condition-id="${conditionId}"]`);
      if (!row) return;
      const typeSelect = row.querySelector('.rule-condition-type');
      const operatorSelect = row.querySelector('.rule-condition-operator');
      const numberInput = row.querySelector('.rule-condition-value-number');
      const lineSelect = row.querySelector('.rule-condition-value-line');
      const productSelect = row.querySelector('.rule-condition-value-product');
      const addonSelect = row.querySelector('.rule-condition-value-addon');

      const type = typeSelect ? typeSelect.value : '';

      const isNumeric = type === 'houseAge' || type === 'ui' || type === 'area';
      const isLine = type === 'productLine';
      const isProduct = type === 'product';
      const isAddon = type === 'addonSelected';

      if (operatorSelect) operatorSelect.style.display = isNumeric ? 'inline-block' : 'none';
      if (numberInput) numberInput.style.display = isNumeric ? 'inline-block' : 'none';
      if (lineSelect) lineSelect.style.display = isLine ? 'inline-block' : 'none';
      if (productSelect) productSelect.style.display = isProduct ? 'inline-block' : 'none';
      if (addonSelect) addonSelect.style.display = isAddon ? 'inline-block' : 'none';
    };

    function renderSettings() {
      const settings = DataStorage.getGlobalSettings();
      const minimumUI = settings.minimumUI !== undefined ? settings.minimumUI : 65;
      document.getElementById('setting-minimum-ui').value = minimumUI;
      document.getElementById('setting-alerts-enabled').checked = settings.alertsEnabled !== false;
      renderRules();
    }

    window.saveGlobalSettings = () => {
      const inputValue = document.getElementById('setting-minimum-ui').value.trim();
      const minimumUI = inputValue === '' ? undefined : parseInt(inputValue);
      const alertsEnabled = document.getElementById('setting-alerts-enabled').checked !== false;
      
      if (minimumUI !== undefined && (isNaN(minimumUI) || minimumUI < 0)) {
        return showAlert('Minimum UI must be 0 or greater', 'error');
      }

      try {
        const rules = getRulesFromUI() || [];

        const settingsToSave = { alertsEnabled, rules };
        if (minimumUI !== undefined) {
          settingsToSave.minimumUI = minimumUI;
        }
        DataStorage.updateGlobalSettings(settingsToSave);
        showAlert('Settings saved successfully!', 'success');
        renderSettings();
      } catch (error) {
        showAlert(error.message, 'error');
      }
    };

    function populateDropdowns() {
      const manufacturers = DataStorage.getManufacturers();
      const lines = DataStorage.getProductLines();
      
      document.getElementById('pl-manufacturer').innerHTML = 
        Object.values(manufacturers).map(m => `<option value="${m.id}">${m.name}</option>`).join('');
      
      document.getElementById('prod-line').innerHTML = 
        Object.values(lines).map(l => `<option value="${l.id}">${l.name}</option>`).join('');
    }

    // Initial render
    renderAll();
  </script>
</body>
</html>
