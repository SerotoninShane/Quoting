---
import AppHeader from '../../components/AppHeader.astro';
import Card from '../../components/Card.astro';
import '../../styles/sales.css';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Krasiva Windows & Doors - Sales Quote Builder</title>
  <link rel="stylesheet" href="/styles/shared.css">
  
</head>
<body>
  <div class="container">
    <AppHeader
      title="Krasiva Windows & Doors"
      subtitle="Create customer quotes with live pricing calculation."
      linkHref="/admin"
      linkLabel="Admin Panel"
      actionsStyle="display: flex; gap: 8px; margin-top: 1.5rem; flex-wrap: wrap;"
    >
      <button slot="actions" class="btn-secondary" onclick="showSavedQuotes()">Load Quote</button>
      <button slot="actions" class="btn-secondary" onclick="newQuote()">New Quote</button>
      <button slot="actions" class="btn-success" onclick="saveQuote()">Save Quote</button>
    </AppHeader>

    <div id="alerts"></div>

    <Card title="Quote Information">
      <div class="form-row">
        <div class="form-group">
          <label>Quote ID</label>
          <input type="text" id="quote-id" readonly>
        </div>
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="quote-date">
        </div>
        <div class="form-group">
          <label>Customer Name <span style="color:#dc2626;">*</span></label>
          <input type="text" id="customer-name" placeholder="Enter customer name">
        </div>
        <div class="form-group">
          <label>Spouse / Co-Owner</label>
          <input type="text" id="spouse-name" placeholder="Optional">
        </div>
        <div class="form-group">
          <label>Address</label>
          <textarea id="customer-address" rows="2" style="padding:10px 12px; border: var(--border); border-radius:6px; background: var(--bg-input);"></textarea>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="customer-phone" placeholder="Primary phone">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="customer-email" placeholder="Primary email">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>House Age (years)</label>
          <input type="number" id="house-age" min="0" step="1" placeholder="e.g., 25">
        </div>
      </div>
    </Card>

    <Card title="Add Item">
      
      <div class="form-row">
        <div class="form-group">
          <label>Room Location <span style="color:#dc2626;">*</span></label>
          <input type="text" id="room-label" placeholder="e.g., Master Bedroom, Living Room">
        </div>
        <div class="form-group">
          <label>Product Line</label>
          <select id="product-line" onchange="updateProductOptions()">
            <option value="">Select product line...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Product <span style="color:#dc2626;">*</span></label>
          <select id="product" onchange="updateProductInfo()">
            <option value="">Select product...</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Width (inches) <span style="color:#dc2626;">*</span></label>
          <input type="number" id="width" step="0.125" placeholder="36">
        </div>
        <div class="form-group">
          <label>Height (inches) <span style="color:#dc2626;">*</span></label>
          <input type="number" id="height" step="0.125" placeholder="60">
        </div>
        <div class="form-group">
          <label>Total UI</label>
          <input type="number" id="total-ui" step="1" placeholder="96" readonly>
        </div>
      </div>

      <div class="window-visualizer">
        <div class="visualizer-grid">
          <div style="display: flex; flex-direction: column; gap: 0.75rem; justify-content: flex-start;">
            <div id="extras-section" style="display: block; margin-top: 0.25rem;">
              <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; display: block;">Notes / Site Adjustments</label>
              <textarea id="extra-notes" rows="3" style="width: 100%; padding: 10px 12px; border: var(--border); border-radius: 6px; background: var(--bg-input); font-size: 13px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; resize: vertical;"></textarea>
              <div id="selected-addons" style="margin-top:8px; font-size:13px; color: var(--text-secondary);"></div>
            </div>
          </div>
          <div>
            <div class="visualizer-canvas">
              <div id="viz-svg-container"></div>
            </div>

            <div style="display: flex; gap: 8px; align-items: center; margin-top: 0.75rem;">
              <button class="btn-secondary" type="button" onclick="openAddonModal()" id="addons-button">+ Add-Ons</button>
              <button class="btn-secondary" type="button" onclick="toggleStructural()" id="structural-toggle">⧉ Structural</button>
              <div style="display:flex; align-items:center; gap:8px;">
                <button id="frame-color-button" class="btn-secondary" type="button" onclick="openColorModal()" style="display:flex; align-items:center; gap:8px;">
                  <span id="frame-color-swatch" class="color-swatch" style="background:#ffffff;"></span>
                  <span id="frame-color-label">White</span>
                  <span style="margin-left:6px; opacity:0.7;">▾</span>
                </button>
                <input type="hidden" id="frame-color" value="white">
              </div>
            </div>

            <div id="structural-section" style="display: none; margin-top: 0.25rem;">
              <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; display: block;">Structural / Mulling</label>
              <select id="mull-type" style="margin-top: 4px;">
                <option value="">None</option>
                <option value="left">Left</option>
                <option value="right">Right</option>
                <option value="center">Center</option>
                <option value="above">Above</option>
                <option value="below">Below</option>
              </select>
              <div style="display:flex; gap:8px; margin-top:8px;">
                <div style="flex:1;">
                  <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; display: block;">Hinge Side</label>
                  <select id="hinge-side" style="margin-top:4px; width:100%;">
                    <option value="">Not Applicable</option>
                    <option value="left">Left</option>
                    <option value="right">Right</option>
                  </select>
                </div>
                <div style="flex:1;">
                  <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; display: block;">Swing</label>
                  <select id="swing-type" style="margin-top:4px; width:100%;">
                    <option value="">Not Applicable</option>
                    <option value="inswing">Inswing</option>
                    <option value="outswing">Outswing</option>
                  </select>
                </div>
              </div>
            </div>

            <div id="addons-section" style="display: none; margin: 0;">
              <div id="addons-list" style="display: none;"></div>
            </div>
          </div>
        </div>
      </div>

      <button class="btn-primary" onclick="addLineItem()">+ Add Item</button>
    </Card>

    <Card title="Quote Line Items">
      <div id="line-items-table"></div>
    </Card>

    <Card title="Job Addons">
      <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 1rem;">Apply to the entire job</p>
      <div id="job-addons-section"></div>
    </Card>

    <Card title="Job Notes">
      <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 1rem;">Notes that apply to the entire job (not per-item)</p>
      <textarea id="job-notes" rows="4" style="width:100%; padding:10px 12px; border: var(--border); border-radius:6px; background: var(--bg-input);"></textarea>
    </Card>

    <Card>
      <div class="form-row">
        <div class="form-group">
          <label>Sales Commission / Uplift ($)</label>
          <input type="number" id="sales-uplift" value="0" step="0.01" onchange="calculateQuoteTotal()">
        </div>
      </div>
    </Card>

    <div class="quote-total">
      <h2>Customer Price</h2>
      <div class="price" id="final-price">$0.00</div>
      <button class="btn-success" style="margin-top: 1rem;" onclick="generateQuoteDocument()">Generate Quote Document</button>
    </div>
  </div>

  <script type="module">
    import { PricingEngine } from '/pricing_engine.js';
    import { DataStorage } from '/data_storage.js';
    import { showAlert as showAlertShared, showModal } from '/shared/ui_helpers.js';

    // Initialize
    DataStorage.initializeSampleData();
    
    let currentQuote = {
      id: `quote_${Date.now()}`,
      customerName: '',
      lineItems: [],
      salesUplift: 0,
      selectedJobAddonIds: [],
      ruleAppliedJobAddonIds: [],
      houseAge: null
    };

    // Visualizer state
    let vizWidth = 0;
    let vizHeight = 0;
    let vizWindowType = 'door';
    const vizScale = 5; // pixels per inch
    

    function getActiveRules(appliesTo) {
      const settings = DataStorage.getGlobalSettings();
      const rules = Array.isArray(settings.rules) ? settings.rules : [];
      return rules.filter(rule => rule && rule.enabled !== false && rule.appliesTo === appliesTo && rule.addonId);
    }

    function compareNumeric(value, operator, target) {
      if (value === null || value === undefined || isNaN(value) || isNaN(target)) return false;
      switch (operator) {
        case '>': return value > target;
        case '>=': return value >= target;
        case '<': return value < target;
        case '<=': return value <= target;
        case '==': return value === target;
        case '!=': return value !== target;
        default: return false;
      }
    }

    function evaluateCondition(condition, context) {
      const type = condition.type;
      if (type === 'houseAge') {
        return compareNumeric(context.houseAge, condition.operator, parseFloat(condition.value));
      }
      if (type === 'ui') {
        return compareNumeric(context.ui, condition.operator, parseFloat(condition.value));
      }
      if (type === 'area') {
        return compareNumeric(context.area, condition.operator, parseFloat(condition.value));
      }
      if (type === 'productLine') {
        return Boolean(condition.value) && context.productLineId === condition.value;
      }
      if (type === 'product') {
        return Boolean(condition.value) && context.productId === condition.value;
      }
      if (type === 'addonSelected') {
        return Boolean(condition.value) && (context.selectedAddonIds || []).includes(condition.value);
      }
      return false;
    }

    function evaluateRule(rule, context) {
      if (!rule || !Array.isArray(rule.conditions) || rule.conditions.length === 0) return false;
      return rule.conditions.every(condition => evaluateCondition(condition, context));
    }

    function applyRuleAddons(appliesTo, context, selectedAddonIds) {
      const allAddons = DataStorage.getAddons();
      const rules = getActiveRules(appliesTo);
      const selected = new Set(selectedAddonIds || []);
      const ruleApplied = new Set();

      let changed = true;
      let guard = 0;
      while (changed && guard < 10) {
        changed = false;
        guard += 1;

        for (const rule of rules) {
          if (!evaluateRule(rule, { ...context, selectedAddonIds: Array.from(selected) })) continue;
          const addon = allAddons[rule.addonId];
          if (!addon) continue;
          if (appliesTo === 'job' && !addon.isJobBased) continue;
          if (appliesTo === 'line' && addon.isJobBased) continue;
          if (!selected.has(rule.addonId)) {
            selected.add(rule.addonId);
            ruleApplied.add(rule.addonId);
            changed = true;
          }
        }
      }

      return {
        selectedAddonIds: Array.from(selected),
        ruleAppliedIds: Array.from(ruleApplied)
      };
    }


    // Confirm before leaving sales page (save prompt)
    window.confirmLeaveAdmin = (event, targetUrl = null) => {
      if (event && event.preventDefault) event.preventDefault();

      // Derive targetUrl from clicked anchor if not provided
      if (!targetUrl && event) {
        const a = event.currentTarget || (event.target && event.target.closest && event.target.closest('a'));
        targetUrl = a ? a.getAttribute('href') : null;
      }

      const hasUnsaved = (currentQuote.lineItems && currentQuote.lineItems.length > 0) || (document.getElementById('customer-name').value.trim() !== '') || ((parseFloat(document.getElementById('sales-uplift').value) || 0) !== 0);
      if (!hasUnsaved) {
        if (targetUrl) window.location.href = targetUrl;
        return;
      }

      showModal('Leave Sales Page?', '<p>Do you want to save the current quote before leaving the sales page?</p>', [
        { label: 'Save & Leave', type: 'primary', onclick: () => { window._suppressBeforeUnload = true; saveQuote(); if (targetUrl) window.location.href = targetUrl; } },
        { label: 'Leave Without Saving', type: 'danger', onclick: () => { window._suppressBeforeUnload = true; if (targetUrl) window.location.href = targetUrl; } },
        { label: 'Cancel', type: 'secondary', onclick: () => { window._suppressBeforeUnload = false; } }
      ]);
    };

    // Prompt using native dialog on reload/close/navigation events
    window._suppressBeforeUnload = window._suppressBeforeUnload || false;
    window.addEventListener('beforeunload', (e) => {
      if (window._suppressBeforeUnload) return undefined;
      const hasUnsaved = (currentQuote.lineItems && currentQuote.lineItems.length > 0) || (document.getElementById('customer-name').value.trim() !== '') || ((parseFloat(document.getElementById('sales-uplift').value) || 0) !== 0);
      if (hasUnsaved) {
        e.preventDefault();
        e.returnValue = '';
        return '';
      }
      return undefined;
    });

    // Visualizer helpers
    function buildVisualizerSvgString(widthVal, heightVal, type = 'single', maxDim = 240) {
      const scaledWidth = widthVal * vizScale;
      const scaledHeight = heightVal * vizScale;
      const maxWidth = maxDim;
      const maxHeight = maxDim;

      let displayScale = 1;
      if (scaledWidth > maxWidth || scaledHeight > maxHeight) {
        const widthScale = maxWidth / scaledWidth;
        const heightScale = maxHeight / scaledHeight;
        displayScale = Math.min(widthScale, heightScale);
      }

      const displayWidth = scaledWidth * displayScale;
      const displayHeight = scaledHeight * displayScale;
      const margin = 40; // space around the drawn window
      const svgWidth = displayWidth + margin * 2;
      const svgHeight = displayHeight + margin * 2;

      const halfHeight = displayHeight / 2;
      const halfWidth = displayWidth / 2;

      const measureOffset = 15; // distance from rect to measurement line
      const measureLabelOffset = 5; // additional offset for the label text

      const typeMarkup = (() => {
        switch (type) {
          case 'single':
          case 'double':
            return `
              <line x1="${margin}" y1="${margin + halfHeight}" x2="${margin + displayWidth}" y2="${margin + halfHeight}"
                    stroke="black" stroke-width="3" />
            `;
          case 'slider':
            return `
              <line x1="${margin + halfWidth}" y1="${margin}" x2="${margin + halfWidth}" y2="${margin + displayHeight}"
                    stroke="black" stroke-width="3" />
            `;
          case 'casement':
            return `
              <line x1="${margin}" y1="${margin}" x2="${margin}" y2="${margin + displayHeight}"
                    stroke="black" stroke-width="4" />
            `;
          case 'awning':
            return `
              <line x1="${margin}" y1="${margin}" x2="${margin + displayWidth}" y2="${margin}"
                    stroke="black" stroke-width="4" />
            `;
          case 'fixed':
            return `
                <line x1="${margin}" y1="${margin + halfHeight}" x2="${margin + displayWidth}" y2="${margin + halfHeight}"
                  stroke="black" stroke-width="2" stroke-dasharray="5,5" />
                <line x1="${margin + halfWidth}" y1="${margin}" x2="${margin + halfWidth}" y2="${margin + displayHeight}"
                  stroke="black" stroke-width="2" stroke-dasharray="5,5" />
            `;
          case 'door':
            // Door - simple rectangle with no internal markings
            return '';
          case 'oriel':
            // 60/40 oriel with 60% below the meeting rail (40% above)
            const orielSplit = margin + (displayHeight * 0.6);
            return `
              <line x1="${margin}" y1="${orielSplit}" x2="${margin + displayWidth}" y2="${orielSplit}"
                    stroke="black" stroke-width="3" />
            `;
          case 'eyebrow':
            // Eyebrow window - arched top section
            const eyebrowHeight = displayHeight * 0.25;
            const eyebrowY = margin + eyebrowHeight;
            const controlY = margin - eyebrowHeight * 0.3;
            return `
              <path d="M ${margin} ${eyebrowY} Q ${margin + halfWidth} ${controlY}, ${margin + displayWidth} ${eyebrowY}"
                    stroke="black" stroke-width="4" fill="none" />
              <line x1="${margin}" y1="${eyebrowY}" x2="${margin}" y2="${margin + displayHeight}"
                    stroke="black" stroke-width="4" />
              <line x1="${margin + displayWidth}" y1="${eyebrowY}" x2="${margin + displayWidth}" y2="${margin + displayHeight}"
                    stroke="black" stroke-width="4" />
              <line x1="${margin}" y1="${margin + halfHeight + eyebrowHeight / 2}" x2="${margin + displayWidth}" y2="${margin + halfHeight + eyebrowHeight / 2}"
                    stroke="black" stroke-width="3" />
            `;
          case 'eyebrow-legs':
            // Eyebrow with legs - arched top with extended vertical sections
            const legEyebrowHeight = displayHeight * 0.2;
            const legEyebrowY = margin + legEyebrowHeight;
            const legControlY = margin - legEyebrowHeight * 0.3;
            return `
              <path d="M ${margin} ${legEyebrowY} Q ${margin + halfWidth} ${legControlY}, ${margin + displayWidth} ${legEyebrowY}"
                    stroke="black" stroke-width="4" fill="none" />
              <line x1="${margin}" y1="${legEyebrowY}" x2="${margin}" y2="${margin + displayHeight}"
                    stroke="black" stroke-width="4" />
              <line x1="${margin + displayWidth}" y1="${legEyebrowY}" x2="${margin + displayWidth}" y2="${margin + displayHeight}"
                    stroke="black" stroke-width="4" />
              <line x1="${margin}" y1="${margin + halfHeight + legEyebrowHeight}" x2="${margin + displayWidth}" y2="${margin + halfHeight + legEyebrowHeight}"
                    stroke="black" stroke-width="3" />
            `;
          default:
            return '';
        }
      })();

      return `
        <svg width="${svgWidth}" height="${svgHeight}" viewBox="0 0 ${svgWidth} ${svgHeight}">
          <defs>
            <marker id="vizArrowStart" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
              <polygon points="8,5 2,2 2,8" fill="#666" />
            </marker>
            <marker id="vizArrowEnd" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
              <polygon points="2,5 8,2 8,8" fill="#666" />
            </marker>
          </defs>

              <line x1="${margin}" y1="${margin - measureOffset}" x2="${margin + displayWidth}" y2="${margin - measureOffset}"
                stroke="#666" stroke-width="1"
                marker-start="url(#vizArrowStart)" marker-end="url(#vizArrowEnd)" />
              <text x="${displayWidth / 2 + margin}" y="${margin - (measureOffset + measureLabelOffset)}"
                text-anchor="middle" class="dimension-label">${widthVal}"</text>

              <line x1="${margin - measureOffset}" y1="${margin}" x2="${margin - measureOffset}" y2="${margin + displayHeight}"
                stroke="#666" stroke-width="1"
                marker-start="url(#vizArrowStart)" marker-end="url(#vizArrowEnd)" />
              <text x="${margin - (measureOffset + measureLabelOffset)}" y="${displayHeight / 2 + margin}"
                text-anchor="middle" class="dimension-label"
                transform="rotate(-90, ${margin - (measureOffset + measureLabelOffset)}, ${displayHeight / 2 + margin})">${heightVal}"</text>

              ${type === 'eyebrow' || type === 'eyebrow-legs' ? `
                <!-- Frame without top and sides for eyebrow variants (sides are in typeMarkup) -->
                <line x1="${margin}" y1="${margin + displayHeight}" x2="${margin + displayWidth}" y2="${margin + displayHeight}" stroke="black" stroke-width="4" />
                <rect x="${margin}" y="${margin}" width="${displayWidth}" height="${displayHeight}" fill="white" stroke="none" />
              ` : `
                <rect x="${margin}" y="${margin}" width="${displayWidth}" height="${displayHeight}"
                  fill="white" stroke="black" stroke-width="4" />
              `}

          ${typeMarkup}

          <g opacity="0.3">
            <line x1="34" y1="34" x2="${26 + displayWidth}" y2="${26 + displayHeight}" stroke="lightblue" stroke-width="1" />
            <line x1="${26 + displayWidth}" y1="34" x2="34" y2="${26 + displayHeight}" stroke="lightblue" stroke-width="1" />
          </g>
        </svg>
      `;
    }

    function renderVisualizer() {
      const svgContainer = document.getElementById('viz-svg-container');
      if (!svgContainer) return;
      
      // Only render if we have valid dimensions
      if (!vizWidth || !vizHeight || vizWidth <= 0 || vizHeight <= 0) {
        svgContainer.innerHTML = '<div style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--text-secondary); font-size:13px;">Enter dimensions to preview</div>';
        return;
      }
      
      // Use a max dimension slightly smaller than the canvas to ensure padding fits
      // Reduce slightly so measurement labels never get cropped for tall windows
      const svg = buildVisualizerSvgString(vizWidth, vizHeight, vizWindowType, 340);
      svgContainer.innerHTML = svg;
    }

    function syncVisualizerFromInputs() {
      const widthField = document.getElementById('width');
      const heightField = document.getElementById('height');
      vizWidth = parseFloat(widthField.value) || 0;
      vizHeight = parseFloat(heightField.value) || 0;
      renderVisualizer();
    }

    // Detect if special addons are selected and update visualizer
    function detectAndUpdateVisualizerForAddons() {
      // Only apply to hung windows (single/double)
      const currentProduct = document.getElementById('product').value;
      if (!currentProduct) return;
      
      const products = DataStorage.getProducts();
      const product = products[currentProduct];
      const baseVizType = deriveVisualizerType(product);
      
      // Only apply to hung windows
      if (baseVizType !== 'single' && baseVizType !== 'double') return;
      
      // Check which addons are selected
      const selectedAddons = Array.from(document.querySelectorAll('.product-addon:checked'));
      const allAddons = DataStorage.getAddons();
      
      let newVizType = baseVizType; // default to original type
      
      // Check for oriel, eyebrow, or eyebrow with legs
      for (const checkbox of selectedAddons) {
        const addon = allAddons[checkbox.value];
        if (!addon) continue;
        
        const addonNameLower = addon.name.toLowerCase();
        
        // Check for eyebrow with legs first (more specific)
        if (addonNameLower.includes('eyebrow') && addonNameLower.includes('leg')) {
          newVizType = 'eyebrow-legs';
          break;
        }
        // Check for eyebrow
        else if (addonNameLower.includes('eyebrow')) {
          newVizType = 'eyebrow';
          break;
        }
        // Check for oriel
        else if (addonNameLower.includes('oriel')) {
          newVizType = 'oriel';
          break;
        }
      }
      
      // Update visualizer if type changed
      if (vizWindowType !== newVizType) {
        vizWindowType = newVizType;
        renderVisualizer();
      }
    }

    function svgToDataUrl(svgString) {
      // Clean the SVG string and encode properly
      const cleaned = svgString.trim();
      const encoded = btoa(unescape(encodeURIComponent(cleaned)));
      return `data:image/svg+xml;charset=utf-8;base64,${encoded}`;
    }

    function buildAddonModalList() {
      const sourceNodes = Array.from(document.querySelectorAll('#addons-list .addon-checkbox'));
      if (sourceNodes.length === 0) return '<p style="margin:0; color: var(--text-secondary); font-size: 13px;">No addons available for this product.</p>';
      return sourceNodes.map(node => {
        const input = node.querySelector('input');
        const label = node.querySelector('label');
        const checked = input && input.checked ? 'checked' : '';
        const id = input ? input.id : '';
        const value = input ? input.value : '';
        const text = label ? label.innerHTML : '';
        const dataLabel = node.dataset.label || '';
        return `
          <div class="addon-checkbox" data-label="${dataLabel}">
            <input type="checkbox" id="modal-${id}" data-sync-id="${id}" value="${value}" ${checked}>
            <label for="modal-${id}" style="margin: 0; flex: 1; font-weight: 500; text-transform: none;">${text}</label>
          </div>
        `;
      }).join('');
    }

    function openAddonModal() {
      const modalHtml = `
        <div style="display:flex; flex-direction:column; gap:12px; max-height:60vh;">
          <input type="text" id="addon-search" placeholder="Search addons..." style="padding:10px 12px; border: var(--border); border-radius:6px; font-size:14px; background: var(--bg-input);">
          <div id="addon-modal-list" style="max-height:48vh; overflow-y:auto; border: var(--border); border-radius:6px; padding:8px; background: var(--bg-surface);">
            ${buildAddonModalList()}
          </div>
        </div>
      `;

      const modalId = showModal('Select Addons', modalHtml, [
        { label: 'Done', type: 'primary', onclick: () => {} }
      ]);

      // Wire syncing and filtering once modal is in DOM
      setTimeout(() => {
        const modalEl = document.getElementById(modalId);
        if (!modalEl) return;
        const modalList = modalEl.querySelector('#addon-modal-list');
        const searchInput = modalEl.querySelector('#addon-search');

        // Sync checkboxes back to hidden list and trigger change events
        modalList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.addEventListener('change', () => {
            const targetId = cb.dataset.syncId;
            const original = document.getElementById(targetId);
            if (original) {
              original.checked = cb.checked;
              try { original.dispatchEvent(new Event('change', { bubbles: true })); } catch (e) { /* ignore */ }
            }
          });
        });

        // Filter by label text
        if (searchInput) {
          searchInput.addEventListener('input', () => {
            const term = searchInput.value.trim().toLowerCase();
            modalList.querySelectorAll('.addon-checkbox').forEach(item => {
              const label = item.dataset.label || '';
              item.style.display = term === '' || label.includes(term) ? 'flex' : 'none';
            });
          });
        }
      }, 0);
    }

    function openColorModal() {
      const colors = [
        { id: 'white', name: 'White', hex: '#ffffff' },
        { id: 'tan', name: 'Tan', hex: '#d6c3a6' },
        { id: 'adobe', name: 'Adobe', hex: '#c58b68' },
        { id: 'black', name: 'Black', hex: '#222222' }
      ];

      const items = colors.map(c => `
        <button class="btn-secondary" data-color="${c.id}" style="display:flex; align-items:center; gap:8px; padding:8px;">
          <span class="color-swatch" style="background:${c.hex}; width:20px; height:20px; border-radius:4px;"></span>
          <span style="font-weight:600;">${c.name}</span>
        </button>
      `).join('');

      const modalHtml = `<div style="display:flex; gap:8px; flex-wrap:wrap;">${items}</div>`;
      const modalId = showModal('Select Frame Color', modalHtml, [ { label: 'Done', type: 'primary', onclick: () => {} } ]);

      // Wire selection
      setTimeout(() => {
        const modalEl = document.getElementById(modalId);
        if (!modalEl) return;
        modalEl.querySelectorAll('button[data-color]').forEach(btn => {
          btn.addEventListener('click', () => {
            const color = btn.dataset.color;
            const map = { white: '#ffffff', tan: '#d6c3a6', adobe: '#c58b68', black: '#222222' };
            const hidden = document.getElementById('frame-color');
            if (hidden) hidden.value = color;
            updateColorPreview();
            // Visual feedback inside modal
            modalEl.querySelectorAll('button[data-color]').forEach(b => b.style.boxShadow = 'none');
            btn.style.boxShadow = '0 4px 10px rgba(0,0,0,0.08)';
          });
        });
      }, 0);
    }

    function updateColorPreview() {
      const hidden = document.getElementById('frame-color');
      const swatch = document.getElementById('frame-color-swatch');
      const label = document.getElementById('frame-color-label');
      if (!hidden || !swatch || !label) return;
      const v = hidden.value || 'white';
      const map = { white: '#ffffff', tan: '#d6c3a6', adobe: '#c58b68', black: '#222222' };
      swatch.style.background = map[v] || v;
      label.textContent = v.charAt(0).toUpperCase() + v.slice(1);
      // keep button text color unchanged to remain readable on all swatches
    }

    // Render selected product addons under the notes area
    window.renderSelectedAddons = () => {
      const container = document.getElementById('selected-addons');
      if (!container) return;
      const checked = Array.from(document.querySelectorAll('.product-addon:checked'))
        .map(cb => cb.value);

      if (checked.length === 0) {
        container.innerHTML = '<p style="margin:0; color: var(--text-secondary); font-size: 13px;">No selected addons</p>';
        // Check for visualizer update even when no addons selected (to reset)
        detectAndUpdateVisualizerForAddons();
        return;
      }

      const allAddons = DataStorage.getAddons();
      const ui = parseInt(document.getElementById('total-ui').value) || 0;

      const html = checked.map(id => {
        const addon = allAddons[id];
        if (!addon) return '';
        const price = addon.pricingModel === 'UI' ? `$${(ui * addon.uiRate).toFixed(2)}` : `$${(addon.flatPrice || 0).toFixed(2)}`;
        return `<div style="display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom: 1px dashed rgba(0,0,0,0.04);">
                  <div style="font-weight:500;">${addon.name}</div>
                  <div style="color:var(--text-secondary); font-size:13px; display:flex; gap:8px; align-items:center;">
                    <div>${price}</div>
                    <button class="btn-secondary" style="padding:4px 8px; font-size:12px;" onclick="(function(id){ const cb = document.getElementById('addon-'+id); if(cb){ cb.checked=false; cb.dispatchEvent(new Event('change',{bubbles:true})); } })('${id}')">Remove</button>
                  </div>
                </div>`;
      }).join('');

      container.innerHTML = html;
      
      // Detect and update visualizer for special addons
      detectAndUpdateVisualizerForAddons();
    };

    function toggleStructural() {
      // Open structural options in a modal and sync changes back to the hidden fields
      const modalHtml = `
        <div style="display:flex; flex-direction:column; gap:12px;">
          <label style="font-size:12px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; margin:0;">Structural / Mulling</label>
          <select id="modal-mull" style="margin-top:4px; padding:8px;">
            <option value="">None</option>
            <option value="left">Left</option>
            <option value="right">Right</option>
            <option value="center">Center</option>
            <option value="above">Above</option>
            <option value="below">Below</option>
          </select>
          <div style="display:flex; gap:8px;">
            <div style="flex:1;">
              <label style="font-size:12px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; margin:0;">Hinge Side</label>
              <select id="modal-hinge" style="margin-top:4px; padding:8px; width:100%;">
                <option value="">Not Applicable</option>
                <option value="left">Left</option>
                <option value="right">Right</option>
              </select>
            </div>
            <div style="flex:1;">
              <label style="font-size:12px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; margin:0;">Swing</label>
              <select id="modal-swing" style="margin-top:4px; padding:8px; width:100%;">
                <option value="">Not Applicable</option>
                <option value="inswing">Inswing</option>
                <option value="outswing">Outswing</option>
              </select>
            </div>
          </div>
        </div>
      `;

      const modalId = showModal('Structural / Mulling', modalHtml, [ { label: 'Done', type: 'primary', onclick: () => {} } ]);

      // Wire sync: copy modal values back to main form selects as user changes them
      setTimeout(() => {
        const modalEl = document.getElementById(modalId);
        if (!modalEl) return;

        const mMull = modalEl.querySelector('#modal-mull');
        const mHinge = modalEl.querySelector('#modal-hinge');
        const mSwing = modalEl.querySelector('#modal-swing');

        const origMull = document.getElementById('mull-type');
        const origHinge = document.getElementById('hinge-side');
        const origSwing = document.getElementById('swing-type');

        if (origMull && mMull) mMull.value = origMull.value || '';
        if (origHinge && mHinge) mHinge.value = origHinge.value || '';
        if (origSwing && mSwing) mSwing.value = origSwing.value || '';

        [mMull, mHinge, mSwing].forEach(el => {
          if (!el) return;
          el.addEventListener('change', () => {
            try {
              const targetId = el.id === 'modal-mull' ? 'mull-type' : (el.id === 'modal-hinge' ? 'hinge-side' : 'swing-type');
              const orig = document.getElementById(targetId);
              if (orig) orig.value = el.value;
            } catch (err) {}
          });
        });
      }, 0);
    }

    // Expose UI toggles to inline handlers
    window.openAddonModal = openAddonModal;
    window.openColorModal = openColorModal;
    window.toggleStructural = toggleStructural;

    function deriveVisualizerType(product) {
      if (!product) return 'door';
      const productLines = DataStorage.getProductLines();
      const line = productLines[product.productLineId];
      const code = (product.productTypeCode || '').toUpperCase();
      const name = (product.name || '').toUpperCase();
      const lineName = (line && line.name ? line.name : '').toUpperCase();
      const haystack = `${code} ${name} ${lineName}`;

      const contains = (s) => haystack.includes(s);

      if (contains('DOOR') || code === 'DR' || code.startsWith('DR') || code === 'PD') return 'door';
      if (contains('SLIDER') || code === 'SL' || code.startsWith('SL')) return 'slider';
      if (contains('DOUBLE') || code === 'DH' || code.startsWith('DH')) return 'double';
      if (contains('SINGLE') || code === 'SH' || code.startsWith('SH')) return 'single';
      if (contains('CASE') || contains('CAS') || code === 'CS' || code.startsWith('CA')) return 'casement';
      if (contains('AWNING') || code === 'AW' || code.startsWith('AW')) return 'awning';
      if (contains('PICTURE') || contains('FIX') || contains('FX') || code === 'PW' || code === 'FX') return 'fixed';
      if (contains('BAY') || contains('BOW')) return 'fixed';

      // Default: basic rectangle with no internal markings (just dimensions)
      return 'door';
    }

    // Intercept anchor clicks to present the save modal for in-app navigation
    document.addEventListener('click', (e) => {
      const a = e.target && e.target.closest ? e.target.closest('a') : null;
      if (!a) return;

      // If the anchor already has an inline onclick handler, skip interception to avoid duplicates
      if (a.hasAttribute && a.hasAttribute('onclick')) return;

      const href = a.getAttribute('href');
      if (!href) return;

      // Ignore anchors that are purely hash/navigation within page or explicitly opted-out
      if (href.startsWith('#') || href.startsWith('javascript:') || a.target === '_blank' || (a.dataset && a.dataset.noPrompt === 'true')) return;

      // Intercept navigation and show modal
      e.preventDefault();
      confirmLeaveAdmin(e, href);
    });

    window.newQuote = () => {
      if (currentQuote.lineItems.length > 0) {
        if (!confirm('Start a new quote? Current quote will be lost if not saved.')) return;
      }
      currentQuote = {
        id: `quote_${Date.now()}`,
        customerName: '',
        lineItems: [],
        salesUplift: 0,
        selectedJobAddonIds: [],
        ruleAppliedJobAddonIds: [],
        houseAge: null
      };
      document.getElementById('customer-name').value = '';
      document.getElementById('spouse-name').value = '';
      document.getElementById('customer-address').value = '';
      document.getElementById('customer-phone').value = '';
      document.getElementById('customer-email').value = '';
      document.getElementById('house-age').value = '';
      document.getElementById('job-notes').value = '';
      // Set today's date
      try { document.getElementById('quote-date').value = new Date().toISOString().split('T')[0]; } catch (e) {}
      document.getElementById('sales-uplift').value = '0';
      updateQuoteDisplay();
    };

    window.saveQuote = () => {
      const customerName = document.getElementById('customer-name').value.trim();
      if (!customerName) {
        return showAlert('Please enter customer name');
      }
      if (currentQuote.lineItems.length === 0) {
        return showAlert('Quote must have at least one line item');
      }

      currentQuote.customerName = customerName;
      currentQuote.spouseName = document.getElementById('spouse-name').value.trim();
      currentQuote.address = document.getElementById('customer-address').value.trim();
      currentQuote.phone = document.getElementById('customer-phone').value.trim();
      currentQuote.email = document.getElementById('customer-email').value.trim();
      const houseAgeValue = document.getElementById('house-age').value;
      currentQuote.houseAge = houseAgeValue === '' ? null : parseFloat(houseAgeValue);
      currentQuote.quoteDate = document.getElementById('quote-date').value;
      currentQuote.jobNotes = document.getElementById('job-notes').value.trim();
      currentQuote.salesUplift = parseFloat(document.getElementById('sales-uplift').value) || 0;

      try {
        // Calculate totals with selected job addons
        const allAddons = DataStorage.getAddons();
        const jobBasedAddons = currentQuote.selectedJobAddonIds.map(addonId => {
          const addon = allAddons[addonId];
          if (!addon) return null;
          
          let price = 0;
          if (addon.pricingModel === 'UI') {
            const totalUI = currentQuote.lineItems.reduce((sum, item) => sum + item.ui, 0);
            price = totalUI * addon.uiRate;
          } else {
            price = addon.flatPrice || 0;
          }
          
          return { id: addonId, name: addon.name, price };
        }).filter(a => a !== null);
        
        const quoteCalc = PricingEngine.calculateQuote({
          lineItems: currentQuote.lineItems,
          jobBasedAddons,
          salesUplift: currentQuote.salesUplift
        });

        // Create version
        const version = PricingEngine.createQuoteVersion({
          quoteId: currentQuote.id,
          lineItems: currentQuote.lineItems,
          jobBasedAddons,
          salesUplift: currentQuote.salesUplift,
          metadata: {
            customerName: currentQuote.customerName,
            ...quoteCalc
          }
        });

        // Save quote and version
        DataStorage.saveQuote(currentQuote);
        DataStorage.saveQuoteVersion(version);

        showAlert('Quote saved successfully!', 'success');
      } catch (error) {
        showAlert(error.message);
      }
    };

    window.showSavedQuotes = () => {
      const quotes = DataStorage.get(DataStorage.KEYS.QUOTES, {});
      const quoteList = Object.values(quotes);

      if (quoteList.length === 0) {
        return showAlert('No saved quotes found');
      }

      const html = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.35); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);" onclick="if(event.target === this) this.remove()">
          <div style="background: white; padding: 1.5rem; border-radius: 8px; max-width: 600px; width: 90%; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
            <h2 style="margin-top: 0; font-size: 1rem; font-weight: 600; letter-spacing: -0.01em; color: #18181b;">Load Quote</h2>
            <div class="saved-quotes">
              ${quoteList.map(q => {
                const versions = DataStorage.getQuoteVersions(q.id);
                const latestVersion = versions[versions.length - 1];
                return `
                  <div class="quote-item" onclick="loadQuote('${q.id}')">
                    <div class="quote-item-header">
                      <strong>${q.customerName || 'Unnamed Quote'}</strong>
                      <span>${latestVersion ? `$${latestVersion.finalPrice.toFixed(2)}` : ''}</span>
                    </div>
                    <div class="quote-item-meta">
                      ${q.id} • ${q.lineItems.length} items • ${versions.length} version(s)
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
            <button class="btn-secondary" style="margin-top: 1rem;" onclick="this.closest('div[style*=fixed]').remove()">Close</button>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
    };

    window.loadQuote = (quoteId) => {
      const quotes = DataStorage.get(DataStorage.KEYS.QUOTES, {});
      const quote = quotes[quoteId];
      if (!quote) return;

      currentQuote = JSON.parse(JSON.stringify(quote)); // Deep clone
      
      // Ensure mandatory job addons are included
      const allAddons = DataStorage.getAddons();
      const mandatoryJobAddonIds = Object.entries(allAddons)
        .filter(([id, addon]) => addon.isJobBased && addon.mandatory)
        .map(([id]) => id);
      currentQuote.selectedJobAddonIds = [...new Set([...(currentQuote.selectedJobAddonIds || []), ...mandatoryJobAddonIds])];
      
      document.getElementById('customer-name').value = quote.customerName || '';
      document.getElementById('spouse-name').value = quote.spouseName || '';
      document.getElementById('customer-address').value = quote.address || '';
      document.getElementById('customer-phone').value = quote.phone || '';
      document.getElementById('customer-email').value = quote.email || '';
      document.getElementById('house-age').value = quote.houseAge !== null && quote.houseAge !== undefined ? quote.houseAge : '';
      document.getElementById('quote-date').value = quote.quoteDate || new Date().toISOString().split('T')[0];
      document.getElementById('job-notes').value = quote.jobNotes || '';
      document.getElementById('sales-uplift').value = quote.salesUplift || 0;
      
      updateQuoteDisplay();
      document.querySelector('div[style*=fixed]')?.remove();
    };

    window.renderJobAddons = () => {
      const allAddons = DataStorage.getAddons();
      const jobAddons = Object.entries(allAddons)
        .filter(([id, addon]) => addon.isJobBased)
        .map(([id, addon]) => ({ id, ...addon }));

      // Ensure mandatory job addons are always selected
      const mandatoryJobAddonIds = jobAddons
        .filter(addon => addon.mandatory)
        .map(addon => addon.id);

      const houseAgeValue = parseFloat(document.getElementById('house-age').value);
      const baseSelected = [...new Set([...(currentQuote.selectedJobAddonIds || []), ...mandatoryJobAddonIds])];
      const ruleResult = applyRuleAddons('job', {
        houseAge: isNaN(houseAgeValue) ? null : houseAgeValue,
        selectedAddonIds: baseSelected
      }, baseSelected);

      currentQuote.selectedJobAddonIds = ruleResult.selectedAddonIds;
      currentQuote.ruleAppliedJobAddonIds = ruleResult.ruleAppliedIds;

      if (jobAddons.length === 0) {
        document.getElementById('job-addons-section').innerHTML = '<p style="color: var(--text-secondary); font-size: 13px;">No job addons available</p>';
        return;
      }

      const addonHtml = jobAddons.map(addon => {
        const isSelected = currentQuote.selectedJobAddonIds.includes(addon.id);
        const isChecked = addon.mandatory || isSelected;
        const isRuleApplied = (currentQuote.ruleAppliedJobAddonIds || []).includes(addon.id);
        const price = addon.pricingModel === 'UI' 
          ? '(UI-Based)' 
          : `$${addon.flatPrice.toFixed(2)}`;
        
        return `
          <div class="addon-checkbox">
            <input type="checkbox" id="job-addon-${addon.id}" class="job-addon" value="${addon.id}" ${isChecked ? 'checked' : ''} ${(addon.mandatory || isRuleApplied) ? 'disabled' : ''} onchange="updateJobAddonSelection()">
            <label for="job-addon-${addon.id}" style="margin: 0; flex: 1; font-weight: 500; text-transform: none;">
              ${addon.name} 
              <span style="color: var(--text-secondary); font-size: 12px;">${price}</span>
              ${addon.mandatory ? '<span style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: 600; margin-left: 8px;">MANDATORY</span>' : ''}
              ${(!addon.mandatory && isRuleApplied) ? '<span style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: 600; margin-left: 8px;">RULE</span>' : ''}
            </label>
          </div>
        `;
      }).join('');
      
      document.getElementById('job-addons-section').innerHTML = addonHtml;
    };

    window.updateJobAddonSelection = () => {
      const selectedIds = Array.from(document.querySelectorAll('.job-addon:checked'))
        .map(checkbox => checkbox.value);

      // Always include mandatory addons
      const allAddons = DataStorage.getAddons();
      const mandatoryJobAddonIds = Object.entries(allAddons)
        .filter(([id, addon]) => addon.isJobBased && addon.mandatory)
        .map(([id]) => id);

      const houseAgeValue = parseFloat(document.getElementById('house-age').value);
      const baseSelected = [...new Set([...selectedIds, ...mandatoryJobAddonIds])];
      const ruleResult = applyRuleAddons('job', {
        houseAge: isNaN(houseAgeValue) ? null : houseAgeValue,
        selectedAddonIds: baseSelected
      }, baseSelected);

      currentQuote.selectedJobAddonIds = ruleResult.selectedAddonIds;
      currentQuote.ruleAppliedJobAddonIds = ruleResult.ruleAppliedIds;

      renderJobAddons();
      calculateQuoteTotal();
    };
    window.updateProductLineOptions = () => {
      const productLines = DataStorage.getProductLines();
      
      document.getElementById('product-line').innerHTML = 
        '<option value="">Select product line...</option>' +
        Object.values(productLines).map(pl => `<option value="${pl.id}">${pl.name}</option>`).join('');
      
      updateProductOptions();
    };

    window.updateProductOptions = () => {
      const productLineId = document.getElementById('product-line').value;
      const products = DataStorage.getProducts();
      const filtered = Object.values(products).filter(p => p.productLineId === productLineId);

      document.getElementById('product').innerHTML = 
        '<option value="">Select product...</option>' +
        filtered.map(p => `<option value="${p.id}">${p.productTypeCode} - ${p.name}</option>`).join('');
      
      updateProductInfo();
    };

    function buildAddonCheckboxList({ product, ui, width, height, selectedAddonIds }) {
      const allAddons = DataStorage.getAddons();
      const availableAddonIds = PricingEngine.getAvailableAddonsForProduct(product, ui, allAddons)
        .filter(addonId => !allAddons[addonId].isJobBased);

      const houseAgeValue = parseFloat(document.getElementById('house-age').value);
      const ruleResult = applyRuleAddons('line', {
        houseAge: isNaN(houseAgeValue) ? null : houseAgeValue,
        ui,
        area: width > 0 && height > 0 ? (width * height) / 144 : 0,
        productId: product.id,
        productLineId: product.productLineId,
        selectedAddonIds
      }, selectedAddonIds);

      const finalSelected = ruleResult.selectedAddonIds;
      const ruleAppliedIds = ruleResult.ruleAppliedIds;
      const renderAddonIds = Array.from(new Set([...(availableAddonIds || []), ...(ruleAppliedIds || [])]));

      const addonHtml = renderAddonIds.map(addonId => {
        const addon = allAddons[addonId];
        if (!addon) return '';
        const price = addon.pricingModel === 'UI'
          ? `$${(ui * addon.uiRate).toFixed(2)}`
          : `$${addon.flatPrice.toFixed(2)}`;

        const isChecked = finalSelected.includes(addonId);
        const isRuleApplied = ruleAppliedIds.includes(addonId);

        return `
          <div class="addon-checkbox" data-label="${addon.name.toLowerCase()}">
            <input type="checkbox" id="addon-${addonId}" class="product-addon" value="${addonId}" ${isChecked ? 'checked' : ''} ${isRuleApplied ? 'disabled' : ''}>
            <label for="addon-${addonId}" style="margin: 0; flex: 1; font-weight: 500; text-transform: none;">
              ${addon.name} <span style="color: var(--text-secondary); font-size: 12px;">${price}</span>
              ${isRuleApplied ? '<span style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: 600; margin-left: 8px;">RULE</span>' : ''}
            </label>
          </div>
        `;
      }).join('');

      return {
        availableAddonIds,
        ruleAppliedIds,
        addonHtml
      };
    }

    window.updateProductInfo = () => {
      const productId = document.getElementById('product').value;
      if (!productId) {
        document.getElementById('total-ui').value = '';
        document.getElementById('addons-section').style.display = 'none';
        return;
      }

      const products = DataStorage.getProducts();
      const product = products[productId];

      // Auto-map visualizer type based on product
      const derivedViz = deriveVisualizerType(product);
      if (derivedViz && derivedViz !== vizWindowType) {
        vizWindowType = derivedViz;
        renderVisualizer();
      }
      
      // Calculate total UI from width + height
      const width = parseFloat(document.getElementById('width').value) || 0;
      const height = parseFloat(document.getElementById('height').value) || 0;
      const ui = Math.ceil(width + height);
      
      document.getElementById('total-ui').value = ui || '';
      
      const listResult = buildAddonCheckboxList({
        product,
        ui,
        width,
        height,
        selectedAddonIds: []
      });

      if ((listResult.availableAddonIds || []).length === 0 && (listResult.ruleAppliedIds || []).length === 0) {
        document.getElementById('addons-section').style.display = 'none';
        return;
      }
      
      document.getElementById('addons-list').innerHTML = listResult.addonHtml;
      document.getElementById('addons-section').style.display = 'block';

      // Attach change listeners so selected addons render under notes
      setTimeout(() => {
        document.querySelectorAll('.product-addon').forEach(cb => {
          cb.removeEventListener('change', handleAddonSelectionChange);
          cb.addEventListener('change', handleAddonSelectionChange);
        });
        renderSelectedAddons();
      }, 0);
    };

    // Update UI and addon prices without clearing selections (for size changes)
    window.updateUIOnly = () => {
      const productId = document.getElementById('product').value;
      if (!productId) {
        document.getElementById('total-ui').value = '';
        return;
      }

      const products = DataStorage.getProducts();
      const product = products[productId];
      
      // Calculate total UI from width + height
      const width = parseFloat(document.getElementById('width').value) || 0;
      const height = parseFloat(document.getElementById('height').value) || 0;
      const ui = Math.ceil(width + height);
      
      document.getElementById('total-ui').value = ui || '';
      
      // Save currently selected addon IDs
      const selectedAddonIds = Array.from(document.querySelectorAll('.product-addon:checked'))
        .map(cb => cb.value);

      const listResult = buildAddonCheckboxList({
        product,
        ui,
        width,
        height,
        selectedAddonIds
      });

      document.getElementById('addons-list').innerHTML = listResult.addonHtml;
      
      // Re-attach change listeners
      setTimeout(() => {
        document.querySelectorAll('.product-addon').forEach(cb => {
          cb.removeEventListener('change', handleAddonSelectionChange);
          cb.addEventListener('change', handleAddonSelectionChange);
        });
        renderSelectedAddons();
      }, 0);
    };

    window.handleAddonSelectionChange = () => {
      updateUIOnly();
    };

    window.addLineItem = () => {
      const roomLabel = document.getElementById('room-label').value.trim();
      const productId = document.getElementById('product').value;
      const frameColor = document.getElementById('frame-color') ? document.getElementById('frame-color').value : 'white';
      const width = parseFloat(document.getElementById('width').value);
      const height = parseFloat(document.getElementById('height').value);
      const mullType = document.getElementById('mull-type').value;
      const hingeSide = document.getElementById('hinge-side') ? document.getElementById('hinge-side').value : '';
      const swingType = document.getElementById('swing-type') ? document.getElementById('swing-type').value : '';

      if (!roomLabel || !productId || !width || !height) {
        return showAlert('Please fill all required fields');
      }

      const products = DataStorage.getProducts();
      const product = products[productId];
      const globalSettings = DataStorage.getGlobalSettings();
      const allAddons = DataStorage.getAddons();

      // Get selected addons
      const selectedAddonIds = Array.from(document.querySelectorAll('.product-addon:checked'))
        .map(checkbox => checkbox.value);

      const houseAgeValue = parseFloat(document.getElementById('house-age').value);

      try {
        // Calculate UI
        const ui = Math.ceil(width + height);
        
        // Validate against global minimum UI
        if (ui < globalSettings.minimumUI) {
          return showAlert(`Total UI (${ui}) must be at least ${globalSettings.minimumUI} inches`);
        }

        // Validate size limits if product has them
        const validation = PricingEngine.validateSize({ product, width, height });
        if (!validation.valid) {
          return showAlert(validation.errors.join(', '));
        }

        const ruleResult = applyRuleAddons('line', {
          houseAge: isNaN(houseAgeValue) ? null : houseAgeValue,
          ui,
          area: width > 0 && height > 0 ? (width * height) / 144 : 0,
          productId,
          productLineId: product.productLineId,
          selectedAddonIds
        }, selectedAddonIds);

        const finalSelectedAddonIds = ruleResult.selectedAddonIds;

        // Calculate line item with selected addons
        const lineItemCalc = PricingEngine.calculateLineItem({
          product,
          width,
          height,
          selectedAddonIds: finalSelectedAddonIds,
          allAddons
        });

        // Determine the correct visualizer type for this product
        const itemVizType = deriveVisualizerType(product);
        
        // Check if special addons modify the visualizer type (oriel, eyebrow)
        let finalVizType = itemVizType;
        if (itemVizType === 'single' || itemVizType === 'double') {
          for (const addonId of finalSelectedAddonIds) {
            const addon = allAddons[addonId];
            if (!addon) continue;
            const addonNameLower = addon.name.toLowerCase();
            if (addonNameLower.includes('eyebrow') && addonNameLower.includes('leg')) {
              finalVizType = 'eyebrow-legs';
              break;
            } else if (addonNameLower.includes('eyebrow')) {
              finalVizType = 'eyebrow';
              break;
            } else if (addonNameLower.includes('oriel')) {
              finalVizType = 'oriel';
              break;
            }
          }
        }

        // Capture a downsized visualizer snapshot for the line item
        let vizDataUrl = '';
        if (width > 0 && height > 0) {
          const vizSvg = buildVisualizerSvgString(width, height, finalVizType, 160);
          vizDataUrl = svgToDataUrl(vizSvg);
        }

        // Add to quote
        currentQuote.lineItems.push({
          id: `item_${Date.now()}`,
          productId,
          roomLabel,
          width,
          height,
          ui,
          mullType,
          frameColor,
          hingeSide,
          swingType,
          vizType: finalVizType,
          vizDataUrl,
          ...lineItemCalc
        });

        // Reset form
        document.getElementById('room-label').value = '';
        document.getElementById('product-line').value = '';
        document.getElementById('product').value = '';
        document.getElementById('width').value = '';
        document.getElementById('height').value = '';
        document.getElementById('total-ui').value = '';
        document.getElementById('mull-type').value = '';
        if (document.getElementById('hinge-side')) document.getElementById('hinge-side').value = '';
        if (document.getElementById('swing-type')) document.getElementById('swing-type').value = '';
        if (document.getElementById('frame-color')) { document.getElementById('frame-color').value = 'white'; updateColorPreview(); }
        document.getElementById('extra-notes').value = '';
        // Keep notes visible by design
        try { renderSelectedAddons(); } catch (e) {}
        const structuralSection = document.getElementById('structural-section');
        if (structuralSection) structuralSection.style.display = 'none';
        const structuralToggle = document.getElementById('structural-toggle');
        if (structuralToggle) structuralToggle.textContent = '⧉ Structural';
        document.getElementById('addons-list').innerHTML = '';
        document.getElementById('addons-section').style.display = 'none';

        updateQuoteDisplay();
      } catch (error) {
        showAlert(error.message);
      }
    };

    window.removeLineItem = (index) => {
      currentQuote.lineItems.splice(index, 1);
      updateQuoteDisplay();
    };

    window.showAlert = (message, type = 'error') => {
      let alertsEnabled = true;
      try {
        const settings = DataStorage.getGlobalSettings();
        alertsEnabled = settings && settings.alertsEnabled !== false;
      } catch (e) {}
      showAlertShared(message, type, { enabled: alertsEnabled });
    };
    window.showModal = showModal;
    window.calculateQuoteTotal = () => {
      updateQuoteDisplay();
    };

    function updateQuoteDisplay() {
      document.getElementById('quote-id').value = currentQuote.id;

      // Render job addons section
      renderJobAddons();

      // Render line items table
      if (currentQuote.lineItems.length === 0) {
        document.getElementById('line-items-table').innerHTML = '<p>No items added yet.</p>';
      } else {
        const products = DataStorage.getProducts();

        const html = `
          <table>
            <thead>
              <tr>
                <th style="width:48px;">#</th>
                <th>Room / Product</th>
                <th>Size</th>
                <th>UI</th>
                <th>Preview</th>
                <th style="text-align:right;">Price</th>
                <th style="width:80px;"></th>
              </tr>
            </thead>
            <tbody>
              ${currentQuote.lineItems.map((item, index) => {
                const product = products[item.productId];
                const productName = product ? product.name : 'Unknown';
                const productCode = product ? product.productTypeCode : 'N/A';

                const mullLabel = {
                  'left': 'Left',
                  'right': 'Right',
                  'center': 'Center',
                  'above': 'Above',
                  'below': 'Below'
                };
                const mullText = item.mullType ? (mullLabel[item.mullType] || item.mullType) : 'None';
                const hingeText = item.hingeSide ? (item.hingeSide.charAt(0).toUpperCase() + item.hingeSide.slice(1)) : 'N/A';
                const swingText = item.swingType ? (item.swingType === 'inswing' ? 'Inswing' : item.swingType === 'outswing' ? 'Outswing' : item.swingType) : 'N/A';
                const colorText = item.frameColor ? (item.frameColor.charAt(0).toUpperCase()+item.frameColor.slice(1)) : 'White';
                const colorHex = (function(){ const map={white:'#ffffff',tan:'#d6c3a6',adobe:'#c58b68',black:'#222222'}; return map[item.frameColor]||item.frameColor||'#ffffff'; })();

                const visibleAddons = item.appliedAddons.filter(a => !a.hidden);
                const addonsText = visibleAddons.length > 0
                  ? visibleAddons.map(a => a.name).join(', ')
                  : 'None';

                let previewImg = '<span style="color: #9ca3af; font-size: 11px;">No preview</span>';
                if (item.vizDataUrl) {
                  previewImg = `<img src="${item.vizDataUrl}" alt="Preview" style="width: 80px; height: auto; display: block; border: 1px solid rgba(0,0,0,0.08); border-radius: 4px; background: #fafafa;">`;
                } else if (item.width > 0 && item.height > 0 && item.vizType) {
                  const miniSvg = buildVisualizerSvgString(item.width, item.height, item.vizType, 80);
                  previewImg = `<div style="width: 80px; height: auto; border: 1px solid rgba(0,0,0,0.08); border-radius: 4px; background: #fafafa;">${miniSvg}</div>`;
                }

                return `
                  <tr>
                    <td>${index + 1}</td>
                    <td>
                      <div style="font-weight:600;">${item.roomLabel}</div>
                      <div style="font-size:12px; color:var(--text-secondary);">${productCode} - ${productName}</div>
                    </td>
                    <td style="font-size:13px;">${item.width}" × ${item.height}"</td>
                    <td>${item.ui}</td>
                    <td>${previewImg}</td>
                    <td style="text-align:right; font-weight:600;">$${item.lineItemParTotal.toFixed(2)}</td>
                    <td>
                      <div style="display:flex; gap:6px; justify-content:center;">
                        <button class="btn-secondary" style="padding:6px 8px; font-size:12px; line-height:1;" onclick="toggleLineItemDetails(${index})" title="Toggle Details">ᐯ</button>
                        <button class="btn-danger" style="padding:6px 8px; font-size:14px; line-height:1;" onclick="removeLineItem(${index})" title="Remove">×</button>
                      </div>
                    </td>
                  </tr>
                  <tr id="details-${index}" style="display:none;">
                    <td colspan="7" style="background:#fafafa; padding:12px 16px;">
                      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px; font-size:13px;">
                        <div>
                          <div style="font-weight:600; color:var(--text-secondary); text-transform:uppercase; font-size:11px; margin-bottom:4px;">Frame Color</div>
                          <div style="display:flex; align-items:center; gap:6px;">
                            <span class="color-swatch" style="background:${colorHex}; width:16px; height:16px;"></span>
                            ${colorText}
                          </div>
                        </div>
                        <div>
                          <div style="font-weight:600; color:var(--text-secondary); text-transform:uppercase; font-size:11px; margin-bottom:4px;">Mulling</div>
                          <div>${mullText}</div>
                        </div>
                        <div>
                          <div style="font-weight:600; color:var(--text-secondary); text-transform:uppercase; font-size:11px; margin-bottom:4px;">Hinge Side</div>
                          <div>${hingeText}</div>
                        </div>
                        <div>
                          <div style="font-weight:600; color:var(--text-secondary); text-transform:uppercase; font-size:11px; margin-bottom:4px;">Swing</div>
                          <div>${swingText}</div>
                        </div>
                        <div style="grid-column: 1 / -1;">
                          <div style="font-weight:600; color:var(--text-secondary); text-transform:uppercase; font-size:11px; margin-bottom:4px;">Add-ons</div>
                          <div>${addonsText}</div>
                        </div>
                        ${item.extraNotes ? `
                        <div style="grid-column: 1 / -1;">
                          <div style="font-weight:600; color:var(--text-secondary); text-transform:uppercase; font-size:11px; margin-bottom:4px;">Notes</div>
                          <div style="white-space:pre-wrap;">${item.extraNotes}</div>
                        </div>
                        ` : ''}
                      </div>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
        document.getElementById('line-items-table').innerHTML = html;
      }

      // Calculate total with job addons (always, even with no line items)
      try {
        const salesUplift = parseFloat(document.getElementById('sales-uplift').value) || 0;
        const allAddons = DataStorage.getAddons();

        const jobBasedAddons = currentQuote.selectedJobAddonIds.map(addonId => {
          const addon = allAddons[addonId];
          if (!addon) return null;

          let price = 0;
          if (addon.pricingModel === 'UI') {
            const totalUI = currentQuote.lineItems.reduce((sum, item) => sum + item.ui, 0);
            price = totalUI * addon.uiRate;
          } else {
            price = addon.flatPrice || 0;
          }

          return { id: addonId, name: addon.name, price };
        }).filter(a => a !== null);

        const quoteCalc = PricingEngine.calculateQuote({
          lineItems: currentQuote.lineItems,
          jobBasedAddons,
          salesUplift
        });
        document.getElementById('final-price').textContent = `$${quoteCalc.finalPrice.toFixed(2)}`;
      } catch (error) {
        showAlert(error.message);
      }
    }

    window.generateQuoteDocument = () => {
      const customerName = document.getElementById('customer-name').value.trim();
      if (!customerName) {
        return showAlert('Please enter customer name');
      }

      // Ensure currentQuote captures latest contact/job fields even if not saved
      try {
        currentQuote.spouseName = document.getElementById('spouse-name').value.trim();
        currentQuote.address = document.getElementById('customer-address').value.trim();
        currentQuote.phone = document.getElementById('customer-phone').value.trim();
        currentQuote.email = document.getElementById('customer-email').value.trim();
        const houseAgeValue = document.getElementById('house-age').value;
        currentQuote.houseAge = houseAgeValue === '' ? null : parseFloat(houseAgeValue);
        currentQuote.quoteDate = document.getElementById('quote-date').value;
        currentQuote.jobNotes = document.getElementById('job-notes').value.trim();
      } catch (e) {}

      try {
        const salesUplift = parseFloat(document.getElementById('sales-uplift').value) || 0;
        const allAddons = DataStorage.getAddons();
        
        const jobBasedAddons = currentQuote.selectedJobAddonIds.map(addonId => {
          const addon = allAddons[addonId];
          if (!addon) return null;
          
          let price = 0;
          if (addon.pricingModel === 'UI') {
            const totalUI = currentQuote.lineItems.reduce((sum, item) => sum + item.ui, 0);
            price = totalUI * addon.uiRate;
          } else {
            price = addon.flatPrice || 0;
          }
          
          return { id: addonId, name: addon.name, price };
        }).filter(a => a !== null);
        
        const quoteCalc = PricingEngine.calculateQuote({
          lineItems: currentQuote.lineItems,
          jobBasedAddons,
          salesUplift
        });

        // Generate simple text quote
        let doc = `QUOTE: ${currentQuote.id}\n`;
        doc += `Customer: ${customerName}\n`;
        if (currentQuote.spouseName) doc += `Co-Owner: ${currentQuote.spouseName}\n`;
        doc += `Date: ${currentQuote.quoteDate || new Date().toLocaleDateString()}\n`;
        if (currentQuote.address) doc += `Address: ${currentQuote.address}\n`;
        if (currentQuote.phone) doc += `Phone: ${currentQuote.phone}\n`;
        if (currentQuote.email) doc += `Email: ${currentQuote.email}\n`;
        if (currentQuote.houseAge !== null && currentQuote.houseAge !== undefined && !isNaN(currentQuote.houseAge)) {
          doc += `House Age: ${currentQuote.houseAge} years\n`;
        }
        if (currentQuote.jobNotes) doc += `Job Notes: ${currentQuote.jobNotes}\n`;
        doc += `\n`;
        doc += `LINE ITEMS:\n`;
        doc += `${'='.repeat(80)}\n`;

        const products = DataStorage.getProducts();
        currentQuote.lineItems.forEach((item, index) => {
          const product = products[item.productId];
          const productName = product ? product.name : 'Unknown';
          const productCode = product ? product.productTypeCode : 'N/A';
          
          doc += `${index + 1}. [${item.roomLabel}] ${productCode} - ${productName}\n`;
          doc += `   Size: ${item.width}" × ${item.height}" (${item.ui} UI)\n`;
            if (item.frameColor) {
              doc += `   Color: ${item.frameColor.charAt(0).toUpperCase() + item.frameColor.slice(1)}\n`;
            }
          
          if (item.mullType) {
            const mullLabel = {
              'left': 'Left',
              'right': 'Right',
              'center': 'Center',
              'above': 'Above',
              'below': 'Below'
            };
            doc += `   Mulling: ${mullLabel[item.mullType] || item.mullType}\n`;
          }
          if (item.hingeSide) {
            doc += `   Hinge Side: ${item.hingeSide.charAt(0).toUpperCase() + item.hingeSide.slice(1)}\n`;
          }
          if (item.swingType) {
            doc += `   Swing: ${item.swingType === 'inswing' ? 'Inswing' : item.swingType === 'outswing' ? 'Outswing' : item.swingType}\n`;
          }
          
          const visibleAddons = item.appliedAddons.filter(a => !a.hidden);
          if (visibleAddons.length > 0) {
            doc += `   Options: ${visibleAddons.map(a => a.name).join(', ')}\n`;
          }
          doc += `   Price: $${item.lineItemParTotal.toFixed(2)}\n\n`;
        });

        if (jobBasedAddons.length > 0) {
          doc += `${'='.repeat(80)}\n`;
          doc += `JOB ADDONS:\n`;
          jobBasedAddons.forEach(addon => {
            doc += `  - ${addon.name}: $${addon.price.toFixed(2)}\n`;
          });
        }

        doc += `${'='.repeat(60)}\n`;
        doc += `TOTAL: $${quoteCalc.finalPrice.toFixed(2)}\n`;

        // Download as text file
        const blob = new Blob([doc], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `quote-${currentQuote.id}.txt`;
        a.click();
      } catch (error) {
        showAlert(error.message);
      }
    };

    window.toggleLineItemDetails = (index) => {
      const row = document.getElementById(`details-${index}`);
      if (!row) return;
      row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
    };

    // Initialize
    function init() {
      // Debug: Check what data we have
      const productLines = DataStorage.getProductLines();
      const products = DataStorage.getProducts();
      console.log('Product Lines:', productLines);
      console.log('Products:', products);

      // Initialize mandatory job addons
      const allAddons = DataStorage.getAddons();
      const mandatoryJobAddonIds = Object.entries(allAddons)
        .filter(([id, addon]) => addon.isJobBased && addon.mandatory)
        .map(([id]) => id);
      currentQuote.selectedJobAddonIds = [...new Set([...currentQuote.selectedJobAddonIds, ...mandatoryJobAddonIds])];

      // Populate product lines
      updateProductLineOptions();
      
      // Add event listeners to width/height to update UI
      const widthField = document.getElementById('width');
      const heightField = document.getElementById('height');
      widthField.addEventListener('input', () => { updateUIOnly(); syncVisualizerFromInputs(); });
      heightField.addEventListener('input', () => { updateUIOnly(); syncVisualizerFromInputs(); });

      const houseAgeField = document.getElementById('house-age');
      if (houseAgeField) {
        houseAgeField.addEventListener('input', () => {
          updateUIOnly();
          renderJobAddons();
        });
      }

      // Initialize visualizer with empty state
      renderVisualizer();

      // Ensure quote date defaults to today if not set
      try {
        const qd = document.getElementById('quote-date');
        if (qd && !qd.value) qd.value = new Date().toISOString().split('T')[0];
      } catch (e) {}

      // Initialize frame color picker
      try {
        const fc = document.getElementById('frame-color');
        if (fc) {
          if (!fc.value) fc.value = 'white';
          fc.addEventListener('change', updateColorPreview);
          updateColorPreview();
        }
      } catch (e) {}

      renderVisualizer();
      
      updateQuoteDisplay();

      // Clean up any leftover modal overlays (can persist when navigating back via bfcache)
      try {
        document.querySelectorAll('[id^="modal-"]').forEach(m => m.remove());
      } catch (err) {
        console.warn('Modal cleanup failed', err);
      }

      // Refresh product data when page becomes visible (returns from admin panel)
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          updateProductLineOptions();
          // Remove any stray modal overlays that might block input when returning
          document.querySelectorAll('[id^="modal-"]').forEach(m => m.remove());
        }
      });

      // pageshow can fire when returning from bfcache; ensure overlays are removed
      window.addEventListener('pageshow', () => {
        document.querySelectorAll('[id^="modal-"]').forEach(m => m.remove());
      });
    }

    init();
  </script>
</body>
</html>
