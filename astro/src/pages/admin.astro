---
import TabSection from '../components/TabSection.astro';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Krasiva Windows & Doors - Admin Control Panel</title>
  <link rel="stylesheet" href="/styles/shared.css">
</head>
<body class="admin-page">
  <a class="page-toggle" href="/" aria-label="Go to Sales page">Sales</a>
  <div class="container">
    <div id="alerts"></div>

    <div class="tabs">
      <button class="tab active" data-tab="manufacturers">Manufacturers</button>
      <button class="tab" data-tab="productLines">Product Lines</button>
      <button class="tab" data-tab="products">Products</button>
      <button class="tab" data-tab="addons">Addons</button>
      <button class="tab" data-tab="versions">Version History</button>
      <button class="tab" data-tab="settings">Settings</button>
      <button class="tab tab-publish" onclick="publishVersion()">Publish</button>
    </div>

    <TabSection id="manufacturers" title="Manufacturers" active>
      <div class="form-row">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="mfg-name" placeholder="e.g., Andersen Windows">
        </div>
      </div>
      <div class="form-actions">
        <button class="btn-primary" onclick="addManufacturer()">+ Add Manufacturer</button>
      </div>
      <div id="mfg-table"></div>
    </TabSection>

    <TabSection id="productLines" title="Product Lines">
      <div class="form-row">
        <div class="form-group">
          <label>Manufacturer</label>
          <select id="pl-manufacturer"></select>
        </div>
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="pl-name" placeholder="e.g., 400 Series">
        </div>
      </div>
      <div class="form-actions">
        <button class="btn-primary" onclick="addProductLine()">+ Add Product Line</button>
      </div>
      <div id="pl-table"></div>
    </TabSection>

    <TabSection id="products" title="Products">
      <div class="form-row">
        <div class="form-group">
          <label>Product Type</label>
          <select id="prod-type">
            <option value="Window">Window</option>
            <option value="Door">Door</option>
            <option value="Sliding Door">Sliding Door</option>
            <option value="Bifold Door">Bifold Door</option>
            <option value="Sidelite">Sidelite</option>
            <option value="French Door">French Door</option>
          </select>
        </div>
        <div class="form-group">
          <label>Product Line</label>
          <select id="prod-line"></select>
        </div>
        <div class="form-group">
          <label>Type Code</label>
          <input type="text" id="prod-code" placeholder="e.g., SH, DH">
        </div>
        <div class="form-group full-span">
          <label>Name</label>
          <input type="text" id="prod-name" placeholder="e.g., Single Hung">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Pricing Model</label>
          <select id="prod-model" onchange="togglePricingFields()">
            <option value="UI">UI-Based</option>
            <option value="FLAT">Flat Price</option>
          </select>
        </div>
        <div class="form-group" id="prod-ui-rate-group">
          <label>UI Rate ($)</label>
          <input type="number" id="prod-ui-rate" step="0.01" placeholder="12.50">
        </div>
        <div class="form-group" id="prod-flat-price-group" style="display:none;">
          <label>Flat Price ($)</label>
          <input type="number" id="prod-flat-price" step="0.01" placeholder="2500">
        </div>
        <div class="form-group">
          <label>Minimum UI</label>
          <input type="number" id="prod-min-ui" placeholder="100">
        </div>
        <div class="form-group">
          <label>Maximum UI (blank = unlimited)</label>
          <input type="number" id="prod-max-ui" placeholder="500">
        </div>
      </div>
      <div class="form-actions">
        <button class="btn-primary" onclick="addProduct()">+ Add Product</button>
      </div>
      <div id="prod-table"></div>
    </TabSection>

    <TabSection id="addons" title="Addons">
      <div class="form-row">
        <div class="form-group full-span">
          <label>Name</label>
          <input type="text" id="addon-name" placeholder="e.g., Colonial Grids">
        </div>
        <div class="form-group full-span">
          <label>Exclusive Group (optional)</label>
          <input type="text" id="addon-exclusive" placeholder="e.g., glass_type">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Pricing Model</label>
          <select id="addon-model" onchange="toggleAddonPricingFields()">
            <option value="UI">UI-Based</option>
            <option value="FLAT">Flat Price</option>
          </select>
        </div>
        <div class="form-group" id="addon-ui-rate-group">
          <label>UI Rate ($)</label>
          <input type="number" id="addon-ui-rate" step="0.01" placeholder="2.00">
        </div>
        <div class="form-group" id="addon-flat-price-group" style="display:none;">
          <label>Flat Price ($)</label>
          <input type="number" id="addon-flat-price" step="0.01" placeholder="350">
        </div>
      </div>
      <div class="checkbox-section">
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="addon-mandatory">
            Mandatory
          </label>
        </div>
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="addon-hidden">
            Hidden from Customer
          </label>
        </div>
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="addon-job-based">
            Job Based (Global - apply to all quotes)
          </label>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Allowed Product Types (leave blank for all)</label>
          <input type="text" id="addon-product-types" placeholder="e.g., Window, Door (comma-separated)">
        </div>
        <div class="form-group">
          <label>Allowed Product Lines (leave blank for all)</label>
          <input type="text" id="addon-product-lines" placeholder="e.g., Premium, Standard (comma-separated)">
        </div>
        <div class="form-group">
          <label>Max Size (sq ft, leave blank for unlimited)</label>
          <input type="number" id="addon-max-size" step="0.01" placeholder="21">
        </div>
        <div class="form-group">
          <label>Min Size (sq ft, leave blank for no minimum)</label>
          <input type="number" id="addon-min-size" step="0.01" placeholder="0">
        </div>
      </div>
      <div class="form-actions">
        <button class="btn-primary" onclick="addAddon()">+ Add Addon</button>
      </div>
      <div id="addon-table"></div>
    </TabSection>

    <TabSection id="versions" title="Pricing Version History" description="Manage and export previous pricing configurations.">
      <div style="display: flex; gap: 8px; margin-bottom: 1.5rem;">
        <button class="btn-secondary" onclick="exportVersionData()">Export Version</button>
        <button class="btn-secondary" onclick="importVersionData()">Import Version</button>
      </div>
      <div class="version-history" id="version-list"></div>
    </TabSection>

    <TabSection id="settings" title="Global Settings" description="Configure global rules that apply to all quotes.">
      <div class="form-row">
        <div class="form-group">
          <label>Minimum Window UI (inches)</label>
          <input type="number" id="setting-minimum-ui" min="0" step="1" placeholder="65">
          <small>All windows must have at least this many united inches (width + height)</small>
        </div>
      </div>
      <div class="checkbox-section">
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="setting-alerts-enabled">
            Enable Success Alerts
          </label>
          <small>Show notification messages when actions are completed</small>
        </div>
      </div>
      <div class="rules-panel">
        <div style="display:flex; align-items:center; justify-content: space-between; gap: 8px;">
          <div>
            <h3 style="margin: 0; font-size: 0.95rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;">Rules</h3>
            <div style="font-size: 12px; color: var(--text-secondary);">Use conditions to auto-apply mandatory addons</div>
          </div>
          <button class="btn-secondary" type="button" onclick="addRule()">+ Add Rule</button>
        </div>
        <div id="rules-list" style="margin-top: 12px;"></div>
      </div>
      <div class="form-actions">
        <button class="btn-primary" onclick="saveGlobalSettings()">Save Settings</button>
      </div>
      <div id="settings-status"></div>
    </TabSection>
  </div>

  <input type="file" id="version-import-file" accept=".json,.csv" style="display:none;" onchange="handleVersionImport()">

  <script type="module">
    import { PricingEngine } from '/pricing_engine.js';
    import { DataStorage } from '/data_storage.js';
    import { showAlert as showAlertShared, showModal } from '/shared/ui_helpers.js';
    import { FIELD_SCHEMAS, buildFieldHtml } from '/shared/admin_schemas.js';
    import { exportAsJSON, exportAsCSV, importFromJSON, importFromCSV } from '/shared/version_utils.js';

    // Initialize
    DataStorage.initializeSampleData();
    window.storage = DataStorage;
    window.engine = PricingEngine;

    // ============================================================================
    // GLOBAL UI
    // ============================================================================

    window.showAlert = (message, type = 'success') => {
      const settings = DataStorage.getGlobalSettings();
      const alertsEnabled = settings && settings.alertsEnabled !== false;
      showAlertShared(message, type, { enabled: alertsEnabled });
    };
    window.showModal = showModal;

    const activateTab = (tabName) => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      const tabButton = document.querySelector(`.tab[data-tab="${tabName}"]`);
      if (tabButton) tabButton.classList.add('active');
      const section = document.getElementById(tabName);
      if (section) section.classList.add('active');
      renderAll();
    };

    document.addEventListener('click', (evt) => {
      const tabButton = evt.target?.closest('.tab[data-tab]');
      if (!tabButton) return;
      const tabName = tabButton.getAttribute('data-tab');
      if (tabName) activateTab(tabName);
    });

    // ============================================================================
    // PRICING TOGGLE
    // ============================================================================

    const togglePricingGroup = (modelId, uiGroupId, flatGroupId) => {
      const modelEl = document.getElementById(modelId);
      const uiGroup = document.getElementById(uiGroupId);
      const flatGroup = document.getElementById(flatGroupId);
      if (!modelEl || !uiGroup || !flatGroup) return;
      const model = modelEl.value;
      uiGroup.style.display = model === 'UI' ? '' : 'none';
      flatGroup.style.display = model === 'FLAT' ? '' : 'none';
    };

    window.togglePricingFields = () => togglePricingGroup('prod-model', 'prod-ui-rate-group', 'prod-flat-price-group');
    window.toggleAddonPricingFields = () => togglePricingGroup('addon-model', 'addon-ui-rate-group', 'addon-flat-price-group');
    window.toggleEditPricingFields = () => togglePricingGroup('edit-prod-model', 'edit-prod-rate-group', 'edit-prod-price-group');
    window.toggleEditAddonPricingFields = () => togglePricingGroup('edit-addon-model', 'edit-addon-rate-group', 'edit-addon-price-group');

    // ============================================================================
    // EDIT MODAL (UNIFIED)
    // ============================================================================

    window.openEditModal = (type, id) => {
      const items = DataStorage.get(type === 'mfg' ? DataStorage.KEYS.MANUFACTURERS : 
                                     type === 'line' ? DataStorage.KEYS.PRODUCT_LINES : 
                                     type === 'prod' ? DataStorage.KEYS.PRODUCTS :
                                     DataStorage.KEYS.ADDONS);
      const item = items[id];
      if (!item) return;

      const schema = FIELD_SCHEMAS[type];
      if (!schema) return;

      const context = {};
      if (type === 'prod') {
        const lines = DataStorage.getProductLines();
        context.productLineName = lines[item.productLineId]?.name || 'N/A';
      }

      const fieldsHtml = schema.fields.map(f => buildFieldHtml(f, item, context)).join('');

      const html = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.35); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);" id="edit-modal" onclick="if(event.target.id === 'edit-modal') this.remove()">
          <div style="background: white; padding: 1.5rem; border-radius: 8px; max-width: 500px; width: 90%; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
            <h2>${schema.title}</h2>
            ${fieldsHtml}
            <div style="display: flex; gap: 8px; margin-top: 1.5rem;">
              <button class="btn-primary" onclick="saveEditedItem('${type}', '${id}')">Save</button>
              <button class="btn-secondary" onclick="document.getElementById('edit-modal').remove()">Cancel</button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', html);
    };

    window.saveEditedItem = (type, id) => {
      if (type === 'mfg') {
        const name = document.getElementById('edit-mfg-name').value.trim();
        if (!name) return showAlert('Please enter a name', 'error');
        const manufacturers = DataStorage.getManufacturers();
        manufacturers[id].name = name;
        DataStorage.set(DataStorage.KEYS.MANUFACTURERS, manufacturers);
      } else if (type === 'line') {
        const name = document.getElementById('edit-line-name').value.trim();
        if (!name) return showAlert('Please enter a name', 'error');
        const lines = DataStorage.getProductLines();
        lines[id].name = name;
        DataStorage.set(DataStorage.KEYS.PRODUCT_LINES, lines);
      } else if (type === 'prod') {
        const name = document.getElementById('edit-prod-name').value.trim();
        const code = document.getElementById('edit-prod-code').value.trim();
        const model = document.getElementById('edit-prod-model').value;
        if (!name || !code) return showAlert('Please fill all required fields', 'error');
        const products = DataStorage.getProducts();
        products[id].name = name;
        products[id].productTypeCode = code;
        products[id].pricingModel = model;
        products[id].minimumUI = parseInt(document.getElementById('edit-prod-min-ui').value) || 0;
        products[id].maximumUI = parseInt(document.getElementById('edit-prod-max-ui').value) || null;
        if (model === 'UI') {
          products[id].uiRate = parseFloat(document.getElementById('edit-prod-ui-rate').value) || 0;
          delete products[id].flatPrice;
        } else {
          products[id].flatPrice = parseFloat(document.getElementById('edit-prod-flat-price').value) || 0;
          delete products[id].uiRate;
        }
        DataStorage.set(DataStorage.KEYS.PRODUCTS, products);
      } else if (type === 'addon') {
        const name = document.getElementById('edit-addon-name').value.trim();
        const model = document.getElementById('edit-addon-model').value;
        if (!name) return showAlert('Please enter a name', 'error');
        const addons = DataStorage.getAddons();
        addons[id].name = name;
        addons[id].pricingModel = model;
        addons[id].exclusiveGroup = document.getElementById('edit-addon-exclusive').value.trim() || null;
        addons[id].mandatory = document.getElementById('edit-addon-mandatory').checked;
        addons[id].hiddenFromCustomer = document.getElementById('edit-addon-hidden').checked;
        addons[id].isJobBased = document.getElementById('edit-addon-job-based').checked;
        
        const productTypesStr = document.getElementById('edit-addon-product-types').value.trim();
        addons[id].allowedProductTypes = productTypesStr 
          ? productTypesStr.split(',').map(t => t.trim()).filter(t => t)
          : null;
        
        const productLinesStr = document.getElementById('edit-addon-product-lines').value.trim();
        addons[id].allowedProductLines = productLinesStr
          ? productLinesStr.split(',').map(l => l.trim()).filter(l => l)
          : null;
        
        addons[id].maxSize = document.getElementById('edit-addon-max-size').value
          ? parseFloat(document.getElementById('edit-addon-max-size').value)
          : null;
        
        addons[id].minSize = document.getElementById('edit-addon-min-size').value
          ? parseFloat(document.getElementById('edit-addon-min-size').value)
          : null;
        
        if (model === 'UI') {
          addons[id].uiRate = parseFloat(document.getElementById('edit-addon-ui-rate').value) || 0;
          delete addons[id].flatPrice;
        } else {
          addons[id].flatPrice = parseFloat(document.getElementById('edit-addon-flat-price').value) || 0;
          delete addons[id].uiRate;
        }
        DataStorage.set(DataStorage.KEYS.ADDONS, addons);
      }
      document.getElementById('edit-modal').remove();
      renderAll();
      showAlert('Item updated successfully');
    };

    // ============================================================================
    // CRUD OPERATIONS
    // ============================================================================

    const slugify = (text) => text.toLowerCase().trim()
      .replace(/[^\w\s-]/g, '').replace(/\s+/g, '_').replace(/_+/g, '_').substring(0, 20);

    window.addManufacturer = () => {
      const name = document.getElementById('mfg-name').value.trim();
      if (!name) return showAlert('Please enter a name', 'error');
      const manufacturers = DataStorage.getManufacturers();
      const id = `mfg_${slugify(name)}`;
      manufacturers[id] = { id, name };
      DataStorage.set(DataStorage.KEYS.MANUFACTURERS, manufacturers);
      document.getElementById('mfg-name').value = '';
      renderAll();
      showAlert('Manufacturer added');
    };

    window.addProductLine = () => {
      const manufacturerId = document.getElementById('pl-manufacturer').value;
      const name = document.getElementById('pl-name').value.trim();
      if (!manufacturerId || !name) return showAlert('Please fill all fields', 'error');
      const lines = DataStorage.getProductLines();
      const id = `line_${slugify(name)}`;
      lines[id] = { id, manufacturerId, name };
      DataStorage.set(DataStorage.KEYS.PRODUCT_LINES, lines);
      document.getElementById('pl-name').value = '';
      renderAll();
      showAlert('Product line added');
    };

    window.addProduct = () => {
      const productType = document.getElementById('prod-type').value;
      const productLineId = document.getElementById('prod-line').value;
      const productTypeCode = document.getElementById('prod-code').value.trim();
      const name = document.getElementById('prod-name').value.trim();
      const pricingModel = document.getElementById('prod-model').value;
      const minimumUI = parseInt(document.getElementById('prod-min-ui').value) || 0;
      const maximumUI = parseInt(document.getElementById('prod-max-ui').value) || null;

      if (!productType || !productLineId || !productTypeCode || !name) {
        return showAlert('Please fill all required fields', 'error');
      }

      const products = DataStorage.getProducts();
      const id = `prod_${slugify(name)}`;
      const product = {
        id, productType, productLineId, productTypeCode, name, pricingModel, minimumUI, maximumUI, allowedAddons: []
      };

      if (pricingModel === 'UI') {
        product.uiRate = parseFloat(document.getElementById('prod-ui-rate').value) || 0;
      } else {
        product.flatPrice = parseFloat(document.getElementById('prod-flat-price').value) || 0;
      }

      products[id] = product;
      DataStorage.set(DataStorage.KEYS.PRODUCTS, products);
      
      ['prod-code', 'prod-name', 'prod-ui-rate', 'prod-flat-price', 'prod-min-ui', 'prod-max-ui']
        .forEach(id => document.getElementById(id).value = '');
      renderAll();
      showAlert('Product added');
    };

    window.addAddon = () => {
      const name = document.getElementById('addon-name').value.trim();
      const pricingModel = document.getElementById('addon-model').value;
      const exclusiveGroup = document.getElementById('addon-exclusive').value.trim() || null;
      const mandatory = document.getElementById('addon-mandatory').checked;
      const hiddenFromCustomer = document.getElementById('addon-hidden').checked;
      const isJobBased = document.getElementById('addon-job-based').checked;
      
      const productTypesStr = document.getElementById('addon-product-types').value.trim();
      const allowedProductTypes = productTypesStr 
        ? productTypesStr.split(',').map(t => t.trim()).filter(t => t) : null;
      
      const productLinesStr = document.getElementById('addon-product-lines').value.trim();
      const allowedProductLines = productLinesStr
        ? productLinesStr.split(',').map(l => l.trim()).filter(l => l) : null;
      
      const maxSize = document.getElementById('addon-max-size').value ? 
        parseFloat(document.getElementById('addon-max-size').value) : null;
      const minSize = document.getElementById('addon-min-size').value ?
        parseFloat(document.getElementById('addon-min-size').value) : null;

      if (!name) return showAlert('Please enter a name', 'error');

      const addons = DataStorage.getAddons();
      const id = `addon_${slugify(name)}`;
      const addon = {
        id, name, pricingModel, exclusiveGroup, mandatory, hiddenFromCustomer, isJobBased,
        allowedProductTypes, allowedProductLines, maxSize, minSize
      };

      if (pricingModel === 'UI') {
        addon.uiRate = parseFloat(document.getElementById('addon-ui-rate').value) || 0;
      } else {
        addon.flatPrice = parseFloat(document.getElementById('addon-flat-price').value) || 0;
      }

      addons[id] = addon;
      DataStorage.set(DataStorage.KEYS.ADDONS, addons);
      
      ['addon-name', 'addon-ui-rate', 'addon-flat-price', 'addon-exclusive', 
       'addon-product-types', 'addon-product-lines', 'addon-max-size', 'addon-min-size']
        .forEach(id => document.getElementById(id).value = '');
      ['addon-mandatory', 'addon-hidden', 'addon-job-based']
        .forEach(id => document.getElementById(id).checked = false);
      renderAll();
      showAlert('Addon added');
    };

    window.deleteItem = (type, id) => {
      if (!confirm('Are you sure you want to delete this item?')) return;
      
      const key = {
        manufacturer: DataStorage.KEYS.MANUFACTURERS,
        productLine: DataStorage.KEYS.PRODUCT_LINES,
        product: DataStorage.KEYS.PRODUCTS,
        addon: DataStorage.KEYS.ADDONS
      }[type];

      const items = DataStorage.get(key);
      delete items[id];
      DataStorage.set(key, items);
      renderAll();
      showAlert('Item deleted');
    };

    // ============================================================================
    // VERSION MANAGEMENT (SIMPLIFIED)
    // ============================================================================

    window.publishVersion = () => {
      const name = prompt('Version name (optional):') || '';
      const notes = prompt('Version notes (optional):') || '';
      const version = DataStorage.publishPricingVersion(notes);
      if (name) {
        version.name = name;
        const versions = DataStorage.getPricingVersions();
        const idx = versions.findIndex(v => v.id === version.id);
        if (idx !== -1) {
          versions[idx].name = name;
          DataStorage.set(DataStorage.KEYS.PRICING_VERSIONS, versions);
        }
      }
      renderAll();
      showAlert(`Version ${name || version.id} published successfully`);
    };

    window.exportVersionData = () => {
      const versions = DataStorage.getPricingVersions();
      if (versions.length === 0) return showAlert('No versions to export', 'error');

      const versionSelect = versions.map(v => 
        `<option value="${v.id}">${v.name || v.id} (${new Date(v.timestamp).toLocaleDateString()})</option>`
      ).join('');
      
      const content = `
        <div class="form-group">
          <label>Select Version</label>
          <select id="version-to-export">${versionSelect}</select>
        </div>
        <div class="form-group">
          <label>Format</label>
          <select id="export-format">
            <option value="json">JSON</option>
            <option value="csv">CSV</option>
          </select>
        </div>
      `;

      const modalId = showModal('Export Version', content, [
        { label: 'Export', type: 'primary', onclick: () => {} },
        { label: 'Cancel', type: 'secondary', onclick: () => {} }
      ]);

      setTimeout(() => {
        const btn = document.getElementById(`btn-${modalId}-0`);
        if (btn) {
          btn.onclick = () => {
            const versionId = document.getElementById('version-to-export').value;
            const format = document.getElementById('export-format').value;
            const version = versions.find(v => v.id === versionId);
            if (!version) return;
            
            if (format === 'json') {
              exportAsJSON(version);
            } else {
              exportAsCSV(version);
            }
            
            document.getElementById(modalId).remove();
            showAlert('Version exported successfully');
          };
        }
      }, 10);
    };

    window.importVersionData = () => {
      document.getElementById('version-import-file').click();
    };

    window.handleVersionImport = () => {
      const file = document.getElementById('version-import-file').files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const content = e.target.result;
          let data;
          
          if (file.name.endsWith('.json')) {
            data = importFromJSON(content);
          } else if (file.name.endsWith('.csv')) {
            data = importFromCSV(content);
          } else {
            return showAlert('Please select a JSON or CSV file', 'error');
          }
          
          DataStorage.set(DataStorage.KEYS.MANUFACTURERS, data.manufacturers);
          DataStorage.set(DataStorage.KEYS.PRODUCT_LINES, data.productLines);
          DataStorage.set(DataStorage.KEYS.PRODUCTS, data.products);
          DataStorage.set(DataStorage.KEYS.ADDONS, data.addons);
          
          renderAll();
          showAlert(`Version imported from ${file.name.endsWith('.json') ? 'JSON' : 'CSV'} successfully`);
          document.getElementById('version-import-file').value = '';
        } catch (error) {
          showAlert(`Import failed: ${error.message}`, 'error');
          console.error(error);
        }
      };
      reader.readAsText(file);
    };

    window.deleteVersion = (versionId) => {
      if (!confirm('Delete this version?')) return;
      const versions = DataStorage.getPricingVersions().filter(v => v.id !== versionId);
      DataStorage.set(DataStorage.KEYS.PRICING_VERSIONS, versions);
      renderAll();
      showAlert('Version deleted');
    };

    window.loadVersion = (versionId) => {
      if (!confirm('Load this version? Current changes will be lost.')) return;
      const version = DataStorage.getPricingVersions().find(v => v.id === versionId);
      if (!version) return;

      DataStorage.set(DataStorage.KEYS.MANUFACTURERS, version.manufacturers || {});
      DataStorage.set(DataStorage.KEYS.PRODUCT_LINES, version.productLines || {});
      DataStorage.set(DataStorage.KEYS.PRODUCTS, version.products || {});
      DataStorage.set(DataStorage.KEYS.ADDONS, version.addons || {});
      
      renderAll();
      showAlert('Version loaded');
    };

    // ============================================================================
    // RENDER FUNCTIONS
    // ============================================================================

    function renderAll() {
      renderManufacturers();
      renderProductLines();
      renderProducts();
      renderAddons();
      renderVersions();
      renderSettings();
      populateDropdowns();
    }

    function renderManufacturers() {
      const manufacturers = DataStorage.getManufacturers();
      document.getElementById('mfg-table').innerHTML = `
        <table>
          <thead><tr><th>ID</th><th>Name</th><th>Actions</th></tr></thead>
          <tbody>
            ${Object.values(manufacturers).map(m => `
              <tr>
                <td>${m.id}</td>
                <td>${m.name}</td>
                <td>
                  <button class="btn-primary" title="Edit" aria-label="Edit" onclick="openEditModal('mfg', '${m.id}')">Edit</button>
                  <button class="btn-danger" title="Delete" aria-label="Delete" onclick="deleteItem('manufacturer', '${m.id}')">X</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderProductLines() {
      const lines = DataStorage.getProductLines();
      const manufacturers = DataStorage.getManufacturers();
      document.getElementById('pl-table').innerHTML = `
        <table>
          <thead><tr><th>ID</th><th>Manufacturer</th><th>Name</th><th>Actions</th></tr></thead>
          <tbody>
            ${Object.values(lines).map(l => `
              <tr>
                <td>${l.id}</td>
                <td>${manufacturers[l.manufacturerId]?.name || 'N/A'}</td>
                <td>${l.name}</td>
                <td>
                  <button class="btn-primary" title="Edit" aria-label="Edit" onclick="openEditModal('line', '${l.id}')">Edit</button>
                  <button class="btn-danger" title="Delete" aria-label="Delete" onclick="deleteItem('productLine', '${l.id}')">X</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderProducts() {
      const products = DataStorage.getProducts();
      const lines = DataStorage.getProductLines();
      document.getElementById('prod-table').innerHTML = `
        <table>
          <thead>
            <tr><th>Code</th><th>Product Line</th><th>Name</th><th>Model</th><th>Rate/Price</th><th>Min UI</th><th>Max UI</th><th>Actions</th></tr>
          </thead>
          <tbody>
            ${Object.values(products).map(p => `
              <tr>
                <td>${p.productTypeCode}</td>
                <td>${lines[p.productLineId]?.name || 'N/A'}</td>
                <td>${p.name}</td>
                <td>${p.pricingModel}</td>
                <td>${p.pricingModel === 'UI' ? `$${p.uiRate}/UI` : `$${p.flatPrice}`}</td>
                <td>${p.minimumUI}</td>
                <td>${p.maximumUI || 'Unlimited'}</td>
                <td>
                  <button class="btn-primary" title="Edit" aria-label="Edit" onclick="openEditModal('prod', '${p.id}')">Edit</button>
                  <button class="btn-danger" title="Delete" aria-label="Delete" onclick="deleteItem('product', '${p.id}')">X</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderAddons() {
      const addons = DataStorage.getAddons();
      document.getElementById('addon-table').innerHTML = `
        <table>
          <thead>
            <tr><th>Name</th><th>Model</th><th>Rate/Price</th><th>Exclusive Group</th><th>Mandatory</th><th>Hidden</th><th>Job Based</th><th>Actions</th></tr>
          </thead>
          <tbody>
            ${Object.values(addons).map(a => `
              <tr>
                <td>${a.name}</td>
                <td>${a.pricingModel}</td>
                <td>${a.pricingModel === 'UI' ? `$${a.uiRate}/UI` : `$${a.flatPrice}`}</td>
                <td>${a.exclusiveGroup || '-'}</td>
                <td>${a.mandatory ? '✓' : ''}</td>
                <td>${a.hiddenFromCustomer ? '✓' : ''}</td>
                <td>${a.isJobBased ? '✓' : ''}</td>
                <td>
                  <button class="btn-primary" title="Edit" aria-label="Edit" onclick="openEditModal('addon', '${a.id}')">Edit</button>
                  <button class="btn-danger" title="Delete" aria-label="Delete" onclick="deleteItem('addon', '${a.id}')">X</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderVersions() {
      const versions = DataStorage.getPricingVersions();
      document.getElementById('version-list').innerHTML = versions.reverse().map(v => `
        <div class="version-item">
          <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
            <div style="flex: 1;">
              <strong>${v.name || v.id}</strong>
              <div class="version-timestamp">${new Date(v.timestamp).toLocaleString()}</div>
              <div>${v.notes || '<em>No notes</em>'}</div>
            </div>
            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
              <button class="btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="loadVersion('${v.id}')">Load</button>
              <button class="btn-danger" title="Delete" aria-label="Delete" style="padding: 6px 12px; font-size: 12px;" onclick="deleteVersion('${v.id}')">X</button>
            </div>
          </div>
        </div>
      `).join('') || '<p>No versions published yet.</p>';
    }

    function renderSettings() {
      const settings = DataStorage.getGlobalSettings();
      document.getElementById('setting-minimum-ui').value = settings.minimumUI ?? 65;
      document.getElementById('setting-alerts-enabled').checked = settings.alertsEnabled !== false;
      document.getElementById('rules-list').innerHTML = '<p style="color: var(--text-secondary); font-size: 13px;">Rules feature coming soon...</p>';
    }

    window.saveGlobalSettings = () => {
      const minimumUI = parseInt(document.getElementById('setting-minimum-ui').value);
      const alertsEnabled = document.getElementById('setting-alerts-enabled').checked;
      
      if (isNaN(minimumUI) || minimumUI < 0) {
        return showAlert('Minimum UI must be 0 or greater', 'error');
      }

      DataStorage.updateGlobalSettings({ minimumUI, alertsEnabled });
      showAlert('Settings saved successfully');
      renderSettings();
    };

    function populateDropdowns() {
      const manufacturers = DataStorage.getManufacturers();
      const lines = DataStorage.getProductLines();
      
      document.getElementById('pl-manufacturer').innerHTML = 
        Object.values(manufacturers).map(m => `<option value="${m.id}">${m.name}</option>`).join('');
      
      document.getElementById('prod-line').innerHTML = 
        Object.values(lines).map(l => `<option value="${l.id}">${l.name}</option>`).join('');
    }

    // Initial render
    renderAll();
    activateTab('manufacturers');

    // Tab hover dimming effect
    const tabs = document.querySelectorAll('.admin-page .tab:not(.tab-publish)');
    
    tabs.forEach(tab => {
      tab.addEventListener('mouseenter', function() {
        tabs.forEach(otherTab => {
          if (otherTab !== tab && !otherTab.classList.contains('active')) {
            otherTab.classList.add('dimmed');
          }
        });
      });
      
      tab.addEventListener('mouseleave', function() {
        tabs.forEach(otherTab => {
          otherTab.classList.remove('dimmed');
        });
      });
    });
    
    // Also handle when leaving the entire tabs container
    const tabsContainer = document.querySelector('.admin-page .tabs');
    if (tabsContainer) {
      tabsContainer.addEventListener('mouseleave', function() {
        tabs.forEach(tab => {
          tab.classList.remove('dimmed');
        });
      });
    }
  </script>
</body>
</html>