---
import TabSection from '../components/TabSection.astro';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Krasiva Windows & Doors - Admin Control Panel</title>
  <link rel="stylesheet" href="/styles/shared.css">
</head>
<body class="admin-page">
  <a class="page-toggle" href="/" aria-label="Go to Sales page">Sales</a>
  <div class="container">
    <div id="alerts"></div>

    <div class="tabs">
      <button class="tab active" data-tab="manufacturers">Manufacturers</button>
      <button class="tab" data-tab="productLines">Product Lines</button>
      <button class="tab" data-tab="products">Products</button>
      <button class="tab" data-tab="addons">Addons</button>
      <button class="tab" data-tab="versions">Version History</button>
      <button class="tab" data-tab="settings">Settings</button>
      <button class="tab tab-publish" onclick="publishVersion()">Publish</button>
    </div>

    <TabSection id="manufacturers" title="Manufacturers" active>
      <div class="section-actions">
        <button class="btn-primary" onclick="openAddModal('mfg')">+ Add Manufacturer</button>
        <div class="filter-wrap">
          <div class="filter-toggle-row">
            <button class="btn-secondary filter-toggle" type="button" aria-expanded="false" aria-controls="mfg-filters" onclick="toggleFilterRow('mfg-filters', this)">Filters ▾</button>
          </div>
          <div id="mfg-filters" class="filter-row is-hidden">
            <input type="text" id="mfg-filter" placeholder="Filter by ID or name" oninput="renderManufacturers()">
          </div>
        </div>
      </div>
      <div id="mfg-table"></div>
    </TabSection>

    <TabSection id="productLines" title="Product Lines">
      <div class="section-actions">
        <button class="btn-primary" onclick="openAddModal('line')">+ Add Product Line</button>
        <div class="filter-wrap">
          <div class="filter-toggle-row">
            <button class="btn-secondary filter-toggle" type="button" aria-expanded="false" aria-controls="pl-filters" onclick="toggleFilterRow('pl-filters', this)">Filters ▾</button>
          </div>
          <div id="pl-filters" class="filter-row is-hidden">
            <select id="pl-filter-mfg" onchange="renderProductLines()"></select>
            <input type="text" id="pl-filter-text" placeholder="Filter by name" oninput="renderProductLines()">
          </div>
        </div>
      </div>
      <div id="pl-table"></div>
    </TabSection>

    <TabSection id="products" title="Products">
      <div class="section-actions">
        <button class="btn-primary" onclick="openAddModal('prod')">+ Add Product</button>
        <div class="filter-wrap">
          <div class="filter-toggle-row">
            <button class="btn-secondary filter-toggle" type="button" aria-expanded="false" aria-controls="prod-filters" onclick="toggleFilterRow('prod-filters', this)">Filters ▾</button>
          </div>
          <div id="prod-filters" class="filter-row is-hidden">
            <select id="prod-filter-type" onchange="renderProducts()"></select>
            <select id="prod-filter-line" onchange="renderProducts()"></select>
            <select id="prod-filter-model" onchange="renderProducts()">
              <option value="">All models</option>
              <option value="UI">UI-Based</option>
              <option value="FLAT">Flat Price</option>
            </select>
            <input type="text" id="prod-filter-text" placeholder="Filter by code or name" oninput="renderProducts()">
          </div>
        </div>
      </div>
      <div id="prod-table"></div>
    </TabSection>

    <TabSection id="addons" title="Addons">
      <div class="section-actions">
        <button class="btn-primary" onclick="openAddModal('addon')">+ Add Addon</button>
        <div class="filter-wrap">
          <div class="filter-toggle-row">
            <button class="btn-secondary filter-toggle" type="button" aria-expanded="false" aria-controls="addon-filters" onclick="toggleFilterRow('addon-filters', this)">Filters ▾</button>
          </div>
          <div id="addon-filters" class="filter-row is-hidden">
            <select id="addon-filter-model" onchange="renderAddons()">
              <option value="">All models</option>
              <option value="UI">UI-Based</option>
              <option value="FLAT">Flat Price</option>
            </select>
            <select id="addon-filter-line" onchange="renderAddons()"></select>
            <select id="addon-filter-type" onchange="renderAddons()"></select>
            <input type="text" id="addon-filter-text" placeholder="Filter by name or group" oninput="renderAddons()">
          </div>
        </div>
      </div>
      <div id="addon-table"></div>
    </TabSection>

    <TabSection id="versions" title="Pricing Version History" description="Manage and export previous pricing configurations.">
      <div class="section-actions">
        <div style="display: flex; gap: 8px;">
          <button class="btn-secondary" onclick="exportVersionData()">Export Version</button>
          <button class="btn-secondary" onclick="importVersionData()">Import Version</button>
        </div>
        <div class="filter-wrap">
          <div class="filter-toggle-row">
            <button class="btn-secondary filter-toggle" type="button" aria-expanded="false" aria-controls="version-filters" onclick="toggleFilterRow('version-filters', this)">Filters ▾</button>
          </div>
          <div id="version-filters" class="filter-row is-hidden">
            <input type="text" id="version-filter-name" placeholder="Filter by name" oninput="renderVersions()">
            <input type="month" id="version-filter-month" onchange="renderVersions()">
            <select id="version-filter-year" onchange="renderVersions()">
              <option value="">All years</option>
            </select>
          </div>
        </div>
      </div>
      <div class="version-history" id="version-list"></div>
    </TabSection>

    <TabSection id="settings" title="Global Settings" description="Configure global rules that apply to all quotes.">
      <div id="settings-inputs" class="input-section">
      <div class="form-row">
        <div class="form-group">
          <label>Minimum Billable Window UI (inches)</label>
          <input type="number" id="setting-minimum-ui" min="0" step="1" placeholder="65">
          <small>Windows can be smaller, but pricing uses at least this many united inches (width + height).</small>
        </div>
      </div>
      <div class="checkbox-section">
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="setting-alerts-enabled">
            Enable Success Alerts
          </label>
          <small>Show notification messages when actions are completed</small>
        </div>
      </div>
      <div class="rules-panel">
        <div style="display:flex; align-items:center; justify-content: space-between; gap: 8px;">
          <div>
            <h3 style="margin: 0; font-size: 0.95rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;">Rules</h3>
            <div style="font-size: 12px; color: var(--text-secondary);">Use conditions to auto-apply mandatory addons</div>
          </div>
          <button class="btn-secondary" type="button" onclick="openAddRuleModal()">+ Add Rule</button>
        </div>
        <div id="rules-list" style="margin-top: 12px;"></div>
      </div>
      <div class="form-actions">
        <button class="btn-primary" onclick="saveGlobalSettings()">Save Settings</button>
      </div>
      <div id="settings-status"></div>
      </div>
    </TabSection>
  </div>

  <input type="file" id="version-import-file" accept=".json,.csv" style="display:none;" onchange="handleVersionImport()">

  <script type="module">
    import { PricingEngine } from '/pricing_engine.js';
    import { DataStorage } from '/data_storage.js';
    import { showAlert as showAlertShared, showModal } from '/shared/ui_helpers.js';
    import { FIELD_SCHEMAS, buildFieldHtml } from '/shared/admin_schemas.js';
    import { exportAsJSON, exportAsCSV, importFromJSON, importFromCSV } from '/shared/version_utils.js';

    // Initialize
    DataStorage.initializeSampleData();
    window.storage = DataStorage;
    window.engine = PricingEngine;

    // ============================================================================
    // GLOBAL UI
    // ============================================================================

    window.showAlert = (message, type = 'success') => {
      const settings = DataStorage.getGlobalSettings();
      const alertsEnabled = settings && settings.alertsEnabled !== false;
      showAlertShared(message, type, { enabled: alertsEnabled });
    };
    window.showModal = showModal;

    window.toggleFilterRow = (rowId, buttonEl) => {
      const row = document.getElementById(rowId);
      if (!row) return;
      const isHidden = row.classList.toggle('is-hidden');
      if (buttonEl) {
        buttonEl.textContent = isHidden ? 'Filters ▾' : 'Filters ▴';
        buttonEl.setAttribute('aria-expanded', (!isHidden).toString());
      }
    };

    const activateTab = (tabName) => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      const tabButton = document.querySelector(`.tab[data-tab="${tabName}"]`);
      if (tabButton) tabButton.classList.add('active');
      const section = document.getElementById(tabName);
      if (section) section.classList.add('active');
      renderAll();
    };

    const PRODUCT_TYPES = ['Window', 'Door', 'Sliding Door', 'Bifold Door', 'Sidelite', 'French Door'];

    const setSelectOptions = (selectId, options, allLabel) => {
      const select = document.getElementById(selectId);
      if (!select) return;
      const currentValue = select.value;
      const opts = [{ value: '', label: allLabel }].concat(options);
      select.innerHTML = opts.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
      const hasCurrent = opts.some(o => o.value === currentValue);
      select.value = hasCurrent ? currentValue : '';
    };

    const buildOptionsHtml = (options) => options.map(o => `<option value="${o.value}">${o.label}</option>`).join('');

    window.toggleAddPricingFields = () => togglePricingGroup('add-prod-model', 'add-prod-rate-group', 'add-prod-price-group');
    window.toggleAddAddonPricingFields = () => togglePricingGroup('add-addon-model', 'add-addon-rate-group', 'add-addon-price-group');

    window.openAddModal = (type) => {
      const manufacturers = DataStorage.getManufacturers();
      const lines = DataStorage.getProductLines();
      const manufacturerOptions = Object.values(manufacturers).map(m => ({ value: m.id, label: m.name }));
      const lineOptions = Object.values(lines).map(l => ({ value: l.id, label: l.name }));

      if (type === 'mfg') {
        const content = `
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="add-mfg-name" placeholder="e.g., Andersen Windows">
          </div>
        `;
        showModal('Add Manufacturer', content, [
          { label: 'Add', type: 'primary', onclick: () => addManufacturer({ name: document.getElementById('add-mfg-name').value }) },
          { label: 'Cancel', type: 'secondary', onclick: () => {} }
        ]);
        return;
      }

      if (type === 'line') {
        const content = `
          <div class="form-group">
            <label>Manufacturer</label>
            <select id="add-line-mfg">
              ${buildOptionsHtml(manufacturerOptions)}
            </select>
          </div>
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="add-line-name" placeholder="e.g., 400 Series">
          </div>
        `;
        showModal('Add Product Line', content, [
          { label: 'Add', type: 'primary', onclick: () => addProductLine({ manufacturerId: document.getElementById('add-line-mfg').value, name: document.getElementById('add-line-name').value }) },
          { label: 'Cancel', type: 'secondary', onclick: () => {} }
        ]);
        return;
      }

      if (type === 'prod') {
        const content = `
          <div class="form-row">
            <div class="form-group">
              <label>Product Type</label>
              <select id="add-prod-type">
                ${buildOptionsHtml(PRODUCT_TYPES.map(t => ({ value: t, label: t })))}
              </select>
            </div>
            <div class="form-group">
              <label>Product Line</label>
              <select id="add-prod-line">
                ${buildOptionsHtml(lineOptions)}
              </select>
            </div>
            <div class="form-group">
              <label>Type Code</label>
              <input type="text" id="add-prod-code" placeholder="e.g., SH, DH">
            </div>
            <div class="form-group full-span">
              <label>Name</label>
              <input type="text" id="add-prod-name" placeholder="e.g., Single Hung">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Pricing Model</label>
              <select id="add-prod-model" onchange="toggleAddPricingFields()">
                <option value="UI">UI-Based</option>
                <option value="FLAT">Flat Price</option>
              </select>
            </div>
            <div class="form-group" id="add-prod-rate-group">
              <label>UI Rate ($)</label>
              <input type="number" id="add-prod-ui-rate" step="0.01" placeholder="12.50">
            </div>
            <div class="form-group" id="add-prod-price-group" style="display:none;">
              <label>Flat Price ($)</label>
              <input type="number" id="add-prod-flat-price" step="0.01" placeholder="2500">
            </div>
            <div class="form-group">
              <label>Minimum UI</label>
              <input type="number" id="add-prod-min-ui" placeholder="100">
            </div>
            <div class="form-group">
              <label>Maximum UI (blank = unlimited)</label>
              <input type="number" id="add-prod-max-ui" placeholder="500">
            </div>
          </div>
        `;
        showModal('Add Product', content, [
          { label: 'Add', type: 'primary', onclick: () => addProduct({
            productType: document.getElementById('add-prod-type').value,
            productLineId: document.getElementById('add-prod-line').value,
            productTypeCode: document.getElementById('add-prod-code').value,
            name: document.getElementById('add-prod-name').value,
            pricingModel: document.getElementById('add-prod-model').value,
            uiRate: document.getElementById('add-prod-ui-rate').value,
            flatPrice: document.getElementById('add-prod-flat-price').value,
            minimumUI: document.getElementById('add-prod-min-ui').value,
            maximumUI: document.getElementById('add-prod-max-ui').value
          }) },
          { label: 'Cancel', type: 'secondary', onclick: () => {} }
        ]);
        return;
      }

      if (type === 'addon') {
        const content = `
          <div class="form-row">
            <div class="form-group full-span">
              <label>Name</label>
              <input type="text" id="add-addon-name" placeholder="e.g., Colonial Grids">
            </div>
            <div class="form-group full-span">
              <label>Exclusive Group (optional)</label>
              <input type="text" id="add-addon-exclusive" placeholder="e.g., glass_type">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Pricing Model</label>
              <select id="add-addon-model" onchange="toggleAddAddonPricingFields()">
                <option value="UI">UI-Based</option>
                <option value="FLAT">Flat Price</option>
              </select>
            </div>
            <div class="form-group" id="add-addon-rate-group">
              <label>UI Rate ($)</label>
              <input type="number" id="add-addon-ui-rate" step="0.01" placeholder="2.00">
            </div>
            <div class="form-group" id="add-addon-price-group" style="display:none;">
              <label>Flat Price ($)</label>
              <input type="number" id="add-addon-flat-price" step="0.01" placeholder="350">
            </div>
          </div>
          <div class="checkbox-section">
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="add-addon-mandatory">
                Mandatory
              </label>
            </div>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="add-addon-hidden">
                Hidden from Customer
              </label>
            </div>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="add-addon-job-based">
                Job Based (Global - apply to all quotes)
              </label>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Allowed Product Types (leave blank for all)</label>
              <input type="text" id="add-addon-product-types" placeholder="e.g., Window, Door (comma-separated)">
            </div>
            <div class="form-group">
              <label>Allowed Product Lines (leave blank for all)</label>
              <input type="text" id="add-addon-product-lines" placeholder="e.g., Premium, Standard (comma-separated)">
            </div>
            <div class="form-group">
              <label>Max Size (sq ft, leave blank for unlimited)</label>
              <input type="number" id="add-addon-max-size" step="0.01" placeholder="21">
            </div>
            <div class="form-group">
              <label>Min Size (sq ft, leave blank for no minimum)</label>
              <input type="number" id="add-addon-min-size" step="0.01" placeholder="0">
            </div>
          </div>
        `;
        showModal('Add Addon', content, [
          { label: 'Add', type: 'primary', onclick: () => addAddon({
            name: document.getElementById('add-addon-name').value,
            pricingModel: document.getElementById('add-addon-model').value,
            exclusiveGroup: document.getElementById('add-addon-exclusive').value,
            mandatory: document.getElementById('add-addon-mandatory').checked,
            hiddenFromCustomer: document.getElementById('add-addon-hidden').checked,
            isJobBased: document.getElementById('add-addon-job-based').checked,
            uiRate: document.getElementById('add-addon-ui-rate').value,
            flatPrice: document.getElementById('add-addon-flat-price').value,
            allowedProductTypes: document.getElementById('add-addon-product-types').value,
            allowedProductLines: document.getElementById('add-addon-product-lines').value,
            maxSize: document.getElementById('add-addon-max-size').value,
            minSize: document.getElementById('add-addon-min-size').value
          }) },
          { label: 'Cancel', type: 'secondary', onclick: () => {} }
        ]);
      }
    };

    window.openAddRuleModal = () => {
      const addons = DataStorage.getAddons();
      const addonOptions = Object.values(addons).map(a => ({ value: a.id, label: a.name }));
      const content = `
        <div class="form-group">
          <label>Rule Name</label>
          <input type="text" id="add-rule-name" placeholder="e.g., Mandatory tempered glass">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Apply To</label>
            <select id="add-rule-applies">
              <option value="lineItem">Line Item</option>
              <option value="job">Job</option>
            </select>
          </div>
          <div class="form-group">
            <label>Addon</label>
            <select id="add-rule-addon">
              ${buildOptionsHtml(addonOptions)}
            </select>
          </div>
        </div>
      `;
      showModal('Add Rule', content, [
        { label: 'Add', type: 'primary', onclick: () => addRule({
          name: document.getElementById('add-rule-name').value,
          appliesTo: document.getElementById('add-rule-applies').value,
          addonId: document.getElementById('add-rule-addon').value
        }) },
        { label: 'Cancel', type: 'secondary', onclick: () => {} }
      ]);
    };

    document.addEventListener('click', (evt) => {
      const tabButton = evt.target?.closest('.tab[data-tab]');
      if (!tabButton) return;
      const tabName = tabButton.getAttribute('data-tab');
      if (tabName) activateTab(tabName);
    });

    // ============================================================================
    // PRICING TOGGLE
    // ============================================================================

    const togglePricingGroup = (modelId, uiGroupId, flatGroupId) => {
      const modelEl = document.getElementById(modelId);
      const uiGroup = document.getElementById(uiGroupId);
      const flatGroup = document.getElementById(flatGroupId);
      if (!modelEl || !uiGroup || !flatGroup) return;
      const model = modelEl.value;
      uiGroup.style.display = model === 'UI' ? '' : 'none';
      flatGroup.style.display = model === 'FLAT' ? '' : 'none';
    };

    window.togglePricingFields = () => togglePricingGroup('prod-model', 'prod-ui-rate-group', 'prod-flat-price-group');
    window.toggleAddonPricingFields = () => togglePricingGroup('addon-model', 'addon-ui-rate-group', 'addon-flat-price-group');
    window.toggleEditPricingFields = () => togglePricingGroup('edit-prod-model', 'edit-prod-rate-group', 'edit-prod-price-group');
    window.toggleEditAddonPricingFields = () => togglePricingGroup('edit-addon-model', 'edit-addon-rate-group', 'edit-addon-price-group');

    // ============================================================================
    // EDIT MODAL (UNIFIED)
    // ============================================================================

    window.openEditModal = (type, id) => {
      const items = DataStorage.get(type === 'mfg' ? DataStorage.KEYS.MANUFACTURERS : 
                                     type === 'line' ? DataStorage.KEYS.PRODUCT_LINES : 
                                     type === 'prod' ? DataStorage.KEYS.PRODUCTS :
                                     DataStorage.KEYS.ADDONS);
      const item = items[id];
      if (!item) return;

      const schema = FIELD_SCHEMAS[type];
      if (!schema) return;

      const context = {};
      if (type === 'prod') {
        const lines = DataStorage.getProductLines();
        context.productLineName = lines[item.productLineId]?.name || 'N/A';
      }

      if (type === 'addon') {
        const uiDisplay = item.pricingModel === 'UI' ? '' : 'none';
        const flatDisplay = item.pricingModel === 'FLAT' ? '' : 'none';
        const allowedTypes = Array.isArray(item.allowedProductTypes) ? item.allowedProductTypes.join(', ') : '';
        const allowedLines = Array.isArray(item.allowedProductLines) ? item.allowedProductLines.join(', ') : '';
        const content = `
          <div class="form-row">
            <div class="form-group full-span">
              <label>Name</label>
              <input type="text" id="edit-addon-name" value="${item.name || ''}" placeholder="e.g., Colonial Grids">
            </div>
            <div class="form-group full-span">
              <label>Exclusive Group (optional)</label>
              <input type="text" id="edit-addon-exclusive" value="${item.exclusiveGroup || ''}" placeholder="e.g., glass_type">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Pricing Model</label>
              <select id="edit-addon-model" onchange="toggleEditAddonPricingFields()">
                <option value="UI" ${item.pricingModel === 'UI' ? 'selected' : ''}>UI-Based</option>
                <option value="FLAT" ${item.pricingModel === 'FLAT' ? 'selected' : ''}>Flat Price</option>
              </select>
            </div>
            <div class="form-group" id="edit-addon-rate-group" style="display:${uiDisplay};">
              <label>UI Rate ($)</label>
              <input type="number" id="edit-addon-ui-rate" step="0.01" value="${item.uiRate ?? ''}" placeholder="2.00">
            </div>
            <div class="form-group" id="edit-addon-price-group" style="display:${flatDisplay};">
              <label>Flat Price ($)</label>
              <input type="number" id="edit-addon-flat-price" step="0.01" value="${item.flatPrice ?? ''}" placeholder="350">
            </div>
          </div>
          <div class="checkbox-section">
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="edit-addon-mandatory" ${item.mandatory ? 'checked' : ''}>
                Mandatory
              </label>
            </div>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="edit-addon-hidden" ${item.hiddenFromCustomer ? 'checked' : ''}>
                Hidden from Customer
              </label>
            </div>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="edit-addon-job-based" ${item.isJobBased ? 'checked' : ''}>
                Job Based (Global - apply to all quotes)
              </label>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Allowed Product Types (leave blank for all)</label>
              <input type="text" id="edit-addon-product-types" value="${allowedTypes}" placeholder="e.g., Window, Door (comma-separated)">
            </div>
            <div class="form-group">
              <label>Allowed Product Lines (leave blank for all)</label>
              <input type="text" id="edit-addon-product-lines" value="${allowedLines}" placeholder="e.g., Premium, Standard (comma-separated)">
            </div>
            <div class="form-group">
              <label>Max Size (sq ft, leave blank for unlimited)</label>
              <input type="number" id="edit-addon-max-size" step="0.01" value="${item.maxSize ?? ''}" placeholder="21">
            </div>
            <div class="form-group">
              <label>Min Size (sq ft, leave blank for no minimum)</label>
              <input type="number" id="edit-addon-min-size" step="0.01" value="${item.minSize ?? ''}" placeholder="0">
            </div>
          </div>
        `;
        showModal('Edit Addon', content, [
          { label: 'Save', type: 'primary', onclick: () => saveEditedItem(type, id) },
          { label: 'Cancel', type: 'secondary', onclick: () => {} }
        ]);
        return;
      }

      const fieldsHtml = schema.fields.map(f => buildFieldHtml(f, item, context)).join('');
      showModal(schema.title, fieldsHtml, [
        { label: 'Save', type: 'primary', onclick: () => saveEditedItem(type, id) },
        { label: 'Cancel', type: 'secondary', onclick: () => {} }
      ]);
    };

    window.saveEditedItem = (type, id) => {
      if (type === 'mfg') {
        const name = document.getElementById('edit-mfg-name').value.trim();
        if (!name) return showAlert('Please enter a name', 'error');
        const manufacturers = DataStorage.getManufacturers();
        manufacturers[id].name = name;
        DataStorage.set(DataStorage.KEYS.MANUFACTURERS, manufacturers);
      } else if (type === 'line') {
        const name = document.getElementById('edit-line-name').value.trim();
        if (!name) return showAlert('Please enter a name', 'error');
        const lines = DataStorage.getProductLines();
        lines[id].name = name;
        DataStorage.set(DataStorage.KEYS.PRODUCT_LINES, lines);
      } else if (type === 'prod') {
        const name = document.getElementById('edit-prod-name').value.trim();
        const code = document.getElementById('edit-prod-code').value.trim();
        const model = document.getElementById('edit-prod-model').value;
        if (!name || !code) return showAlert('Please fill all required fields', 'error');
        const products = DataStorage.getProducts();
        products[id].name = name;
        products[id].productTypeCode = code;
        products[id].pricingModel = model;
        products[id].minimumUI = parseInt(document.getElementById('edit-prod-min-ui').value) || 0;
        products[id].maximumUI = parseInt(document.getElementById('edit-prod-max-ui').value) || null;
        if (model === 'UI') {
          products[id].uiRate = parseFloat(document.getElementById('edit-prod-ui-rate').value) || 0;
          delete products[id].flatPrice;
        } else {
          products[id].flatPrice = parseFloat(document.getElementById('edit-prod-flat-price').value) || 0;
          delete products[id].uiRate;
        }
        DataStorage.set(DataStorage.KEYS.PRODUCTS, products);
      } else if (type === 'addon') {
        const name = document.getElementById('edit-addon-name').value.trim();
        const model = document.getElementById('edit-addon-model').value;
        if (!name) return showAlert('Please enter a name', 'error');
        const addons = DataStorage.getAddons();
        addons[id].name = name;
        addons[id].pricingModel = model;
        addons[id].exclusiveGroup = document.getElementById('edit-addon-exclusive').value.trim() || null;
        addons[id].mandatory = document.getElementById('edit-addon-mandatory').checked;
        addons[id].hiddenFromCustomer = document.getElementById('edit-addon-hidden').checked;
        addons[id].isJobBased = document.getElementById('edit-addon-job-based').checked;
        
        const productTypesStr = document.getElementById('edit-addon-product-types').value.trim();
        addons[id].allowedProductTypes = productTypesStr 
          ? productTypesStr.split(',').map(t => t.trim()).filter(t => t)
          : null;
        
        const productLinesStr = document.getElementById('edit-addon-product-lines').value.trim();
        addons[id].allowedProductLines = productLinesStr
          ? productLinesStr.split(',').map(l => l.trim()).filter(l => l)
          : null;
        
        addons[id].maxSize = document.getElementById('edit-addon-max-size').value
          ? parseFloat(document.getElementById('edit-addon-max-size').value)
          : null;
        
        addons[id].minSize = document.getElementById('edit-addon-min-size').value
          ? parseFloat(document.getElementById('edit-addon-min-size').value)
          : null;
        
        if (model === 'UI') {
          addons[id].uiRate = parseFloat(document.getElementById('edit-addon-ui-rate').value) || 0;
          delete addons[id].flatPrice;
        } else {
          addons[id].flatPrice = parseFloat(document.getElementById('edit-addon-flat-price').value) || 0;
          delete addons[id].uiRate;
        }
        DataStorage.set(DataStorage.KEYS.ADDONS, addons);
      }
      renderAll();
      showAlert('Item updated successfully');
    };

    // ============================================================================
    // CRUD OPERATIONS
    // ============================================================================

    const slugify = (text) => text.toLowerCase().trim()
      .replace(/[^\w\s-]/g, '').replace(/\s+/g, '_').replace(/_+/g, '_').substring(0, 20);

    window.addManufacturer = (payload = {}) => {
      const name = (payload.name || '').trim();
      if (!name) return showAlert('Please enter a name', 'error');
      const manufacturers = DataStorage.getManufacturers();
      const id = `mfg_${slugify(name)}`;
      manufacturers[id] = { id, name };
      DataStorage.set(DataStorage.KEYS.MANUFACTURERS, manufacturers);
      renderAll();
      showAlert('Manufacturer added');
    };

    window.addProductLine = (payload = {}) => {
      const manufacturerId = payload.manufacturerId || '';
      const name = (payload.name || '').trim();
      if (!manufacturerId || !name) return showAlert('Please fill all fields', 'error');
      const lines = DataStorage.getProductLines();
      const id = `line_${slugify(name)}`;
      lines[id] = { id, manufacturerId, name };
      DataStorage.set(DataStorage.KEYS.PRODUCT_LINES, lines);
      renderAll();
      showAlert('Product line added');
    };

    window.addProduct = (payload = {}) => {
      const productType = payload.productType || '';
      const productLineId = payload.productLineId || '';
      const productTypeCode = (payload.productTypeCode || '').trim();
      const name = (payload.name || '').trim();
      const pricingModel = payload.pricingModel || 'UI';
      const minimumUI = parseInt(payload.minimumUI) || 0;
      const maximumUI = payload.maximumUI === '' || payload.maximumUI === null || payload.maximumUI === undefined
        ? null
        : parseInt(payload.maximumUI);

      if (!productType || !productLineId || !productTypeCode || !name) {
        return showAlert('Please fill all required fields', 'error');
      }

      const products = DataStorage.getProducts();
      const id = `prod_${slugify(name)}`;
      const product = {
        id, productType, productLineId, productTypeCode, name, pricingModel, minimumUI, maximumUI, allowedAddons: []
      };

      if (pricingModel === 'UI') {
        product.uiRate = parseFloat(payload.uiRate) || 0;
      } else {
        product.flatPrice = parseFloat(payload.flatPrice) || 0;
      }

      products[id] = product;
      DataStorage.set(DataStorage.KEYS.PRODUCTS, products);
      renderAll();
      showAlert('Product added');
    };

    window.addAddon = (payload = {}) => {
      const name = (payload.name || '').trim();
      const pricingModel = payload.pricingModel || 'UI';
      const exclusiveGroup = (payload.exclusiveGroup || '').trim() || null;
      const mandatory = !!payload.mandatory;
      const hiddenFromCustomer = !!payload.hiddenFromCustomer;
      const isJobBased = !!payload.isJobBased;
      
      const productTypesStr = (payload.allowedProductTypes || '').trim();
      const allowedProductTypes = productTypesStr 
        ? productTypesStr.split(',').map(t => t.trim()).filter(t => t) : null;
      
      const productLinesStr = (payload.allowedProductLines || '').trim();
      const allowedProductLines = productLinesStr
        ? productLinesStr.split(',').map(l => l.trim()).filter(l => l) : null;
      
      const maxSize = payload.maxSize ? parseFloat(payload.maxSize) : null;
      const minSize = payload.minSize ? parseFloat(payload.minSize) : null;

      if (!name) return showAlert('Please enter a name', 'error');

      const addons = DataStorage.getAddons();
      const id = `addon_${slugify(name)}`;
      const addon = {
        id, name, pricingModel, exclusiveGroup, mandatory, hiddenFromCustomer, isJobBased,
        allowedProductTypes, allowedProductLines, maxSize, minSize
      };

      if (pricingModel === 'UI') {
        addon.uiRate = parseFloat(payload.uiRate) || 0;
      } else {
        addon.flatPrice = parseFloat(payload.flatPrice) || 0;
      }

      addons[id] = addon;
      DataStorage.set(DataStorage.KEYS.ADDONS, addons);
      renderAll();
      showAlert('Addon added');
    };

    window.deleteItem = (type, id) => {
      if (!confirm('Are you sure you want to delete this item?')) return;
      
      const key = {
        manufacturer: DataStorage.KEYS.MANUFACTURERS,
        productLine: DataStorage.KEYS.PRODUCT_LINES,
        product: DataStorage.KEYS.PRODUCTS,
        addon: DataStorage.KEYS.ADDONS
      }[type];

      const items = DataStorage.get(key);
      delete items[id];
      DataStorage.set(key, items);
      renderAll();
      showAlert('Item deleted');
    };

    // ============================================================================
    // VERSION MANAGEMENT (SIMPLIFIED)
    // ============================================================================

    window.publishVersion = (callback) => {
      showModal(
        'Publish Version',
        `<div class="form-group">
          <label>Version Name (optional)</label>
          <input type="text" id="publish-version-name" placeholder="e.g., Spring 2026 Pricing">
        </div>
        <div class="form-group">
          <label>Notes (optional)</label>
          <textarea id="publish-version-notes" rows="3" placeholder="Describe what changed in this version..."></textarea>
        </div>`,
        [
          {
            label: 'Publish',
            type: 'primary',
            onclick: () => {
              const name = document.getElementById('publish-version-name').value.trim();
              const notes = document.getElementById('publish-version-notes').value.trim();
              const version = DataStorage.publishPricingVersion(notes);
              if (name) {
                version.name = name;
                const versions = DataStorage.getPricingVersions();
                const idx = versions.findIndex(v => v.id === version.id);
                if (idx !== -1) {
                  versions[idx].name = name;
                  DataStorage.set(DataStorage.KEYS.PRICING_VERSIONS, versions);
                }
              }
              renderAll();
              showAlert(`Version ${name || version.id} published successfully`);
              if (callback) callback();
            }
          },
          { label: 'Cancel', onclick: () => {} }
        ]
      );
    };

    window.exportVersionData = () => {
      const versions = DataStorage.getPricingVersions();
      if (versions.length === 0) return showAlert('No versions to export', 'error');

      const versionSelect = versions.map(v => 
        `<option value="${v.id}">${v.name || v.id} (${new Date(v.timestamp).toLocaleDateString()})</option>`
      ).join('');
      
      const content = `
        <div class="form-group">
          <label>Select Version</label>
          <select id="version-to-export">${versionSelect}</select>
        </div>
        <div class="form-group">
          <label>Format</label>
          <select id="export-format">
            <option value="json">JSON</option>
            <option value="csv">CSV</option>
          </select>
        </div>
      `;

      const modalId = showModal('Export Version', content, [
        { label: 'Export', type: 'primary', onclick: () => {} },
        { label: 'Cancel', type: 'secondary', onclick: () => {} }
      ]);

      setTimeout(() => {
        const btn = document.getElementById(`btn-${modalId}-0`);
        if (btn) {
          btn.onclick = () => {
            const versionId = document.getElementById('version-to-export').value;
            const format = document.getElementById('export-format').value;
            const version = versions.find(v => v.id === versionId);
            if (!version) return;
            
            if (format === 'json') {
              exportAsJSON(version);
            } else {
              exportAsCSV(version);
            }
            
            document.getElementById(modalId).remove();
            showAlert('Version exported successfully');
          };
        }
      }, 10);
    };

    window.importVersionData = () => {
      showModal(
        'Import Version',
        '<p>Do you want to save your current version before importing?</p>',
        [
          {
            label: 'Save & Import',
            type: 'primary',
            onclick: () => {
              publishVersion(() => {
                document.getElementById('version-import-file').click();
              });
            }
          },
          {
            label: 'Import Without Saving',
            onclick: () => {
              document.getElementById('version-import-file').click();
            }
          },
          { label: 'Cancel', onclick: () => {} }
        ]
      );
    };

    window.handleVersionImport = () => {
      const file = document.getElementById('version-import-file').files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const content = e.target.result;
          let data;
          
          if (file.name.endsWith('.json')) {
            data = importFromJSON(content);
          } else if (file.name.endsWith('.csv')) {
            data = importFromCSV(content);
          } else {
            return showAlert('Please select a JSON or CSV file', 'error');
          }
          
          DataStorage.set(DataStorage.KEYS.MANUFACTURERS, data.manufacturers);
          DataStorage.set(DataStorage.KEYS.PRODUCT_LINES, data.productLines);
          DataStorage.set(DataStorage.KEYS.PRODUCTS, data.products);
          DataStorage.set(DataStorage.KEYS.ADDONS, data.addons);
          
          renderAll();
          showAlert(`Version imported from ${file.name.endsWith('.json') ? 'JSON' : 'CSV'} successfully`);
          document.getElementById('version-import-file').value = '';
        } catch (error) {
          showAlert(`Import failed: ${error.message}`, 'error');
          console.error(error);
        }
      };
      reader.readAsText(file);
    };

    window.deleteVersion = (versionId) => {
      if (!confirm('Delete this version?')) return;
      const versions = DataStorage.getPricingVersions().filter(v => v.id !== versionId);
      DataStorage.set(DataStorage.KEYS.PRICING_VERSIONS, versions);
      renderAll();
      showAlert('Version deleted');
    };

    window.loadVersion = (versionId) => {
      if (!confirm('Load this version? Current changes will be lost.')) return;
      const version = DataStorage.getPricingVersions().find(v => v.id === versionId);
      if (!version) return;

      DataStorage.set(DataStorage.KEYS.MANUFACTURERS, version.manufacturers || {});
      DataStorage.set(DataStorage.KEYS.PRODUCT_LINES, version.productLines || {});
      DataStorage.set(DataStorage.KEYS.PRODUCTS, version.products || {});
      DataStorage.set(DataStorage.KEYS.ADDONS, version.addons || {});
      
      renderAll();
      showAlert('Version loaded');
    };

    // ============================================================================
    // RENDER FUNCTIONS
    // ============================================================================

    function renderAll() {
      renderManufacturers();
      renderProductLines();
      renderProducts();
      renderAddons();
      renderVersions();
      renderSettings();
      populateDropdowns();
    }

    function renderManufacturers() {
      const manufacturers = DataStorage.getManufacturers();
      const filterText = (document.getElementById('mfg-filter')?.value || '').toLowerCase();
      const filtered = Object.values(manufacturers).filter(m => {
        if (!filterText) return true;
        return m.id.toLowerCase().includes(filterText) || m.name.toLowerCase().includes(filterText);
      });
      document.getElementById('mfg-table').innerHTML = `
        <table>
          <thead><tr><th>ID</th><th>Name</th><th></th></tr></thead>
          <tbody>
            ${filtered.map(m => `
              <tr>
                <td>${m.id}</td>
                <td>${m.name}</td>
                <td>
                  <button class="btn-primary" title="Edit" aria-label="Edit" onclick="openEditModal('mfg', '${m.id}')">Edit</button>
                  <button class="btn-danger" title="Delete" aria-label="Delete" onclick="deleteItem('manufacturer', '${m.id}')">X</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderProductLines() {
      const lines = DataStorage.getProductLines();
      const manufacturers = DataStorage.getManufacturers();
      const filterMfg = document.getElementById('pl-filter-mfg')?.value || '';
      const filterText = (document.getElementById('pl-filter-text')?.value || '').toLowerCase();
      const filtered = Object.values(lines).filter(l => {
        if (filterMfg && l.manufacturerId !== filterMfg) return false;
        if (!filterText) return true;
        return l.name.toLowerCase().includes(filterText);
      });
      document.getElementById('pl-table').innerHTML = `
        <table>
          <thead><tr><th>ID</th><th>Manufacturer</th><th>Name</th><th></th></tr></thead>
          <tbody>
            ${filtered.map(l => `
              <tr>
                <td>${l.id}</td>
                <td>${manufacturers[l.manufacturerId]?.name || 'N/A'}</td>
                <td>${l.name}</td>
                <td>
                  <button class="btn-primary" title="Edit" aria-label="Edit" onclick="openEditModal('line', '${l.id}')">Edit</button>
                  <button class="btn-danger" title="Delete" aria-label="Delete" onclick="deleteItem('productLine', '${l.id}')">X</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderProducts() {
      const products = DataStorage.getProducts();
      const lines = DataStorage.getProductLines();
      const filterType = document.getElementById('prod-filter-type')?.value || '';
      const filterLine = document.getElementById('prod-filter-line')?.value || '';
      const filterModel = document.getElementById('prod-filter-model')?.value || '';
      const filterText = (document.getElementById('prod-filter-text')?.value || '').toLowerCase();
      const filtered = Object.values(products).filter(p => {
        if (filterType && p.productType !== filterType) return false;
        if (filterLine && p.productLineId !== filterLine) return false;
        if (filterModel && p.pricingModel !== filterModel) return false;
        if (!filterText) return true;
        return p.productTypeCode.toLowerCase().includes(filterText) || p.name.toLowerCase().includes(filterText);
      });
      document.getElementById('prod-table').innerHTML = `
        <table>
          <thead>
            <tr><th>Code</th><th>Product Line</th><th>Name</th><th>Model</th><th>Rate/Price</th><th>Min UI</th><th>Max UI</th><th></th></tr>
          </thead>
          <tbody>
            ${filtered.map(p => `
              <tr>
                <td>${p.productTypeCode}</td>
                <td>${lines[p.productLineId]?.name || 'N/A'}</td>
                <td>${p.name}</td>
                <td>${p.pricingModel}</td>
                <td>${p.pricingModel === 'UI' ? `$${p.uiRate}/UI` : `$${p.flatPrice}`}</td>
                <td>${p.minimumUI}</td>
                <td>${p.maximumUI || 'Unlimited'}</td>
                <td>
                  <button class="btn-primary" title="Edit" aria-label="Edit" onclick="openEditModal('prod', '${p.id}')">Edit</button>
                  <button class="btn-danger" title="Delete" aria-label="Delete" onclick="deleteItem('product', '${p.id}')">X</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderAddons() {
      const addons = DataStorage.getAddons();
      const filterModel = document.getElementById('addon-filter-model')?.value || '';
      const filterLine = document.getElementById('addon-filter-line')?.value || '';
      const filterType = document.getElementById('addon-filter-type')?.value || '';
      const filterText = (document.getElementById('addon-filter-text')?.value || '').toLowerCase();
      const filtered = Object.values(addons).filter(a => {
        if (filterModel && a.pricingModel !== filterModel) return false;

        if (filterLine) {
          if (Array.isArray(a.allowedProductLines) && a.allowedProductLines.length > 0) {
            const match = a.allowedProductLines.some(l => l.toLowerCase() === filterLine.toLowerCase());
            if (!match) return false;
          }
        }

        if (filterType) {
          if (Array.isArray(a.allowedProductTypes) && a.allowedProductTypes.length > 0) {
            const match = a.allowedProductTypes.some(t => t.toLowerCase() === filterType.toLowerCase());
            if (!match) return false;
          }
        }

        if (!filterText) return true;
        const group = a.exclusiveGroup || '';
        return a.name.toLowerCase().includes(filterText) || group.toLowerCase().includes(filterText);
      });
      document.getElementById('addon-table').innerHTML = `
        <table>
          <thead>
            <tr><th>Name</th><th>Model</th><th>Rate/Price</th><th>Exclusive Group</th><th>Mandatory</th><th>Hidden</th><th>Job Based</th><th></th></tr>
          </thead>
          <tbody>
            ${filtered.map(a => `
              <tr>
                <td>${a.name}</td>
                <td>${a.pricingModel}</td>
                <td>${a.pricingModel === 'UI' ? `$${a.uiRate}/UI` : `$${a.flatPrice}`}</td>
                <td>${a.exclusiveGroup || '-'}</td>
                <td>${a.mandatory ? '✓' : ''}</td>
                <td>${a.hiddenFromCustomer ? '✓' : ''}</td>
                <td>${a.isJobBased ? '✓' : ''}</td>
                <td>
                  <button class="btn-primary" title="Edit" aria-label="Edit" onclick="openEditModal('addon', '${a.id}')">Edit</button>
                  <button class="btn-danger" title="Delete" aria-label="Delete" onclick="deleteItem('addon', '${a.id}')">X</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    window.renderManufacturers = renderManufacturers;
    window.renderProductLines = renderProductLines;
    window.renderProducts = renderProducts;
    window.renderAddons = renderAddons;
    window.renderVersions = renderVersions;

    function renderVersions() {
      const versions = DataStorage.getPricingVersions();
      const filterName = (document.getElementById('version-filter-name')?.value || '').toLowerCase();
      const filterMonth = document.getElementById('version-filter-month')?.value;
      const filterYear = document.getElementById('version-filter-year')?.value;
      
      // Populate year dropdown with available years
      const years = [...new Set(versions.map(v => new Date(v.timestamp).getFullYear()))].sort((a, b) => b - a);
      const yearSelect = document.getElementById('version-filter-year');
      if (yearSelect && yearSelect.options.length === 1) {
        years.forEach(year => {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        });
      }
      
      const filtered = versions.filter(v => {
        if (filterName && !(v.name || v.id).toLowerCase().includes(filterName)) return false;
        
        const versionDate = new Date(v.timestamp);
        if (filterMonth) {
          const versionMonth = versionDate.toISOString().slice(0, 7);
          if (versionMonth !== filterMonth) return false;
        }
        if (filterYear) {
          if (versionDate.getFullYear().toString() !== filterYear) return false;
        }
        return true;
      });
      
      document.getElementById('version-list').innerHTML = filtered.reverse().map(v => `
        <div class="version-item">
          <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
            <div style="flex: 1;">
              <strong>${v.name || v.id}</strong>
              <div class="version-timestamp">${new Date(v.timestamp).toLocaleString()}</div>
              <div>${v.notes || '<em>No notes</em>'}</div>
            </div>
            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
              <button class="btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="loadVersion('${v.id}')">Load</button>
              <button class="btn-danger" title="Delete" aria-label="Delete" style="padding: 6px 12px; font-size: 12px;" onclick="deleteVersion('${v.id}')">X</button>
            </div>
          </div>
        </div>
      `).join('') || '<p>No versions published yet.</p>';
    }

    function renderSettings() {
      const settings = DataStorage.getGlobalSettings();
      document.getElementById('setting-minimum-ui').value = settings.minimumUI ?? 65;
      document.getElementById('setting-alerts-enabled').checked = settings.alertsEnabled !== false;
      const rules = Array.isArray(settings.rules) ? settings.rules : [];
      document.getElementById('rules-list').innerHTML = rules.length
        ? rules.map(rule => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.06);">
            <div>
              <strong>${rule.name || 'Rule'}</strong>
              <div style="font-size: 12px; color: var(--text-secondary);">Applies to ${rule.appliesTo || 'lineItem'}</div>
            </div>
          </div>
        `).join('')
        : '<p style="color: var(--text-secondary); font-size: 13px;">No rules yet.</p>';
    }

    window.addRule = (payload = {}) => {
      const name = (payload.name || '').trim();
      const appliesTo = payload.appliesTo || 'lineItem';
      const addonId = payload.addonId || '';
      if (!name || !addonId) return showAlert('Please fill all fields', 'error');

      const settings = DataStorage.getGlobalSettings();
      const rules = Array.isArray(settings.rules) ? settings.rules : [];
      const rule = { id: `rule_${Date.now()}`, name, appliesTo, addonId, enabled: true };
      rules.push(rule);
      DataStorage.updateGlobalSettings({ rules });
      renderSettings();
      showAlert('Rule added');
    };

    window.saveGlobalSettings = () => {
      const minimumUI = parseInt(document.getElementById('setting-minimum-ui').value);
      const alertsEnabled = document.getElementById('setting-alerts-enabled').checked;
      
      if (isNaN(minimumUI) || minimumUI < 0) {
        return showAlert('Minimum UI must be 0 or greater', 'error');
      }

      DataStorage.updateGlobalSettings({ minimumUI, alertsEnabled });
      showAlert('Settings saved successfully');
      renderSettings();
    };

    function populateDropdowns() {
      const manufacturers = DataStorage.getManufacturers();
      const lines = DataStorage.getProductLines();

      const mfgOptions = Object.values(manufacturers).map(m => ({ value: m.id, label: m.name }));
      const lineOptions = Object.values(lines).map(l => ({ value: l.id, label: l.name }));
      const lineNameOptions = Object.values(lines).map(l => ({ value: l.name, label: l.name }));
      const typeOptions = PRODUCT_TYPES.map(t => ({ value: t, label: t }));

      setSelectOptions('pl-filter-mfg', mfgOptions, 'All manufacturers');
      setSelectOptions('prod-filter-line', lineOptions, 'All product lines');
      setSelectOptions('prod-filter-type', typeOptions, 'All product types');
      setSelectOptions('addon-filter-line', lineNameOptions, 'All product lines');
      setSelectOptions('addon-filter-type', typeOptions, 'All product types');
    }

    // Initial render
    renderAll();
    activateTab('manufacturers');

    // Tab hover dimming effect
    const tabs = document.querySelectorAll('.admin-page .tab:not(.tab-publish)');
    
    tabs.forEach(tab => {
      tab.addEventListener('mouseenter', function() {
        tabs.forEach(otherTab => {
          if (otherTab !== tab && !otherTab.classList.contains('active')) {
            otherTab.classList.add('dimmed');
          }
        });
      });
      
      tab.addEventListener('mouseleave', function() {
        tabs.forEach(otherTab => {
          otherTab.classList.remove('dimmed');
        });
      });
    });
    
    // Also handle when leaving the entire tabs container
    const tabsContainer = document.querySelector('.admin-page .tabs');
    if (tabsContainer) {
      tabsContainer.addEventListener('mouseleave', function() {
        tabs.forEach(tab => {
          tab.classList.remove('dimmed');
        });
      });
    }
  </script>
</body>
</html>