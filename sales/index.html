<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Krasiva Windows & Doors - Sales Quote Builder</title>
  <style>
    :root {
      --gap: 0.5rem;
      --border: 1px solid rgba(0, 0, 0, 0.08);
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
      --shadow: var(--shadow-sm), var(--shadow-md);
      --bg-surface: #ffffff;
      --bg-input: #f4f4f5;
      --bg-header: #fafafa;
      --color-primary: #27272a;
      --color-danger: #dc2626;
      --color-success: #27272a;
      --text-primary: #18181b;
      --text-secondary: #71717a;
      --transition: 200ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #fafafa;
      color: var(--text-primary);
      line-height: 1.5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      background: var(--bg-surface);
      padding: 1.5rem;
      border: var(--border);
      margin-bottom: 1.5rem;
      border-radius: 8px;
      box-shadow: var(--shadow);
      position: relative;
    }
    
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 8px;
      pointer-events: none;
    }

    h1 {
      margin: 0 0 0.5rem 0;
      font-size: 1.75rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--text-primary);
    }

    .card {
      background: var(--bg-surface);
      padding: 1.5rem;
      border: var(--border);
      margin-bottom: 1.5rem;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    h2 {
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      margin-top: 0;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
      margin-bottom: 0;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 20px;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: block;
    }

    input, select {
      padding: 10px 12px;
      border: var(--border);
      border-radius: 6px;
      font-size: 14px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-input);
      color: var(--text-primary);
      transition: all var(--transition);
    }

    input:hover, select:hover {
      background: #ffffff;
      border-color: rgba(0, 0, 0, 0.12);
    }

    input:focus, select:focus {
      outline: none;
      background: #ffffff;
      border-color: rgba(0, 0, 0, 0.15);
      box-shadow: 0 0 0 3px rgba(39, 39, 42, 0.1);
    }

    button {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      transition: all var(--transition);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    button:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .btn-primary {
      background: var(--color-primary);
      color: white;
    }

    .btn-primary:hover {
      background: #3f3f46;
    }

    .btn-success {
      background: var(--color-success);
      color: white;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: var(--text-primary);
    }

    .btn-danger {
      background: var(--color-danger);
      color: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      background: var(--bg-surface);
      border-radius: 8px;
      overflow: hidden;
      border: var(--border);
      box-shadow: var(--shadow);
    }

    th, td {
      padding: 12px;
      border-bottom: var(--border);
      text-align: left;
      font-size: 13px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    th {
      background: var(--bg-header);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .quote-total {
      background: var(--bg-surface);
      border: var(--border);
      padding: 1.5rem;
      border-radius: 8px;
      text-align: center;
      box-shadow: var(--shadow);
      margin-top: 1.5rem;
    }

    .quote-total h2 {
      margin: 0 0 0.75rem 0;
      color: var(--text-secondary);
      font-size: 12px;
    }

    .quote-total .price {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .addon-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border: var(--border);
      border-radius: 6px;
      margin-bottom: 8px;
      background: var(--bg-surface);
      transition: all var(--transition);
    }

    .addon-checkbox:hover {
      background: var(--bg-input);
    }

    .addon-checkbox input {
      width: auto;
      cursor: pointer;
    }

    .alert {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 1rem;
      border: var(--border);
      font-size: 13px;
      box-shadow: var(--shadow);
    }

    .alert-error {
      background: #fef2f2;
      color: var(--text-primary);
      border: 1px solid rgba(220, 38, 38, 0.2);
    }

    .saved-quotes {
      max-height: 300px;
      overflow-y: auto;
      border: var(--border);
      border-radius: 6px;
      box-shadow: var(--shadow);
    }

    .quote-item {
      padding: 12px;
      border-bottom: var(--border);
      border-radius: 0;
      cursor: pointer;
      background: var(--bg-surface);
      transition: all var(--transition);
    }

    .quote-item:last-child {
      border-bottom: none;
    }

    .quote-item:hover {
      background: var(--bg-input);
    }

    .quote-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .quote-item-meta {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Visualizer embed */
    .window-visualizer {
      background: var(--bg-surface);
      padding: 1rem;
      border: var(--border);
      border-radius: 8px;
      box-shadow: var(--shadow);
      margin-top: 0.5rem;
    }

    .visualizer-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      align-items: start;
    }

    @media (max-width: 768px) {
      .visualizer-grid { grid-template-columns: 1fr; }
    }

    .visualizer-canvas {
      background: var(--bg-header);
      border-radius: 6px;
      padding: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 210px;
      border: var(--border);
    }

    .dimension-label {
      font-size: 11px;
      font-weight: 600;
      fill: var(--text-primary);
    }

    .window-description {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
          <h1>Krasiva Windows & Doors</h1>
          <p>Create customer quotes with live pricing calculation.</p>
        </div>
        <a href="../admin/admin_interface.html" style="padding: 10px 16px; background: #27272a; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; align-self: center; font-size: 12px; text-transform: uppercase; letter-spacing: 0.04em; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.08); transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1); display: inline-block;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.12)'; this.style.transform='translateY(-1px)';" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.08)'; this.style.transform='translateY(0)';">Admin Panel</a>
      </div>
      <div style="display: flex; gap: 8px; margin-top: 1.5rem; flex-wrap: wrap;">
        <button class="btn-secondary" onclick="showSavedQuotes()">Load Quote</button>
        <button class="btn-secondary" onclick="newQuote()">New Quote</button>
        <button class="btn-success" onclick="saveQuote()">Save Quote</button>
      </div>
    </header>

    <div id="alerts"></div>

    <div class="card">
      <h2>Quote Information</h2>
      <div class="form-row">
        <div class="form-group">
          <label>Quote ID</label>
          <input type="text" id="quote-id" readonly>
        </div>
        <div class="form-group">
          <label>Customer Name</label>
          <input type="text" id="customer-name" placeholder="Enter customer name">
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Add Item</h2>
      
      <div class="form-row">
        <div class="form-group">
          <label>Room Location</label>
          <input type="text" id="room-label" placeholder="e.g., Master Bedroom, Living Room">
        </div>
        <div class="form-group">
          <label>Product Line</label>
          <select id="product-line" onchange="updateProductOptions()">
            <option value="">Select product line...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Product</label>
          <select id="product" onchange="updateProductInfo()">
            <option value="">Select product...</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Width (inches)</label>
          <input type="number" id="width" step="0.125" placeholder="36">
        </div>
        <div class="form-group">
          <label>Height (inches)</label>
          <input type="number" id="height" step="0.125" placeholder="60">
        </div>
        <div class="form-group">
          <label>Total UI</label>
          <input type="number" id="total-ui" step="1" placeholder="96" readonly>
        </div>
      </div>

      <div class="window-visualizer">
        <div class="visualizer-grid">
          <div style="display: flex; flex-direction: column; gap: 0.75rem; justify-content: flex-start;">
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
              <button class="btn-secondary" type="button" onclick="openAddonModal()">+ Add-Ons</button>
              <button class="btn-secondary" type="button" onclick="toggleStructural()" id="structural-toggle">⧉ Structural</button>
              <button class="btn-secondary" type="button" onclick="toggleExtras()" id="extras-toggle">Show Notes</button>
            </div>

            <div id="structural-section" style="display: none; margin-top: 0.25rem;">
              <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; display: block;">Structural / Mulling</label>
              <select id="mull-type" style="margin-top: 4px;">
                <option value="">None</option>
                <option value="left">Left</option>
                <option value="right">Right</option>
                <option value="center">Center</option>
                <option value="above">Above</option>
                <option value="below">Below</option>
              </select>
            </div>

            <div id="extras-section" style="display: none; margin-top: 0.25rem;">
              <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; display: block;">Notes / Site Adjustments</label>
              <textarea id="extra-notes" rows="3" style="width: 100%; padding: 10px 12px; border: var(--border); border-radius: 6px; background: var(--bg-input); font-size: 13px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; resize: vertical;"></textarea>
            </div>

            <div id="addons-section" style="display: none; margin: 0;">
              <div id="addons-list" style="display: none;"></div>
            </div>
          </div>
          <div>
            <div class="visualizer-canvas">
              <div id="viz-svg-container"></div>
            </div>
          </div>
        </div>
      </div>

      <button class="btn-primary" onclick="addLineItem()">+ Add Item</button>
    </div>

    <div class="card">
      <h2>Quote Line Items</h2>
      <div id="line-items-table"></div>
    </div>

    <div class="card">
      <h2>Job Addons</h2>
      <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 1rem;">Apply to the entire job</p>
      <div id="job-addons-section"></div>
    </div>

    <div class="card">
      <div class="form-row">
        <div class="form-group">
          <label>Sales Commission / Uplift ($)</label>
          <input type="number" id="sales-uplift" value="0" step="0.01" onchange="calculateQuoteTotal()">
        </div>
      </div>
    </div>

    <div class="quote-total">
      <h2>Customer Price</h2>
      <div class="price" id="final-price">$0.00</div>
      <button class="btn-success" style="margin-top: 1rem;" onclick="generateQuoteDocument()">Generate Quote Document</button>
    </div>
  </div>

  <script type="module">
    import { PricingEngine } from '../pricing_engine.js';
    import { DataStorage } from '../data_storage.js';

    // Initialize
    DataStorage.initializeSampleData();
    
    let currentQuote = {
      id: `quote_${Date.now()}`,
      customerName: '',
      lineItems: [],
      salesUplift: 0,
      selectedJobAddonIds: []
    };

    // Visualizer state
    let vizWidth = 36;
    let vizHeight = 60;
    let vizWindowType = 'single';
    const vizScale = 5; // pixels per inch
    const vizDescriptions = {
      single: 'Bottom sash slides up',
      double: 'Both sashes slide vertically',
      slider: 'Left panel slides right',
      casement: 'Swings out from left hinge',
      awning: 'Tilts out from top hinge',
      fixed: 'No opening mechanism'
    };

    window.showAlert = (message, type = 'error') => {
      const alerts = document.getElementById('alerts');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alerts.appendChild(alert);
      setTimeout(() => alert.remove(), 5000);
    };

    // Generic modal function (copied from admin_interface.html for consistent UX)
    window.showModal = (title, content, buttons = []) => {
      const modalId = `modal-${Date.now()}`;
      let buttonHtml = '';
      if (buttons.length === 0) {
        buttonHtml = `<button class="btn-secondary" onclick="document.getElementById('${modalId}').remove()">Close</button>`;
      } else {
        buttonHtml = buttons.map((btn, idx) => {
          const btnClass = btn.type === 'primary' ? 'btn-primary' : btn.type === 'danger' ? 'btn-danger' : 'btn-secondary';
          const btnId = `btn-${modalId}-${idx}`;
          return `<button id="${btnId}" class="${btnClass}">${btn.label}</button>`;
        }).join('');
      }

      const html = `<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.35); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);" id="${modalId}" onclick="if(event.target.id === '${modalId}') this.remove()">
        <div style="background: white; padding: 1.5rem; border-radius: 8px; max-width: 500px; width: 90%; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); max-height: 80vh; overflow-y: auto;">
          <h2 style="margin-top: 0; margin-bottom: 1rem;">${title}</h2>
          <div id="modal-content-${Date.now()}">${content}</div>
          <div style="display: flex; gap: 8px; margin-top: 1.5rem;">
            ${buttonHtml}
          </div>
        </div>
      </div>`;
      document.body.insertAdjacentHTML('beforeend', html);

      // Attach click handlers (scope lookup to the created modal element)
      const modalElem = document.getElementById(modalId);
      buttons.forEach((btn, idx) => {
        const btnId = `btn-${modalId}-${idx}`;
        const btnElement = modalElem ? modalElem.querySelector(`#${btnId}`) : document.getElementById(btnId);
        console.log('Attaching modal button', btnId, 'found=', !!btnElement);
        if (btnElement && btn.onclick) {
          btnElement.onclick = (e) => {
            e.preventDefault();
            const modal = document.getElementById(modalId);
            if (modal) modal.remove();
            try {
              if (typeof btn.onclick === 'function') {
                btn.onclick();
              } else {
                eval(btn.onclick);
              }
            } catch (err) {
              console.error('Modal button handler error', err);
            }
          };
        }
      });

      return modalId;
    };

    // Confirm before leaving sales page (save prompt)
    window.confirmLeaveAdmin = (event, targetUrl = null) => {
      if (event && event.preventDefault) event.preventDefault();

      // Derive targetUrl from clicked anchor if not provided
      if (!targetUrl && event) {
        const a = event.currentTarget || (event.target && event.target.closest && event.target.closest('a'));
        targetUrl = a ? a.getAttribute('href') : null;
      }

      const hasUnsaved = (currentQuote.lineItems && currentQuote.lineItems.length > 0) || (document.getElementById('customer-name').value.trim() !== '') || ((parseFloat(document.getElementById('sales-uplift').value) || 0) !== 0);
      if (!hasUnsaved) {
        if (targetUrl) window.location.href = targetUrl;
        return;
      }

      showModal('Leave Sales Page?', '<p>Do you want to save the current quote before leaving the sales page?</p>', [
        { label: 'Save & Leave', type: 'primary', onclick: () => { window._suppressBeforeUnload = true; saveQuote(); if (targetUrl) window.location.href = targetUrl; } },
        { label: 'Leave Without Saving', type: 'danger', onclick: () => { window._suppressBeforeUnload = true; if (targetUrl) window.location.href = targetUrl; } },
        { label: 'Cancel', type: 'secondary', onclick: () => { window._suppressBeforeUnload = false; } }
      ]);
    };

    // Prompt using native dialog on reload/close/navigation events
    window._suppressBeforeUnload = window._suppressBeforeUnload || false;
    window.addEventListener('beforeunload', (e) => {
      if (window._suppressBeforeUnload) return undefined;
      const hasUnsaved = (currentQuote.lineItems && currentQuote.lineItems.length > 0) || (document.getElementById('customer-name').value.trim() !== '') || ((parseFloat(document.getElementById('sales-uplift').value) || 0) !== 0);
      if (hasUnsaved) {
        e.preventDefault();
        e.returnValue = '';
        return '';
      }
      return undefined;
    });

    // Visualizer helpers
    function buildVisualizerSvgString(widthVal, heightVal, type = 'single', maxDim = 240) {
      const scaledWidth = widthVal * vizScale;
      const scaledHeight = heightVal * vizScale;
      const maxWidth = maxDim;
      const maxHeight = maxDim;

      let displayScale = 1;
      if (scaledWidth > maxWidth || scaledHeight > maxHeight) {
        const widthScale = maxWidth / scaledWidth;
        const heightScale = maxHeight / scaledHeight;
        displayScale = Math.min(widthScale, heightScale);
      }

      const displayWidth = scaledWidth * displayScale;
      const displayHeight = scaledHeight * displayScale;
      const svgWidth = displayWidth + 60;
      const svgHeight = displayHeight + 60;

      const halfHeight = displayHeight / 2;
      const halfWidth = displayWidth / 2;

      const typeMarkup = (() => {
        switch (type) {
          case 'single':
          case 'double':
            return `
              <line x1="30" y1="${30 + halfHeight}" x2="${30 + displayWidth}" y2="${30 + halfHeight}"
                    stroke="black" stroke-width="3" />
            `;
          case 'slider':
            return `
              <line x1="${30 + halfWidth}" y1="30" x2="${30 + halfWidth}" y2="${30 + displayHeight}"
                    stroke="black" stroke-width="3" />
            `;
          case 'casement':
            return `
              <line x1="30" y1="30" x2="30" y2="${30 + displayHeight}"
                    stroke="black" stroke-width="4" />
            `;
          case 'awning':
            return `
              <line x1="30" y1="30" x2="${30 + displayWidth}" y2="30"
                    stroke="black" stroke-width="4" />
            `;
          case 'fixed':
            return `
              <line x1="30" y1="${30 + halfHeight}" x2="${30 + displayWidth}" y2="${30 + halfHeight}"
                    stroke="black" stroke-width="2" stroke-dasharray="5,5" />
              <line x1="${30 + halfWidth}" y1="30" x2="${30 + halfWidth}" y2="${30 + displayHeight}"
                    stroke="black" stroke-width="2" stroke-dasharray="5,5" />
            `;
          default:
            return '';
        }
      })();

      return `
        <svg width="${svgWidth}" height="${svgHeight}" viewBox="0 0 ${svgWidth} ${svgHeight}">
          <defs>
            <marker id="vizArrowStart" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
              <polygon points="8,5 2,2 2,8" fill="#666" />
            </marker>
            <marker id="vizArrowEnd" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
              <polygon points="2,5 8,2 8,8" fill="#666" />
            </marker>
          </defs>

          <line x1="30" y1="15" x2="${displayWidth + 30}" y2="15"
                stroke="#666" stroke-width="1"
                marker-start="url(#vizArrowStart)" marker-end="url(#vizArrowEnd)" />
          <text x="${displayWidth / 2 + 30}" y="10"
                text-anchor="middle" class="dimension-label">${widthVal}"</text>

          <line x1="15" y1="30" x2="15" y2="${displayHeight + 30}"
                stroke="#666" stroke-width="1"
                marker-start="url(#vizArrowStart)" marker-end="url(#vizArrowEnd)" />
          <text x="10" y="${displayHeight / 2 + 30}"
                text-anchor="middle" class="dimension-label"
                transform="rotate(-90, 10, ${displayHeight / 2 + 30})">${heightVal}"</text>

          <rect x="30" y="30" width="${displayWidth}" height="${displayHeight}"
                fill="white" stroke="black" stroke-width="4" />

          ${typeMarkup}

          <g opacity="0.3">
            <line x1="34" y1="34" x2="${26 + displayWidth}" y2="${26 + displayHeight}" stroke="lightblue" stroke-width="1" />
            <line x1="${26 + displayWidth}" y1="34" x2="34" y2="${26 + displayHeight}" stroke="lightblue" stroke-width="1" />
          </g>
        </svg>
      `;
    }

    function renderVisualizer() {
      const svgContainer = document.getElementById('viz-svg-container');
      if (!svgContainer) return;
      const svg = buildVisualizerSvgString(vizWidth, vizHeight, vizWindowType, 240);
      svgContainer.innerHTML = svg;
    }

    function syncVisualizerFromInputs() {
      const widthField = document.getElementById('width');
      const heightField = document.getElementById('height');
      vizWidth = parseFloat(widthField.value) || vizWidth || 36;
      vizHeight = parseFloat(heightField.value) || vizHeight || 60;
      renderVisualizer();
    }

    function svgToDataUrl(svgString) {
      return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));
    }

    function buildAddonModalList() {
      const sourceNodes = Array.from(document.querySelectorAll('#addons-list .addon-checkbox'));
      if (sourceNodes.length === 0) return '<p style="margin:0; color: var(--text-secondary); font-size: 13px;">No addons available for this product.</p>';
      return sourceNodes.map(node => {
        const input = node.querySelector('input');
        const label = node.querySelector('label');
        const checked = input && input.checked ? 'checked' : '';
        const id = input ? input.id : '';
        const value = input ? input.value : '';
        const text = label ? label.innerHTML : '';
        const dataLabel = node.dataset.label || '';
        return `
          <div class="addon-checkbox" data-label="${dataLabel}">
            <input type="checkbox" id="modal-${id}" data-sync-id="${id}" value="${value}" ${checked}>
            <label for="modal-${id}" style="margin: 0; flex: 1; font-weight: 500; text-transform: none;">${text}</label>
          </div>
        `;
      }).join('');
    }

    function openAddonModal() {
      const modalHtml = `
        <div style="display:flex; flex-direction:column; gap:12px; max-height:60vh;">
          <input type="text" id="addon-search" placeholder="Search addons..." style="padding:10px 12px; border: var(--border); border-radius:6px; font-size:14px; background: var(--bg-input);">
          <div id="addon-modal-list" style="max-height:48vh; overflow-y:auto; border: var(--border); border-radius:6px; padding:8px; background: var(--bg-surface);">
            ${buildAddonModalList()}
          </div>
        </div>
      `;

      const modalId = showModal('Select Addons', modalHtml, [
        { label: 'Done', type: 'primary', onclick: () => {} }
      ]);

      // Wire syncing and filtering once modal is in DOM
      setTimeout(() => {
        const modalEl = document.getElementById(modalId);
        if (!modalEl) return;
        const modalList = modalEl.querySelector('#addon-modal-list');
        const searchInput = modalEl.querySelector('#addon-search');

        // Sync checkboxes back to hidden list
        modalList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.addEventListener('change', () => {
            const targetId = cb.dataset.syncId;
            const original = document.getElementById(targetId);
            if (original) {
              original.checked = cb.checked;
            }
          });
        });

        // Filter by label text
        if (searchInput) {
          searchInput.addEventListener('input', () => {
            const term = searchInput.value.trim().toLowerCase();
            modalList.querySelectorAll('.addon-checkbox').forEach(item => {
              const label = item.dataset.label || '';
              item.style.display = term === '' || label.includes(term) ? 'flex' : 'none';
            });
          });
        }
      }, 0);
    }

    function toggleExtras() {
      const extras = document.getElementById('extras-section');
      const toggle = document.getElementById('extras-toggle');
      if (!extras || !toggle) return;
      const isHidden = extras.style.display === 'none' || extras.style.display === '';
      extras.style.display = isHidden ? 'block' : 'none';
      toggle.textContent = isHidden ? 'Hide Notes' : 'Show Notes';
    }

    function toggleStructural() {
      const structural = document.getElementById('structural-section');
      const toggle = document.getElementById('structural-toggle');
      if (!structural || !toggle) return;
      const isHidden = structural.style.display === 'none' || structural.style.display === '';
      structural.style.display = isHidden ? 'block' : 'none';
      toggle.textContent = isHidden ? '⧉ Structural (Shown)' : '⧉ Structural';
    }

    // Expose UI toggles to inline handlers
    window.openAddonModal = openAddonModal;
    window.toggleExtras = toggleExtras;
    window.toggleStructural = toggleStructural;

    function deriveVisualizerType(product) {
      if (!product) return vizWindowType;
      const productLines = DataStorage.getProductLines();
      const line = productLines[product.productLineId];
      const code = (product.productTypeCode || '').toUpperCase();
      const name = (product.name || '').toUpperCase();
      const lineName = (line && line.name ? line.name : '').toUpperCase();
      const haystack = `${code} ${name} ${lineName}`;

      const contains = (s) => haystack.includes(s);

      if (contains('SLIDER') || code === 'SL' || code.startsWith('SL')) return 'slider';
      if (contains('DOUBLE') || code === 'DH' || code.startsWith('DH')) return 'double';
      if (contains('SINGLE') || code === 'SH' || code.startsWith('SH')) return 'single';
      if (contains('CASE') || contains('CAS') || code === 'CS' || code.startsWith('CA')) return 'casement';
      if (contains('AWNING') || code === 'AW' || code.startsWith('AW')) return 'awning';
      if (contains('PICTURE') || contains('FIX') || contains('FX') || code === 'PW' || code === 'FX') return 'fixed';
      if (contains('BAY') || contains('BOW')) return 'fixed';

      return vizWindowType;
    }

    // Intercept anchor clicks to present the save modal for in-app navigation
    document.addEventListener('click', (e) => {
      const a = e.target && e.target.closest ? e.target.closest('a') : null;
      if (!a) return;

      // If the anchor already has an inline onclick handler, skip interception to avoid duplicates
      if (a.hasAttribute && a.hasAttribute('onclick')) return;

      const href = a.getAttribute('href');
      if (!href) return;

      // Ignore anchors that are purely hash/navigation within page or explicitly opted-out
      if (href.startsWith('#') || href.startsWith('javascript:') || a.target === '_blank' || (a.dataset && a.dataset.noPrompt === 'true')) return;

      // Intercept navigation and show modal
      e.preventDefault();
      confirmLeaveAdmin(e, href);
    });

    window.newQuote = () => {
      if (currentQuote.lineItems.length > 0) {
        if (!confirm('Start a new quote? Current quote will be lost if not saved.')) return;
      }
      currentQuote = {
        id: `quote_${Date.now()}`,
        customerName: '',
        lineItems: [],
        salesUplift: 0,
        selectedJobAddonIds: []
      };
      document.getElementById('customer-name').value = '';
      document.getElementById('sales-uplift').value = '0';
      updateQuoteDisplay();
    };

    window.saveQuote = () => {
      const customerName = document.getElementById('customer-name').value.trim();
      if (!customerName) {
        return showAlert('Please enter customer name');
      }
      if (currentQuote.lineItems.length === 0) {
        return showAlert('Quote must have at least one line item');
      }

      currentQuote.customerName = customerName;
      currentQuote.salesUplift = parseFloat(document.getElementById('sales-uplift').value) || 0;

      try {
        // Calculate totals with selected job addons
        const allAddons = DataStorage.getAddons();
        const jobBasedAddons = currentQuote.selectedJobAddonIds.map(addonId => {
          const addon = allAddons[addonId];
          if (!addon) return null;
          
          let price = 0;
          if (addon.pricingModel === 'UI') {
            const totalUI = currentQuote.lineItems.reduce((sum, item) => sum + item.ui, 0);
            price = totalUI * addon.uiRate;
          } else {
            price = addon.flatPrice || 0;
          }
          
          return { id: addonId, name: addon.name, price };
        }).filter(a => a !== null);
        
        const quoteCalc = PricingEngine.calculateQuote({
          lineItems: currentQuote.lineItems,
          jobBasedAddons,
          salesUplift: currentQuote.salesUplift
        });

        // Create version
        const version = PricingEngine.createQuoteVersion({
          quoteId: currentQuote.id,
          lineItems: currentQuote.lineItems,
          jobBasedAddons,
          salesUplift: currentQuote.salesUplift,
          metadata: {
            customerName: currentQuote.customerName,
            ...quoteCalc
          }
        });

        // Save quote and version
        DataStorage.saveQuote(currentQuote);
        DataStorage.saveQuoteVersion(version);

        showAlert('Quote saved successfully!', 'success');
      } catch (error) {
        showAlert(error.message);
      }
    };

    window.showSavedQuotes = () => {
      const quotes = DataStorage.get(DataStorage.KEYS.QUOTES, {});
      const quoteList = Object.values(quotes);

      if (quoteList.length === 0) {
        return showAlert('No saved quotes found');
      }

      const html = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.35); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);" onclick="if(event.target === this) this.remove()">
          <div style="background: white; padding: 1.5rem; border-radius: 8px; max-width: 600px; width: 90%; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
            <h2 style="margin-top: 0; font-size: 1rem; font-weight: 600; letter-spacing: -0.01em; color: #18181b;">Load Quote</h2>
            <div class="saved-quotes">
              ${quoteList.map(q => {
                const versions = DataStorage.getQuoteVersions(q.id);
                const latestVersion = versions[versions.length - 1];
                return `
                  <div class="quote-item" onclick="loadQuote('${q.id}')">
                    <div class="quote-item-header">
                      <strong>${q.customerName || 'Unnamed Quote'}</strong>
                      <span>${latestVersion ? `$${latestVersion.finalPrice.toFixed(2)}` : ''}</span>
                    </div>
                    <div class="quote-item-meta">
                      ${q.id} • ${q.lineItems.length} items • ${versions.length} version(s)
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
            <button class="btn-secondary" style="margin-top: 1rem;" onclick="this.closest('div[style*=fixed]').remove()">Close</button>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
    };

    window.loadQuote = (quoteId) => {
      const quotes = DataStorage.get(DataStorage.KEYS.QUOTES, {});
      const quote = quotes[quoteId];
      if (!quote) return;

      currentQuote = JSON.parse(JSON.stringify(quote)); // Deep clone
      
      // Ensure mandatory job addons are included
      const allAddons = DataStorage.getAddons();
      const mandatoryJobAddonIds = Object.entries(allAddons)
        .filter(([id, addon]) => addon.isJobBased && addon.mandatory)
        .map(([id]) => id);
      currentQuote.selectedJobAddonIds = [...new Set([...(currentQuote.selectedJobAddonIds || []), ...mandatoryJobAddonIds])];
      
      document.getElementById('customer-name').value = quote.customerName;
      document.getElementById('sales-uplift').value = quote.salesUplift || 0;
      
      updateQuoteDisplay();
      document.querySelector('div[style*=fixed]')?.remove();
    };

    window.renderJobAddons = () => {
      const allAddons = DataStorage.getAddons();
      const jobAddons = Object.entries(allAddons)
        .filter(([id, addon]) => addon.isJobBased)
        .map(([id, addon]) => ({ id, ...addon }));

      // Ensure mandatory job addons are always selected
      const mandatoryJobAddonIds = jobAddons
        .filter(addon => addon.mandatory)
        .map(addon => addon.id);
      
      currentQuote.selectedJobAddonIds = [
        ...new Set([...currentQuote.selectedJobAddonIds, ...mandatoryJobAddonIds])
      ];

      if (jobAddons.length === 0) {
        document.getElementById('job-addons-section').innerHTML = '<p style="color: var(--text-secondary); font-size: 13px;">No job addons available</p>';
        return;
      }

      const addonHtml = jobAddons.map(addon => {
        const isSelected = currentQuote.selectedJobAddonIds.includes(addon.id);
        const isChecked = addon.mandatory || isSelected;
        const price = addon.pricingModel === 'UI' 
          ? '(UI-Based)' 
          : `$${addon.flatPrice.toFixed(2)}`;
        
        return `
          <div class="addon-checkbox">
            <input type="checkbox" id="job-addon-${addon.id}" class="job-addon" value="${addon.id}" ${isChecked ? 'checked' : ''} ${addon.mandatory ? 'disabled' : ''} onchange="updateJobAddonSelection()">
            <label for="job-addon-${addon.id}" style="margin: 0; flex: 1; font-weight: 500; text-transform: none;">
              ${addon.name} 
              <span style="color: var(--text-secondary); font-size: 12px;">${price}</span>
              ${addon.mandatory ? '<span style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: 600; margin-left: 8px;">MANDATORY</span>' : ''}
            </label>
          </div>
        `;
      }).join('');
      
      document.getElementById('job-addons-section').innerHTML = addonHtml;
    };

    window.updateJobAddonSelection = () => {
      currentQuote.selectedJobAddonIds = Array.from(document.querySelectorAll('.job-addon:checked'))
        .map(checkbox => checkbox.value);
      
      // Always include mandatory addons
      const allAddons = DataStorage.getAddons();
      const mandatoryJobAddonIds = Object.entries(allAddons)
        .filter(([id, addon]) => addon.isJobBased && addon.mandatory)
        .map(([id]) => id);
      
      currentQuote.selectedJobAddonIds = [...new Set([...currentQuote.selectedJobAddonIds, ...mandatoryJobAddonIds])];
      
      // Recalculate the quote total
      calculateQuoteTotal();
    };
    window.updateProductLineOptions = () => {
      const productLines = DataStorage.getProductLines();
      
      document.getElementById('product-line').innerHTML = 
        '<option value="">Select product line...</option>' +
        Object.values(productLines).map(pl => `<option value="${pl.id}">${pl.name}</option>`).join('');
      
      updateProductOptions();
    };

    window.updateProductOptions = () => {
      const productLineId = document.getElementById('product-line').value;
      const products = DataStorage.getProducts();
      const filtered = Object.values(products).filter(p => p.productLineId === productLineId);

      document.getElementById('product').innerHTML = 
        '<option value="">Select product...</option>' +
        filtered.map(p => `<option value="${p.id}">${p.productTypeCode} - ${p.name}</option>`).join('');
      
      updateProductInfo();
    };

    window.updateProductInfo = () => {
      const productId = document.getElementById('product').value;
      if (!productId) {
        document.getElementById('total-ui').value = '';
        document.getElementById('addons-section').style.display = 'none';
        return;
      }

      const products = DataStorage.getProducts();
      const product = products[productId];
      const allAddons = DataStorage.getAddons();

      // Auto-map visualizer type based on product
      const derivedViz = deriveVisualizerType(product);
      if (derivedViz && derivedViz !== vizWindowType) {
        vizWindowType = derivedViz;
        renderVisualizer();
      }
      
      // Calculate total UI from width + height
      const width = parseFloat(document.getElementById('width').value) || 0;
      const height = parseFloat(document.getElementById('height').value) || 0;
      const ui = Math.ceil(width + height);
      
      document.getElementById('total-ui').value = ui || '';
      
      // Get available addons for this product, excluding job-based addons
      const availableAddonIds = PricingEngine.getAvailableAddonsForProduct(product, ui, allAddons)
        .filter(addonId => !allAddons[addonId].isJobBased);
      
      if (availableAddonIds.length === 0) {
        document.getElementById('addons-section').style.display = 'none';
        return;
      }
      
      // Build addon checkboxes (kept hidden; surfaced via modal)
      const addonHtml = availableAddonIds.map(addonId => {
        const addon = allAddons[addonId];
        const price = addon.pricingModel === 'UI' 
          ? `$${(ui * addon.uiRate).toFixed(2)}` 
          : `$${addon.flatPrice.toFixed(2)}`;
        
        return `
          <div class="addon-checkbox" data-label="${addon.name.toLowerCase()}">
            <input type="checkbox" id="addon-${addonId}" class="product-addon" value="${addonId}">
            <label for="addon-${addonId}" style="margin: 0; flex: 1; font-weight: 500; text-transform: none;">
              ${addon.name} <span style="color: var(--text-secondary); font-size: 12px;">${price}</span>
            </label>
          </div>
        `;
      }).join('');
      
      document.getElementById('addons-list').innerHTML = addonHtml;
      document.getElementById('addons-section').style.display = 'block';
    };

    window.addLineItem = () => {
      const roomLabel = document.getElementById('room-label').value.trim();
      const productId = document.getElementById('product').value;
      const width = parseFloat(document.getElementById('width').value);
      const height = parseFloat(document.getElementById('height').value);
      const mullType = document.getElementById('mull-type').value;

      if (!roomLabel || !productId || !width || !height) {
        return showAlert('Please fill all required fields');
      }

      const products = DataStorage.getProducts();
      const product = products[productId];
      const globalSettings = DataStorage.getGlobalSettings();
      const allAddons = DataStorage.getAddons();

      // Get selected addons
      const selectedAddonIds = Array.from(document.querySelectorAll('.product-addon:checked'))
        .map(checkbox => checkbox.value);

      try {
        // Calculate UI
        const ui = Math.ceil(width + height);
        
        // Validate against global minimum UI
        if (ui < globalSettings.minimumUI) {
          return showAlert(`Total UI (${ui}) must be at least ${globalSettings.minimumUI} inches`);
        }

        // Validate size limits if product has them
        const validation = PricingEngine.validateSize({ product, width, height });
        if (!validation.valid) {
          return showAlert(validation.errors.join(', '));
        }

        // Calculate line item with selected addons
        const lineItemCalc = PricingEngine.calculateLineItem({
          product,
          width,
          height,
          selectedAddonIds,
          allAddons
        });

        // Capture a downsized visualizer snapshot for the line item
        const vizSvg = buildVisualizerSvgString(width, height, vizWindowType, 160);
        const vizDataUrl = svgToDataUrl(vizSvg);

        // Add to quote
        currentQuote.lineItems.push({
          id: `item_${Date.now()}`,
          productId,
          roomLabel,
          width,
          height,
          ui,
          mullType,
          vizType: vizWindowType,
          vizDataUrl,
          ...lineItemCalc
        });

        // Reset form
        document.getElementById('room-label').value = '';
        document.getElementById('product-line').value = '';
        document.getElementById('product').value = '';
        document.getElementById('width').value = '';
        document.getElementById('height').value = '';
        document.getElementById('total-ui').value = '';
        document.getElementById('mull-type').value = '';
        document.getElementById('extra-notes').value = '';
        document.getElementById('extras-section').style.display = 'none';
        document.getElementById('extras-toggle').textContent = 'Show Notes';
        const structuralSection = document.getElementById('structural-section');
        if (structuralSection) structuralSection.style.display = 'none';
        const structuralToggle = document.getElementById('structural-toggle');
        if (structuralToggle) structuralToggle.textContent = '⧉ Structural';
        document.getElementById('addons-list').innerHTML = '';
        document.getElementById('addons-section').style.display = 'none';

        updateQuoteDisplay();
      } catch (error) {
        showAlert(error.message);
      }
    };

    window.removeLineItem = (index) => {
      currentQuote.lineItems.splice(index, 1);
      updateQuoteDisplay();
    };

    window.calculateQuoteTotal = () => {
      updateQuoteDisplay();
    };

    function updateQuoteDisplay() {
      document.getElementById('quote-id').value = currentQuote.id;

      // Render job addons section
      renderJobAddons();

      // Render line items table
      if (currentQuote.lineItems.length === 0) {
        document.getElementById('line-items-table').innerHTML = '<p>No items added yet.</p>';
      } else {
        const products = DataStorage.getProducts();
        
        const html = `
          <table>
            <thead>
              <tr>
                <th style="width:48px;">#</th>
                <th>Room</th>
                <th>Product</th>
                <th>Size</th>
                <th>UI</th>
                <th>Preview</th>
                <th>Mulling</th>
                <th>Addons</th>
                <th>Price</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${currentQuote.lineItems.map((item, index) => {
                const product = products[item.productId];
                const productName = product ? product.name : 'Unknown';
                const productCode = product ? product.productTypeCode : 'N/A';
                const mullLabel = {
                  'left': 'Left',
                  'right': 'Right',
                  'center': 'Center',
                  'above': 'Above',
                  'below': 'Below'
                };
                const mullText = item.mullType ? (mullLabel[item.mullType] || item.mullType) : 'None';
                
                // Display only visible addons
                const visibleAddons = item.appliedAddons.filter(a => !a.hidden);
                const addonsText = visibleAddons.length > 0 
                  ? visibleAddons.map(a => a.name).join(', ')
                  : 'None';
                const previewImg = item.vizDataUrl ? `<img src="${item.vizDataUrl}" alt="Preview" style="width: 120px; max-width: 120px; height: auto; display: block; border: 1px solid rgba(0,0,0,0.08); border-radius: 4px; background: #fafafa;">` : '<span style="color: #9ca3af; font-size: 11px;">No preview</span>';
                
                return `
                  <tr>
                    <td>${index + 1}</td>
                    <td>${item.roomLabel}</td>
                    <td>${productCode} - ${productName}</td>
                    <td>${item.width}" × ${item.height}"</td>
                    <td>${item.ui}</td>
                    <td>${previewImg}</td>
                    <td>${mullText}</td>
                    <td><small>${addonsText}</small></td>
                    <td>$${item.lineItemParTotal.toFixed(2)}</td>
                    <td><button class="btn-danger" onclick="removeLineItem(${index})">Remove</button></td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
        document.getElementById('line-items-table').innerHTML = html;
      }

      // Calculate total with job addons (always, even with no line items)
      try {
        const salesUplift = parseFloat(document.getElementById('sales-uplift').value) || 0;
        const allAddons = DataStorage.getAddons();
        
        // Build job-based addons with their calculated prices
        const jobBasedAddons = currentQuote.selectedJobAddonIds.map(addonId => {
          const addon = allAddons[addonId];
          if (!addon) return null;
          
          let price = 0;
          if (addon.pricingModel === 'UI') {
            // For UI-based job addons, calculate based on total UI of all items
            const totalUI = currentQuote.lineItems.reduce((sum, item) => sum + item.ui, 0);
            price = totalUI * addon.uiRate;
          } else {
            price = addon.flatPrice || 0;
          }
          
          return { id: addonId, name: addon.name, price };
        }).filter(a => a !== null);
        
        const quoteCalc = PricingEngine.calculateQuote({
          lineItems: currentQuote.lineItems,
          jobBasedAddons,
          salesUplift
        });
        document.getElementById('final-price').textContent = `$${quoteCalc.finalPrice.toFixed(2)}`;
      } catch (error) {
        showAlert(error.message);
      }
    }

    window.generateQuoteDocument = () => {
      const customerName = document.getElementById('customer-name').value.trim();
      if (!customerName) {
        return showAlert('Please enter customer name');
      }

      try {
        const salesUplift = parseFloat(document.getElementById('sales-uplift').value) || 0;
        const allAddons = DataStorage.getAddons();
        
        const jobBasedAddons = currentQuote.selectedJobAddonIds.map(addonId => {
          const addon = allAddons[addonId];
          if (!addon) return null;
          
          let price = 0;
          if (addon.pricingModel === 'UI') {
            const totalUI = currentQuote.lineItems.reduce((sum, item) => sum + item.ui, 0);
            price = totalUI * addon.uiRate;
          } else {
            price = addon.flatPrice || 0;
          }
          
          return { id: addonId, name: addon.name, price };
        }).filter(a => a !== null);
        
        const quoteCalc = PricingEngine.calculateQuote({
          lineItems: currentQuote.lineItems,
          jobBasedAddons,
          salesUplift
        });

        // Generate simple text quote
        let doc = `QUOTE: ${currentQuote.id}\n`;
        doc += `Customer: ${customerName}\n`;
        doc += `Date: ${new Date().toLocaleDateString()}\n\n`;
        doc += `LINE ITEMS:\n`;
        doc += `${'='.repeat(80)}\n`;

        const products = DataStorage.getProducts();
        currentQuote.lineItems.forEach((item, index) => {
          const product = products[item.productId];
          const productName = product ? product.name : 'Unknown';
          const productCode = product ? product.productTypeCode : 'N/A';
          
          doc += `${index + 1}. [${item.roomLabel}] ${productCode} - ${productName}\n`;
          doc += `   Size: ${item.width}" × ${item.height}" (${item.ui} UI)\n`;
          
          if (item.mullType) {
            const mullLabel = {
              'left': 'Left',
              'right': 'Right',
              'center': 'Center',
              'above': 'Above',
              'below': 'Below'
            };
            doc += `   Mulling: ${mullLabel[item.mullType] || item.mullType}\n`;
          }
          
          const visibleAddons = item.appliedAddons.filter(a => !a.hidden);
          if (visibleAddons.length > 0) {
            doc += `   Options: ${visibleAddons.map(a => a.name).join(', ')}\n`;
          }
          doc += `   Price: $${item.lineItemParTotal.toFixed(2)}\n\n`;
        });

        if (jobBasedAddons.length > 0) {
          doc += `${'='.repeat(80)}\n`;
          doc += `JOB ADDONS:\n`;
          jobBasedAddons.forEach(addon => {
            doc += `  - ${addon.name}: $${addon.price.toFixed(2)}\n`;
          });
        }

        doc += `${'='.repeat(60)}\n`;
        doc += `TOTAL: $${quoteCalc.finalPrice.toFixed(2)}\n`;

        // Download as text file
        const blob = new Blob([doc], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `quote-${currentQuote.id}.txt`;
        a.click();
      } catch (error) {
        showAlert(error.message);
      }
    };

    // Initialize
    function init() {
      // Debug: Check what data we have
      const productLines = DataStorage.getProductLines();
      const products = DataStorage.getProducts();
      console.log('Product Lines:', productLines);
      console.log('Products:', products);

      // Initialize mandatory job addons
      const allAddons = DataStorage.getAddons();
      const mandatoryJobAddonIds = Object.entries(allAddons)
        .filter(([id, addon]) => addon.isJobBased && addon.mandatory)
        .map(([id]) => id);
      currentQuote.selectedJobAddonIds = [...new Set([...currentQuote.selectedJobAddonIds, ...mandatoryJobAddonIds])];

      // Populate product lines
      updateProductLineOptions();
      
      // Add event listeners to width/height to update UI
      const widthField = document.getElementById('width');
      const heightField = document.getElementById('height');
      widthField.addEventListener('input', () => { updateProductInfo(); syncVisualizerFromInputs(); });
      heightField.addEventListener('input', () => { updateProductInfo(); syncVisualizerFromInputs(); });

      // Initialize width/height defaults for visualizer if empty
      if (!widthField.value) widthField.value = vizWidth;
      if (!heightField.value) heightField.value = vizHeight;

      renderVisualizer();
      
      updateQuoteDisplay();

      // Clean up any leftover modal overlays (can persist when navigating back via bfcache)
      try {
        document.querySelectorAll('[id^="modal-"]').forEach(m => m.remove());
      } catch (err) {
        console.warn('Modal cleanup failed', err);
      }

      // Refresh product data when page becomes visible (returns from admin panel)
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          updateProductLineOptions();
          // Remove any stray modal overlays that might block input when returning
          document.querySelectorAll('[id^="modal-"]').forEach(m => m.remove());
        }
      });

      // pageshow can fire when returning from bfcache; ensure overlays are removed
      window.addEventListener('pageshow', () => {
        document.querySelectorAll('[id^="modal-"]').forEach(m => m.remove());
      });
    }

    init();
  </script>
</body>
</html>
