<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Krasiva Windows & Doors - Sales Quote Builder</title>
  <style>
    :root {
      --gap: 0.5rem;
      --border: 1px solid rgba(0, 0, 0, 0.08);
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
      --shadow: var(--shadow-sm), var(--shadow-md);
      --bg-surface: #ffffff;
      --bg-input: #f4f4f5;
      --bg-header: #fafafa;
      --color-primary: #27272a;
      --color-danger: #dc2626;
      --color-success: #27272a;
      --text-primary: #18181b;
      --text-secondary: #71717a;
      --transition: 200ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #fafafa;
      color: var(--text-primary);
      line-height: 1.5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      background: var(--bg-surface);
      padding: 1.5rem;
      border: var(--border);
      margin-bottom: 1.5rem;
      border-radius: 8px;
      box-shadow: var(--shadow);
      position: relative;
    }
    
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 8px;
      pointer-events: none;
    }

    h1 {
      margin: 0 0 0.5rem 0;
      font-size: 1.75rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--text-primary);
    }

    .card {
      background: var(--bg-surface);
      padding: 1.5rem;
      border: var(--border);
      margin-bottom: 1.5rem;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    h2 {
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      margin-top: 0;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
      margin-bottom: 0;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 20px;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: block;
    }

    input, select {
      padding: 10px 12px;
      border: var(--border);
      border-radius: 6px;
      font-size: 14px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-input);
      color: var(--text-primary);
      transition: all var(--transition);
    }

    input:hover, select:hover {
      background: #ffffff;
      border-color: rgba(0, 0, 0, 0.12);
    }

    input:focus, select:focus {
      outline: none;
      background: #ffffff;
      border-color: rgba(0, 0, 0, 0.15);
      box-shadow: 0 0 0 3px rgba(39, 39, 42, 0.1);
    }

    button {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      transition: all var(--transition);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    button:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .btn-primary {
      background: var(--color-primary);
      color: white;
    }

    .btn-primary:hover {
      background: #3f3f46;
    }

    .btn-success {
      background: var(--color-success);
      color: white;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: var(--text-primary);
    }

    .btn-danger {
      background: var(--color-danger);
      color: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      background: var(--bg-surface);
      border-radius: 8px;
      overflow: hidden;
      border: var(--border);
      box-shadow: var(--shadow);
    }

    th, td {
      padding: 12px;
      border-bottom: var(--border);
      text-align: left;
      font-size: 13px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    th {
      background: var(--bg-header);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .quote-total {
      background: var(--bg-surface);
      border: var(--border);
      padding: 1.5rem;
      border-radius: 8px;
      text-align: center;
      box-shadow: var(--shadow);
      margin-top: 1.5rem;
    }

    .quote-total h2 {
      margin: 0 0 0.75rem 0;
      color: var(--text-secondary);
      font-size: 12px;
    }

    .quote-total .price {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .addon-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border: var(--border);
      border-radius: 6px;
      margin-bottom: 8px;
      background: var(--bg-surface);
      transition: all var(--transition);
    }

    .addon-checkbox:hover {
      background: var(--bg-input);
    }

    .addon-checkbox input {
      width: auto;
      cursor: pointer;
    }

    .alert {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 1rem;
      border: var(--border);
      font-size: 13px;
      box-shadow: var(--shadow);
    }

    .alert-error {
      background: #fef2f2;
      color: var(--text-primary);
      border: 1px solid rgba(220, 38, 38, 0.2);
    }

    .saved-quotes {
      max-height: 300px;
      overflow-y: auto;
      border: var(--border);
      border-radius: 6px;
      box-shadow: var(--shadow);
    }

    .quote-item {
      padding: 12px;
      border-bottom: var(--border);
      border-radius: 0;
      cursor: pointer;
      background: var(--bg-surface);
      transition: all var(--transition);
    }

    .quote-item:last-child {
      border-bottom: none;
    }

    .quote-item:hover {
      background: var(--bg-input);
    }

    .quote-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .quote-item-meta {
      font-size: 12px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
          <h1>Krasiva Windows & Doors</h1>
          <p>Create customer quotes with live pricing calculation.</p>
        </div>
        <a href="../admin/admin_interface.html" style="padding: 10px 16px; background: #27272a; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; align-self: center; font-size: 12px; text-transform: uppercase; letter-spacing: 0.04em; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.08); transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1); display: inline-block;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.12)'; this.style.transform='translateY(-1px)';" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.08)'; this.style.transform='translateY(0)';">Admin Panel</a>
      </div>
      <div style="display: flex; gap: 8px; margin-top: 1.5rem; flex-wrap: wrap;">
        <button class="btn-secondary" onclick="showSavedQuotes()">Load Quote</button>
        <button class="btn-secondary" onclick="newQuote()">New Quote</button>
        <button class="btn-success" onclick="saveQuote()">Save Quote</button>
      </div>
    </header>

    <div id="alerts"></div>

    <div class="card">
      <h2>Quote Information</h2>
      <div class="form-row">
        <div class="form-group">
          <label>Quote ID</label>
          <input type="text" id="quote-id" readonly>
        </div>
        <div class="form-group">
          <label>Customer Name</label>
          <input type="text" id="customer-name" placeholder="Enter customer name">
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Add Item</h2>
      
      <div class="form-row">
        <div class="form-group">
          <label>Room Location</label>
          <input type="text" id="room-label" placeholder="e.g., Master Bedroom, Living Room">
        </div>
        <div class="form-group">
          <label>Product Line</label>
          <select id="product-line" onchange="updateProductOptions()">
            <option value="">Select product line...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Product</label>
          <select id="product" onchange="updateProductInfo()">
            <option value="">Select product...</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Width (inches)</label>
          <input type="number" id="width" step="0.125" placeholder="36">
        </div>
        <div class="form-group">
          <label>Height (inches)</label>
          <input type="number" id="height" step="0.125" placeholder="60">
        </div>
        <div class="form-group">
          <label>Total UI</label>
          <input type="number" id="total-ui" step="1" placeholder="96" readonly>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Mulling Type</label>
          <select id="mull-type">
            <option value="">None</option>
            <option value="left">Left</option>
            <option value="right">Right</option>
            <option value="center">Center</option>
            <option value="above">Above</option>
            <option value="below">Below</option>
          </select>
        </div>
      </div>

      <div id="addons-section" style="display: none; margin-bottom: 1.5rem;">
        <h3 style="margin-top: 1rem; margin-bottom: 1rem; font-size: 0.95rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;">Available Addons</h3>
        <div id="addons-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px;"></div>
      </div>

      <button class="btn-primary" onclick="addLineItem()">+ Add Item</button>
    </div>

    <div class="card">
      <h2>Quote Line Items</h2>
      <div id="line-items-table"></div>
    </div>

    <div class="card">
      <h2>Job Addons</h2>
      <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 1rem;">Apply to the entire job</p>
      <div id="job-addons-section"></div>
    </div>

    <div class="card">
      <div class="form-row">
        <div class="form-group">
          <label>Sales Commission / Uplift ($)</label>
          <input type="number" id="sales-uplift" value="0" step="0.01" onchange="calculateQuoteTotal()">
        </div>
      </div>
    </div>

    <div class="quote-total">
      <h2>Customer Price</h2>
      <div class="price" id="final-price">$0.00</div>
      <button class="btn-success" style="margin-top: 1rem;" onclick="generateQuoteDocument()">Generate Quote Document</button>
    </div>
  </div>

  <script type="module">
    import { PricingEngine } from '../pricing_engine.js';
    import { DataStorage } from '../data_storage.js';

    // Initialize
    DataStorage.initializeSampleData();
    
    let currentQuote = {
      id: `quote_${Date.now()}`,
      customerName: '',
      lineItems: [],
      salesUplift: 0,
      selectedJobAddonIds: []
    };

    window.showAlert = (message, type = 'error') => {
      const alerts = document.getElementById('alerts');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alerts.appendChild(alert);
      setTimeout(() => alert.remove(), 5000);
    };

    window.newQuote = () => {
      if (currentQuote.lineItems.length > 0) {
        if (!confirm('Start a new quote? Current quote will be lost if not saved.')) return;
      }
      currentQuote = {
        id: `quote_${Date.now()}`,
        customerName: '',
        lineItems: [],
        salesUplift: 0,
        selectedJobAddonIds: []
      };
      document.getElementById('customer-name').value = '';
      document.getElementById('sales-uplift').value = '0';
      updateQuoteDisplay();
    };

    window.saveQuote = () => {
      const customerName = document.getElementById('customer-name').value.trim();
      if (!customerName) {
        return showAlert('Please enter customer name');
      }
      if (currentQuote.lineItems.length === 0) {
        return showAlert('Quote must have at least one line item');
      }

      currentQuote.customerName = customerName;
      currentQuote.salesUplift = parseFloat(document.getElementById('sales-uplift').value) || 0;

      try {
        // Calculate totals with selected job addons
        const allAddons = DataStorage.getAddons();
        const jobBasedAddons = currentQuote.selectedJobAddonIds.map(addonId => {
          const addon = allAddons[addonId];
          if (!addon) return null;
          
          let price = 0;
          if (addon.pricingModel === 'UI') {
            const totalUI = currentQuote.lineItems.reduce((sum, item) => sum + item.ui, 0);
            price = totalUI * addon.uiRate;
          } else {
            price = addon.flatPrice || 0;
          }
          
          return { id: addonId, name: addon.name, price };
        }).filter(a => a !== null);
        
        const quoteCalc = PricingEngine.calculateQuote({
          lineItems: currentQuote.lineItems,
          jobBasedAddons,
          salesUplift: currentQuote.salesUplift
        });

        // Create version
        const version = PricingEngine.createQuoteVersion({
          quoteId: currentQuote.id,
          lineItems: currentQuote.lineItems,
          jobBasedAddons,
          salesUplift: currentQuote.salesUplift,
          metadata: {
            customerName: currentQuote.customerName,
            ...quoteCalc
          }
        });

        // Save quote and version
        DataStorage.saveQuote(currentQuote);
        DataStorage.saveQuoteVersion(version);

        showAlert('Quote saved successfully!', 'success');
      } catch (error) {
        showAlert(error.message);
      }
    };

    window.showSavedQuotes = () => {
      const quotes = DataStorage.get(DataStorage.KEYS.QUOTES, {});
      const quoteList = Object.values(quotes);

      if (quoteList.length === 0) {
        return showAlert('No saved quotes found');
      }

      const html = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.35); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);" onclick="if(event.target === this) this.remove()">
          <div style="background: white; padding: 1.5rem; border-radius: 8px; max-width: 600px; width: 90%; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
            <h2 style="margin-top: 0; font-size: 1rem; font-weight: 600; letter-spacing: -0.01em; color: #18181b;">Load Quote</h2>
            <div class="saved-quotes">
              ${quoteList.map(q => {
                const versions = DataStorage.getQuoteVersions(q.id);
                const latestVersion = versions[versions.length - 1];
                return `
                  <div class="quote-item" onclick="loadQuote('${q.id}')">
                    <div class="quote-item-header">
                      <strong>${q.customerName || 'Unnamed Quote'}</strong>
                      <span>${latestVersion ? `$${latestVersion.finalPrice.toFixed(2)}` : ''}</span>
                    </div>
                    <div class="quote-item-meta">
                      ${q.id} • ${q.lineItems.length} items • ${versions.length} version(s)
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
            <button class="btn-secondary" style="margin-top: 1rem;" onclick="this.closest('div[style*=fixed]').remove()">Close</button>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
    };

    window.loadQuote = (quoteId) => {
      const quotes = DataStorage.get(DataStorage.KEYS.QUOTES, {});
      const quote = quotes[quoteId];
      if (!quote) return;

      currentQuote = JSON.parse(JSON.stringify(quote)); // Deep clone
      
      // Ensure mandatory job addons are included
      const allAddons = DataStorage.getAddons();
      const mandatoryJobAddonIds = Object.entries(allAddons)
        .filter(([id, addon]) => addon.isJobBased && addon.mandatory)
        .map(([id]) => id);
      currentQuote.selectedJobAddonIds = [...new Set([...(currentQuote.selectedJobAddonIds || []), ...mandatoryJobAddonIds])];
      
      document.getElementById('customer-name').value = quote.customerName;
      document.getElementById('sales-uplift').value = quote.salesUplift || 0;
      
      updateQuoteDisplay();
      document.querySelector('div[style*=fixed]')?.remove();
    };

    window.renderJobAddons = () => {
      const allAddons = DataStorage.getAddons();
      const jobAddons = Object.entries(allAddons)
        .filter(([id, addon]) => addon.isJobBased)
        .map(([id, addon]) => ({ id, ...addon }));

      // Ensure mandatory job addons are always selected
      const mandatoryJobAddonIds = jobAddons
        .filter(addon => addon.mandatory)
        .map(addon => addon.id);
      
      currentQuote.selectedJobAddonIds = [
        ...new Set([...currentQuote.selectedJobAddonIds, ...mandatoryJobAddonIds])
      ];

      if (jobAddons.length === 0) {
        document.getElementById('job-addons-section').innerHTML = '<p style="color: var(--text-secondary); font-size: 13px;">No job addons available</p>';
        return;
      }

      const addonHtml = jobAddons.map(addon => {
        const isSelected = currentQuote.selectedJobAddonIds.includes(addon.id);
        const isChecked = addon.mandatory || isSelected;
        const price = addon.pricingModel === 'UI' 
          ? '(UI-Based)' 
          : `$${addon.flatPrice.toFixed(2)}`;
        
        return `
          <div class="addon-checkbox">
            <input type="checkbox" id="job-addon-${addon.id}" class="job-addon" value="${addon.id}" ${isChecked ? 'checked' : ''} ${addon.mandatory ? 'disabled' : ''} onchange="updateJobAddonSelection()">
            <label for="job-addon-${addon.id}" style="margin: 0; flex: 1; font-weight: 500; text-transform: none;">
              ${addon.name} 
              <span style="color: var(--text-secondary); font-size: 12px;">${price}</span>
              ${addon.mandatory ? '<span style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: 600; margin-left: 8px;">MANDATORY</span>' : ''}
            </label>
          </div>
        `;
      }).join('');
      
      document.getElementById('job-addons-section').innerHTML = addonHtml;
    };

    window.updateJobAddonSelection = () => {
      currentQuote.selectedJobAddonIds = Array.from(document.querySelectorAll('.job-addon:checked'))
        .map(checkbox => checkbox.value);
      
      // Always include mandatory addons
      const allAddons = DataStorage.getAddons();
      const mandatoryJobAddonIds = Object.entries(allAddons)
        .filter(([id, addon]) => addon.isJobBased && addon.mandatory)
        .map(([id]) => id);
      
      currentQuote.selectedJobAddonIds = [...new Set([...currentQuote.selectedJobAddonIds, ...mandatoryJobAddonIds])];
      
      // Recalculate the quote total
      calculateQuoteTotal();
    };
    window.updateProductLineOptions = () => {
      const productLines = DataStorage.getProductLines();
      
      document.getElementById('product-line').innerHTML = 
        '<option value="">Select product line...</option>' +
        Object.values(productLines).map(pl => `<option value="${pl.id}">${pl.name}</option>`).join('');
      
      updateProductOptions();
    };

    window.updateProductOptions = () => {
      const productLineId = document.getElementById('product-line').value;
      const products = DataStorage.getProducts();
      const filtered = Object.values(products).filter(p => p.productLineId === productLineId);

      document.getElementById('product').innerHTML = 
        '<option value="">Select product...</option>' +
        filtered.map(p => `<option value="${p.id}">${p.productTypeCode} - ${p.name}</option>`).join('');
      
      updateProductInfo();
    };

    window.updateProductInfo = () => {
      const productId = document.getElementById('product').value;
      if (!productId) {
        document.getElementById('total-ui').value = '';
        document.getElementById('addons-section').style.display = 'none';
        return;
      }

      const products = DataStorage.getProducts();
      const product = products[productId];
      const allAddons = DataStorage.getAddons();
      
      // Calculate total UI from width + height
      const width = parseFloat(document.getElementById('width').value) || 0;
      const height = parseFloat(document.getElementById('height').value) || 0;
      const ui = Math.ceil(width + height);
      
      document.getElementById('total-ui').value = ui || '';
      
      // Get available addons for this product, excluding job-based addons
      const availableAddonIds = PricingEngine.getAvailableAddonsForProduct(product, ui, allAddons)
        .filter(addonId => !allAddons[addonId].isJobBased);
      
      if (availableAddonIds.length === 0) {
        document.getElementById('addons-section').style.display = 'none';
        return;
      }
      
      // Display addon checkboxes
      const addonHtml = availableAddonIds.map(addonId => {
        const addon = allAddons[addonId];
        const price = addon.pricingModel === 'UI' 
          ? `$${(ui * addon.uiRate).toFixed(2)}` 
          : `$${addon.flatPrice.toFixed(2)}`;
        
        return `
          <div class="addon-checkbox">
            <input type="checkbox" id="addon-${addonId}" class="product-addon" value="${addonId}">
            <label for="addon-${addonId}" style="margin: 0; flex: 1; font-weight: 500; text-transform: none;">
              ${addon.name} <span style="color: var(--text-secondary); font-size: 12px;">${price}</span>
            </label>
          </div>
        `;
      }).join('');
      
      document.getElementById('addons-list').innerHTML = addonHtml;
      document.getElementById('addons-section').style.display = 'block';
    };

    window.addLineItem = () => {
      const roomLabel = document.getElementById('room-label').value.trim();
      const productId = document.getElementById('product').value;
      const width = parseFloat(document.getElementById('width').value);
      const height = parseFloat(document.getElementById('height').value);
      const mullType = document.getElementById('mull-type').value;

      if (!roomLabel || !productId || !width || !height) {
        return showAlert('Please fill all required fields');
      }

      const products = DataStorage.getProducts();
      const product = products[productId];
      const globalSettings = DataStorage.getGlobalSettings();
      const allAddons = DataStorage.getAddons();

      // Get selected addons
      const selectedAddonIds = Array.from(document.querySelectorAll('.product-addon:checked'))
        .map(checkbox => checkbox.value);

      try {
        // Calculate UI
        const ui = Math.ceil(width + height);
        
        // Validate against global minimum UI
        if (ui < globalSettings.minimumUI) {
          return showAlert(`Total UI (${ui}) must be at least ${globalSettings.minimumUI} inches`);
        }

        // Validate size limits if product has them
        const validation = PricingEngine.validateSize({ product, width, height });
        if (!validation.valid) {
          return showAlert(validation.errors.join(', '));
        }

        // Calculate line item with selected addons
        const lineItemCalc = PricingEngine.calculateLineItem({
          product,
          width,
          height,
          selectedAddonIds,
          allAddons
        });

        // Add to quote
        currentQuote.lineItems.push({
          id: `item_${Date.now()}`,
          productId,
          roomLabel,
          width,
          height,
          ui,
          mullType,
          ...lineItemCalc
        });

        // Reset form
        document.getElementById('room-label').value = '';
        document.getElementById('product-line').value = '';
        document.getElementById('product').value = '';
        document.getElementById('width').value = '';
        document.getElementById('height').value = '';
        document.getElementById('total-ui').value = '';
        document.getElementById('mull-type').value = '';
        document.getElementById('addons-list').innerHTML = '';
        document.getElementById('addons-section').style.display = 'none';

        updateQuoteDisplay();
      } catch (error) {
        showAlert(error.message);
      }
    };

    window.removeLineItem = (index) => {
      currentQuote.lineItems.splice(index, 1);
      updateQuoteDisplay();
    };

    window.calculateQuoteTotal = () => {
      updateQuoteDisplay();
    };

    function updateQuoteDisplay() {
      document.getElementById('quote-id').value = currentQuote.id;

      // Render job addons section
      renderJobAddons();

      // Render line items table
      if (currentQuote.lineItems.length === 0) {
        document.getElementById('line-items-table').innerHTML = '<p>No items added yet.</p>';
      } else {
        const products = DataStorage.getProducts();
        
        const html = `
          <table>
            <thead>
              <tr>
                <th>Room</th>
                <th>Product</th>
                <th>Size</th>
                <th>UI</th>
                <th>Mulling</th>
                <th>Addons</th>
                <th>Price</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${currentQuote.lineItems.map((item, index) => {
                const product = products[item.productId];
                const productName = product ? product.name : 'Unknown';
                const productCode = product ? product.productTypeCode : 'N/A';
                const mullLabel = {
                  'left': 'Left',
                  'right': 'Right',
                  'center': 'Center',
                  'above': 'Above',
                  'below': 'Below'
                };
                const mullText = item.mullType ? (mullLabel[item.mullType] || item.mullType) : 'None';
                
                // Display only visible addons
                const visibleAddons = item.appliedAddons.filter(a => !a.hidden);
                const addonsText = visibleAddons.length > 0 
                  ? visibleAddons.map(a => a.name).join(', ')
                  : 'None';
                
                return `
                  <tr>
                    <td>${item.roomLabel}</td>
                    <td>${productCode} - ${productName}</td>
                    <td>${item.width}" × ${item.height}"</td>
                    <td>${item.ui}</td>
                    <td>${mullText}</td>
                    <td><small>${addonsText}</small></td>
                    <td>$${item.lineItemParTotal.toFixed(2)}</td>
                    <td><button class="btn-danger" onclick="removeLineItem(${index})">Remove</button></td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
        document.getElementById('line-items-table').innerHTML = html;
      }

      // Calculate total with job addons (always, even with no line items)
      try {
        const salesUplift = parseFloat(document.getElementById('sales-uplift').value) || 0;
        const allAddons = DataStorage.getAddons();
        
        // Build job-based addons with their calculated prices
        const jobBasedAddons = currentQuote.selectedJobAddonIds.map(addonId => {
          const addon = allAddons[addonId];
          if (!addon) return null;
          
          let price = 0;
          if (addon.pricingModel === 'UI') {
            // For UI-based job addons, calculate based on total UI of all items
            const totalUI = currentQuote.lineItems.reduce((sum, item) => sum + item.ui, 0);
            price = totalUI * addon.uiRate;
          } else {
            price = addon.flatPrice || 0;
          }
          
          return { id: addonId, name: addon.name, price };
        }).filter(a => a !== null);
        
        const quoteCalc = PricingEngine.calculateQuote({
          lineItems: currentQuote.lineItems,
          jobBasedAddons,
          salesUplift
        });
        document.getElementById('final-price').textContent = `$${quoteCalc.finalPrice.toFixed(2)}`;
      } catch (error) {
        showAlert(error.message);
      }
    }

    window.generateQuoteDocument = () => {
      const customerName = document.getElementById('customer-name').value.trim();
      if (!customerName) {
        return showAlert('Please enter customer name');
      }

      try {
        const salesUplift = parseFloat(document.getElementById('sales-uplift').value) || 0;
        const allAddons = DataStorage.getAddons();
        
        const jobBasedAddons = currentQuote.selectedJobAddonIds.map(addonId => {
          const addon = allAddons[addonId];
          if (!addon) return null;
          
          let price = 0;
          if (addon.pricingModel === 'UI') {
            const totalUI = currentQuote.lineItems.reduce((sum, item) => sum + item.ui, 0);
            price = totalUI * addon.uiRate;
          } else {
            price = addon.flatPrice || 0;
          }
          
          return { id: addonId, name: addon.name, price };
        }).filter(a => a !== null);
        
        const quoteCalc = PricingEngine.calculateQuote({
          lineItems: currentQuote.lineItems,
          jobBasedAddons,
          salesUplift
        });

        // Generate simple text quote
        let doc = `QUOTE: ${currentQuote.id}\n`;
        doc += `Customer: ${customerName}\n`;
        doc += `Date: ${new Date().toLocaleDateString()}\n\n`;
        doc += `LINE ITEMS:\n`;
        doc += `${'='.repeat(80)}\n`;

        const products = DataStorage.getProducts();
        currentQuote.lineItems.forEach((item, index) => {
          const product = products[item.productId];
          const productName = product ? product.name : 'Unknown';
          const productCode = product ? product.productTypeCode : 'N/A';
          
          doc += `${index + 1}. [${item.roomLabel}] ${productCode} - ${productName}\n`;
          doc += `   Size: ${item.width}" × ${item.height}" (${item.ui} UI)\n`;
          
          if (item.mullType) {
            const mullLabel = {
              'left': 'Left',
              'right': 'Right',
              'center': 'Center',
              'above': 'Above',
              'below': 'Below'
            };
            doc += `   Mulling: ${mullLabel[item.mullType] || item.mullType}\n`;
          }
          
          const visibleAddons = item.appliedAddons.filter(a => !a.hidden);
          if (visibleAddons.length > 0) {
            doc += `   Options: ${visibleAddons.map(a => a.name).join(', ')}\n`;
          }
          doc += `   Price: $${item.lineItemParTotal.toFixed(2)}\n\n`;
        });

        if (jobBasedAddons.length > 0) {
          doc += `${'='.repeat(80)}\n`;
          doc += `JOB ADDONS:\n`;
          jobBasedAddons.forEach(addon => {
            doc += `  - ${addon.name}: $${addon.price.toFixed(2)}\n`;
          });
        }

        doc += `${'='.repeat(60)}\n`;
        doc += `TOTAL: $${quoteCalc.finalPrice.toFixed(2)}\n`;

        // Download as text file
        const blob = new Blob([doc], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `quote-${currentQuote.id}.txt`;
        a.click();
      } catch (error) {
        showAlert(error.message);
      }
    };

    // Initialize
    function init() {
      // Debug: Check what data we have
      const productLines = DataStorage.getProductLines();
      const products = DataStorage.getProducts();
      console.log('Product Lines:', productLines);
      console.log('Products:', products);

      // Initialize mandatory job addons
      const allAddons = DataStorage.getAddons();
      const mandatoryJobAddonIds = Object.entries(allAddons)
        .filter(([id, addon]) => addon.isJobBased && addon.mandatory)
        .map(([id]) => id);
      currentQuote.selectedJobAddonIds = [...new Set([...currentQuote.selectedJobAddonIds, ...mandatoryJobAddonIds])];

      // Populate product lines
      updateProductLineOptions();
      
      // Add event listeners to width/height to update UI
      document.getElementById('width').addEventListener('input', updateProductInfo);
      document.getElementById('height').addEventListener('input', updateProductInfo);
      
      updateQuoteDisplay();

      // Refresh product data when page becomes visible (returns from admin panel)
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          updateProductLineOptions();
        }
      });
    }

    init();
  </script>
</body>
</html>
