<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Krasiva Windows & Doors - Sales Quote Builder</title>
  <style>
    :root {
      --gap: 0.5rem;
      --border: 1px solid rgba(0, 0, 0, 0.08);
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
      --shadow: var(--shadow-sm), var(--shadow-md);
      --bg-surface: #ffffff;
      --bg-input: #f4f4f5;
      --bg-header: #fafafa;
      --color-primary: #27272a;
      --color-danger: #dc2626;
      --color-success: #27272a;
      --text-primary: #18181b;
      --text-secondary: #71717a;
      --transition: 200ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #fafafa;
      color: var(--text-primary);
      line-height: 1.5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      background: var(--bg-surface);
      padding: 1.5rem;
      border: var(--border);
      margin-bottom: 1.5rem;
      border-radius: 8px;
      box-shadow: var(--shadow);
      position: relative;
    }
    
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 8px;
      pointer-events: none;
    }

    h1 {
      margin: 0 0 0.5rem 0;
      font-size: 1.75rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--text-primary);
    }

    .card {
      background: var(--bg-surface);
      padding: 1.5rem;
      border: var(--border);
      margin-bottom: 1.5rem;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    h2 {
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      margin-top: 0;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
      margin-bottom: 0;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 20px;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: block;
    }

    input, select {
      padding: 10px 12px;
      border: var(--border);
      border-radius: 6px;
      font-size: 14px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-input);
      color: var(--text-primary);
      transition: all var(--transition);
    }

    input:hover, select:hover {
      background: #ffffff;
      border-color: rgba(0, 0, 0, 0.12);
    }

    input:focus, select:focus {
      outline: none;
      background: #ffffff;
      border-color: rgba(0, 0, 0, 0.15);
      box-shadow: 0 0 0 3px rgba(39, 39, 42, 0.1);
    }

    button {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      transition: all var(--transition);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    button:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .btn-primary {
      background: var(--color-primary);
      color: white;
    }

    .btn-primary:hover {
      background: #3f3f46;
    }

    .btn-success {
      background: var(--color-success);
      color: white;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: var(--text-primary);
    }

    .btn-danger {
      background: var(--color-danger);
      color: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      background: var(--bg-surface);
      border-radius: 8px;
      overflow: hidden;
      border: var(--border);
      box-shadow: var(--shadow);
    }

    th, td {
      padding: 12px;
      border-bottom: var(--border);
      text-align: left;
      font-size: 13px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    th {
      background: var(--bg-header);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .quote-total {
      background: var(--bg-surface);
      border: var(--border);
      padding: 1.5rem;
      border-radius: 8px;
      text-align: center;
      box-shadow: var(--shadow);
      margin-top: 1.5rem;
    }

    .quote-total h2 {
      margin: 0 0 0.75rem 0;
      color: var(--text-secondary);
      font-size: 12px;
    }

    .quote-total .price {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .addon-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border: var(--border);
      border-radius: 6px;
      margin-bottom: 8px;
      background: var(--bg-surface);
      transition: all var(--transition);
    }

    .addon-checkbox:hover {
      background: var(--bg-input);
    }

    .addon-checkbox input {
      width: auto;
      cursor: pointer;
    }

    .color-swatch {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 1px solid rgba(0,0,0,0.08);
      display: inline-block;
      vertical-align: middle;
      margin-right: 6px;
    }

    .alert {
      position: fixed;
      top: 1rem;
      left: 1rem;
      right: 1rem;
      max-width: 600px;
      padding: 12px 16px;
      border-radius: 6px;
      border: var(--border);
      font-size: 13px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 10000;
      animation: slideDown 0.3s ease-out;
      pointer-events: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      backdrop-filter: blur(4px);
    }

    .alert-close {
      pointer-events: auto;
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: inherit;
      opacity: 0.6;
      transition: opacity 0.2s;
      padding: 0;
      min-width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .alert-close:hover { opacity: 1; }

    .alert-content { flex: 1; }

    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .alert-success {
      background: rgba(240, 253, 244, 0.9);
      color: var(--text-primary);
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .alert-error {
      background: rgba(254, 242, 242, 0.9);
      color: var(--text-primary);
      border: 1px solid rgba(220, 38, 38, 0.2);
    }

    .saved-quotes {
      max-height: 300px;
      overflow-y: auto;
      border: var(--border);
      border-radius: 6px;
      box-shadow: var(--shadow);
    }

    .quote-item {
      padding: 12px;
      border-bottom: var(--border);
      border-radius: 0;
      cursor: pointer;
      background: var(--bg-surface);
      transition: all var(--transition);
    }

    .quote-item:last-child {
      border-bottom: none;
    }

    .quote-item:hover {
      background: var(--bg-input);
    }

    .quote-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .quote-item-meta {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Visualizer embed */
    .window-visualizer {
      background: var(--bg-surface);
      padding: 1rem;
      border: var(--border);
      border-radius: 8px;
      box-shadow: var(--shadow);
      margin-top: 0.5rem;
    }

    .visualizer-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      align-items: start;
    }

    @media (max-width: 768px) {
      .visualizer-grid { grid-template-columns: 1fr; }
    }

    .visualizer-canvas {
      background: var(--bg-header);
      border-radius: 6px;
      padding: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 420px;
      height: 420px;
      border: var(--border);
      overflow: hidden; /* no scrolling; SVG will scale inside */
    }

    .dimension-label {
      font-size: 11px;
      font-weight: 600;
      fill: var(--text-primary);
    }

    .window-description {
      display: none;
    }

    /* Prevent addons list and selected addons from stretching layout; make them scrollable */
    #addons-list {
      max-height: 180px;
      overflow-y: auto;
      padding-right: 6px;
    }

    #selected-addons {
      max-height: 160px;
      overflow-y: auto;
      padding-right: 6px;
    }

    /* Ensure embedded SVGs don't force container resizing */
    #viz-svg-container svg {
      width: 100%;
      height: 100%;
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
          <h1>Krasiva Windows & Doors</h1>
          <p>Create customer quotes with live pricing calculation.</p>
        </div>
        <a href="../admin/admin_interface.html" style="padding: 10px 16px; background: #27272a; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; align-self: center; font-size: 12px; text-transform: uppercase; letter-spacing: 0.04em; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.08); transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1); display: inline-block;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.12)'; this.style.transform='translateY(-1px)';" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.08)'; this.style.transform='translateY(0)';">Admin Panel</a>
      </div>
      <div style="display: flex; gap: 8px; margin-top: 1.5rem; flex-wrap: wrap;">
        <button class="btn-secondary" onclick="showSavedQuotes()">Load Quote</button>
        <button class="btn-secondary" onclick="newQuote()">New Quote</button>
        <button class="btn-success" onclick="saveQuote()">Save Quote</button>
      </div>
    </header>

    <div id="alerts"></div>

    <div class="card">
      <h2>Quote Information</h2>
      <div class="form-row">
        <div class="form-group">
          <label>Quote ID</label>
          <input type="text" id="quote-id" readonly>
        </div>
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="quote-date">
        </div>
        <div class="form-group">
          <label>Customer Name <span style="color:#dc2626;">*</span></label>
          <input type="text" id="customer-name" placeholder="Enter customer name">
        </div>
        <div class="form-group">
          <label>Spouse / Co-Owner</label>
          <input type="text" id="spouse-name" placeholder="Optional">
        </div>
        <div class="form-group">
          <label>Address</label>
          <textarea id="customer-address" rows="2" style="padding:10px 12px; border: var(--border); border-radius:6px; background: var(--bg-input);"></textarea>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="customer-phone" placeholder="Primary phone">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="customer-email" placeholder="Primary email">
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Add Item</h2>
      
      <div class="form-row">
        <div class="form-group">
          <label>Room Location <span style="color:#dc2626;">*</span></label>
          <input type="text" id="room-label" placeholder="e.g., Master Bedroom, Living Room">
        </div>
        <div class="form-group">
          <label>Product Line</label>
          <select id="product-line" onchange="updateProductOptions()">
            <option value="">Select product line...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Product <span style="color:#dc2626;">*</span></label>
          <select id="product" onchange="updateProductInfo()">
            <option value="">Select product...</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Width (inches) <span style="color:#dc2626;">*</span></label>
          <input type="number" id="width" step="0.125" placeholder="36">
        </div>
        <div class="form-group">
          <label>Height (inches) <span style="color:#dc2626;">*</span></label>
          <input type="number" id="height" step="0.125" placeholder="60">
        </div>
        <div class="form-group">
          <label>Total UI</label>
          <input type="number" id="total-ui" step="1" placeholder="96" readonly>
        </div>
      </div>

      <div class="window-visualizer">
        <div class="visualizer-grid">
          <div style="display: flex; flex-direction: column; gap: 0.75rem; justify-content: flex-start;">
            <div id="extras-section" style="display: block; margin-top: 0.25rem;">
              <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; display: block;">Notes / Site Adjustments</label>
              <textarea id="extra-notes" rows="3" style="width: 100%; padding: 10px 12px; border: var(--border); border-radius: 6px; background: var(--bg-input); font-size: 13px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; resize: vertical;"></textarea>
              <div id="selected-addons" style="margin-top:8px; font-size:13px; color: var(--text-secondary);"></div>
            </div>
          </div>
          <div>
            <div class="visualizer-canvas">
              <div id="viz-svg-container"></div>
            </div>

            <div style="display: flex; gap: 8px; align-items: center; margin-top: 0.75rem;">
              <button class="btn-secondary" type="button" onclick="openAddonModal()" id="addons-button">+ Add-Ons</button>
              <button class="btn-secondary" type="button" onclick="toggleStructural()" id="structural-toggle">⧉ Structural</button>
              <div style="display:flex; align-items:center; gap:8px;">
                <button id="frame-color-button" class="btn-secondary" type="button" onclick="openColorModal()" style="display:flex; align-items:center; gap:8px;">
                  <span id="frame-color-swatch" class="color-swatch" style="background:#ffffff;"></span>
                  <span id="frame-color-label">White</span>
                  <span style="margin-left:6px; opacity:0.7;">▾</span>
                </button>
                <input type="hidden" id="frame-color" value="white">
              </div>
            </div>

            <div id="structural-section" style="display: none; margin-top: 0.25rem;">
              <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; display: block;">Structural / Mulling</label>
              <select id="mull-type" style="margin-top: 4px;">
                <option value="">None</option>
                <option value="left">Left</option>
                <option value="right">Right</option>
                <option value="center">Center</option>
                <option value="above">Above</option>
                <option value="below">Below</option>
              </select>
              <div style="display:flex; gap:8px; margin-top:8px;">
                <div style="flex:1;">
                  <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; display: block;">Hinge Side</label>
                  <select id="hinge-side" style="margin-top:4px; width:100%;">
                    <option value="">Not Applicable</option>
                    <option value="left">Left</option>
                    <option value="right">Right</option>
                  </select>
                </div>
                <div style="flex:1;">
                  <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; display: block;">Swing</label>
                  <select id="swing-type" style="margin-top:4px; width:100%;">
                    <option value="">Not Applicable</option>
                    <option value="inswing">Inswing</option>
                    <option value="outswing">Outswing</option>
                  </select>
                </div>
              </div>
            </div>

            <div id="addons-section" style="display: none; margin: 0;">
              <div id="addons-list" style="display: none;"></div>
            </div>
          </div>
        </div>
      </div>

      <button class="btn-primary" onclick="addLineItem()">+ Add Item</button>
    </div>

    <div class="card">
      <h2>Quote Line Items</h2>
      <div id="line-items-table"></div>
    </div>

    <div class="card">
      <h2>Job Addons</h2>
      <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 1rem;">Apply to the entire job</p>
      <div id="job-addons-section"></div>
    </div>

    <div class="card">
      <h2>Job Notes</h2>
      <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 1rem;">Notes that apply to the entire job (not per-item)</p>
      <textarea id="job-notes" rows="4" style="width:100%; padding:10px 12px; border: var(--border); border-radius:6px; background: var(--bg-input);"></textarea>
    </div>

    <div class="card">
      <div class="form-row">
        <div class="form-group">
          <label>Sales Commission / Uplift ($)</label>
          <input type="number" id="sales-uplift" value="0" step="0.01" onchange="calculateQuoteTotal()">
        </div>
      </div>
    </div>

    <div class="quote-total">
      <h2>Customer Price</h2>
      <div class="price" id="final-price">$0.00</div>
      <button class="btn-success" style="margin-top: 1rem;" onclick="generateQuoteDocument()">Generate Quote Document</button>
    </div>
  </div>

  <script type="module">
    import { PricingEngine } from '../pricing_engine.js';
    import { DataStorage } from '../data_storage.js';

    // Initialize
    DataStorage.initializeSampleData();
    
    let currentQuote = {
      id: `quote_${Date.now()}`,
      customerName: '',
      lineItems: [],
      salesUplift: 0,
      selectedJobAddonIds: []
    };

    // Visualizer state
    let vizWidth = 36;
    let vizHeight = 60;
    let vizWindowType = 'single';
    const vizScale = 5; // pixels per inch
    const vizDescriptions = {
      single: 'Bottom sash slides up',
      double: 'Both sashes slide vertically',
      slider: 'Left panel slides right',
      casement: 'Swings out from left hinge',
      awning: 'Tilts out from top hinge',
      fixed: 'No opening mechanism'
    };

    window.showAlert = (message, type = 'error') => {
      // Respect global setting if present
      try {
        const settings = DataStorage.getGlobalSettings();
        if (settings && settings.alertsEnabled === false) return;
      } catch (e) {
        // ignore if DataStorage not available
      }

      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;

      const contentDiv = document.createElement('div');
      contentDiv.className = 'alert-content';
      contentDiv.textContent = message;

      const closeBtn = document.createElement('button');
      closeBtn.className = 'alert-close';
      closeBtn.innerHTML = '✕';
      closeBtn.onclick = (e) => {
        e.stopPropagation();
        alert.style.animation = 'slideDown 0.3s ease-out reverse';
        setTimeout(() => alert.remove(), 300);
      };

      alert.appendChild(contentDiv);
      alert.appendChild(closeBtn);

      // Stack alerts by increasing z-index so newer ones appear above
      const existingAlerts = document.querySelectorAll('.alert').length;
      alert.style.zIndex = 10000 + existingAlerts;

      document.body.appendChild(alert);

      // Auto-dismiss after 5s with reverse animation
      setTimeout(() => {
        alert.style.animation = 'slideDown 0.3s ease-out reverse';
        setTimeout(() => alert.remove(), 300);
      }, 5000);
    };

    // Generic modal function (copied from admin_interface.html for consistent UX)
    window.showModal = (title, content, buttons = []) => {
      const modalId = `modal-${Date.now()}`;
      let buttonHtml = '';
      if (buttons.length === 0) {
        buttonHtml = `<button class="btn-secondary" onclick="document.getElementById('${modalId}').remove()">Close</button>`;
      } else {
        buttonHtml = buttons.map((btn, idx) => {
          const btnClass = btn.type === 'primary' ? 'btn-primary' : btn.type === 'danger' ? 'btn-danger' : 'btn-secondary';
          const btnId = `btn-${modalId}-${idx}`;
          return `<button id="${btnId}" class="${btnClass}">${btn.label}</button>`;
        }).join('');
      }

      const html = `<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.35); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);" id="${modalId}" onclick="if(event.target.id === '${modalId}') this.remove()">
        <div style="background: white; padding: 1.5rem; border-radius: 8px; max-width: 500px; width: 90%; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); max-height: 80vh; overflow-y: auto;">
          <h2 style="margin-top: 0; margin-bottom: 1rem;">${title}</h2>
          <div id="modal-content-${Date.now()}">${content}</div>
          <div style="display: flex; gap: 8px; margin-top: 1.5rem;">
            ${buttonHtml}
          </div>
        </div>
      </div>`;
      document.body.insertAdjacentHTML('beforeend', html);

      // Attach click handlers (scope lookup to the created modal element)
      const modalElem = document.getElementById(modalId);
      buttons.forEach((btn, idx) => {
        const btnId = `btn-${modalId}-${idx}`;
        const btnElement = modalElem ? modalElem.querySelector(`#${btnId}`) : document.getElementById(btnId);
        console.log('Attaching modal button', btnId, 'found=', !!btnElement);
        if (btnElement && btn.onclick) {
          btnElement.onclick = (e) => {
            e.preventDefault();
            const modal = document.getElementById(modalId);
            if (modal) modal.remove();
            try {
              if (typeof btn.onclick === 'function') {
                btn.onclick();
              } else {
                eval(btn.onclick);
              }
            } catch (err) {
              console.error('Modal button handler error', err);
            }
          };
        }
      });

      return modalId;
    };

    // Confirm before leaving sales page (save prompt)
    window.confirmLeaveAdmin = (event, targetUrl = null) => {
      if (event && event.preventDefault) event.preventDefault();

      // Derive targetUrl from clicked anchor if not provided
      if (!targetUrl && event) {
        const a = event.currentTarget || (event.target && event.target.closest && event.target.closest('a'));
        targetUrl = a ? a.getAttribute('href') : null;
      }

      const hasUnsaved = (currentQuote.lineItems && currentQuote.lineItems.length > 0) || (document.getElementById('customer-name').value.trim() !== '') || ((parseFloat(document.getElementById('sales-uplift').value) || 0) !== 0);
      if (!hasUnsaved) {
        if (targetUrl) window.location.href = targetUrl;
        return;
      }

      showModal('Leave Sales Page?', '<p>Do you want to save the current quote before leaving the sales page?</p>', [
        { label: 'Save & Leave', type: 'primary', onclick: () => { window._suppressBeforeUnload = true; saveQuote(); if (targetUrl) window.location.href = targetUrl; } },
        { label: 'Leave Without Saving', type: 'danger', onclick: () => { window._suppressBeforeUnload = true; if (targetUrl) window.location.href = targetUrl; } },
        { label: 'Cancel', type: 'secondary', onclick: () => { window._suppressBeforeUnload = false; } }
      ]);
    };

    // Prompt using native dialog on reload/close/navigation events
    window._suppressBeforeUnload = window._suppressBeforeUnload || false;
    window.addEventListener('beforeunload', (e) => {
      if (window._suppressBeforeUnload) return undefined;
      const hasUnsaved = (currentQuote.lineItems && currentQuote.lineItems.length > 0) || (document.getElementById('customer-name').value.trim() !== '') || ((parseFloat(document.getElementById('sales-uplift').value) || 0) !== 0);
      if (hasUnsaved) {
        e.preventDefault();
        e.returnValue = '';
        return '';
      }
      return undefined;
    });

    // Visualizer helpers
    function buildVisualizerSvgString(widthVal, heightVal, type = 'single', maxDim = 240) {
      const scaledWidth = widthVal * vizScale;
      const scaledHeight = heightVal * vizScale;
      const maxWidth = maxDim;
      const maxHeight = maxDim;

      let displayScale = 1;
      if (scaledWidth > maxWidth || scaledHeight > maxHeight) {
        const widthScale = maxWidth / scaledWidth;
        const heightScale = maxHeight / scaledHeight;
        displayScale = Math.min(widthScale, heightScale);
      }

      const displayWidth = scaledWidth * displayScale;
      const displayHeight = scaledHeight * displayScale;
      const margin = 40; // space around the drawn window
      const svgWidth = displayWidth + margin * 2;
      const svgHeight = displayHeight + margin * 2;

      const halfHeight = displayHeight / 2;
      const halfWidth = displayWidth / 2;

      const measureOffset = 15; // distance from rect to measurement line
      const measureLabelOffset = 5; // additional offset for the label text

      const typeMarkup = (() => {
        switch (type) {
          case 'single':
          case 'double':
            return `
              <line x1="${margin}" y1="${margin + halfHeight}" x2="${margin + displayWidth}" y2="${margin + halfHeight}"
                    stroke="black" stroke-width="3" />
            `;
          case 'slider':
            return `
              <line x1="${margin + halfWidth}" y1="${margin}" x2="${margin + halfWidth}" y2="${margin + displayHeight}"
                    stroke="black" stroke-width="3" />
            `;
          case 'casement':
            return `
              <line x1="${margin}" y1="${margin}" x2="${margin}" y2="${margin + displayHeight}"
                    stroke="black" stroke-width="4" />
            `;
          case 'awning':
            return `
              <line x1="${margin}" y1="${margin}" x2="${margin + displayWidth}" y2="${margin}"
                    stroke="black" stroke-width="4" />
            `;
          case 'fixed':
            return `
                <line x1="${margin}" y1="${margin + halfHeight}" x2="${margin + displayWidth}" y2="${margin + halfHeight}"
                  stroke="black" stroke-width="2" stroke-dasharray="5,5" />
                <line x1="${margin + halfWidth}" y1="${margin}" x2="${margin + halfWidth}" y2="${margin + displayHeight}"
                  stroke="black" stroke-width="2" stroke-dasharray="5,5" />
            `;
          default:
            return '';
        }
      })();

      return `
        <svg width="${svgWidth}" height="${svgHeight}" viewBox="0 0 ${svgWidth} ${svgHeight}">
          <defs>
            <marker id="vizArrowStart" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
              <polygon points="8,5 2,2 2,8" fill="#666" />
            </marker>
            <marker id="vizArrowEnd" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
              <polygon points="2,5 8,2 8,8" fill="#666" />
            </marker>
          </defs>

              <line x1="${margin}" y1="${margin - measureOffset}" x2="${margin + displayWidth}" y2="${margin - measureOffset}"
                stroke="#666" stroke-width="1"
                marker-start="url(#vizArrowStart)" marker-end="url(#vizArrowEnd)" />
              <text x="${displayWidth / 2 + margin}" y="${margin - (measureOffset + measureLabelOffset)}"
                text-anchor="middle" class="dimension-label">${widthVal}"</text>

              <line x1="${margin - measureOffset}" y1="${margin}" x2="${margin - measureOffset}" y2="${margin + displayHeight}"
                stroke="#666" stroke-width="1"
                marker-start="url(#vizArrowStart)" marker-end="url(#vizArrowEnd)" />
              <text x="${margin - (measureOffset + measureLabelOffset)}" y="${displayHeight / 2 + margin}"
                text-anchor="middle" class="dimension-label"
                transform="rotate(-90, ${margin - (measureOffset + measureLabelOffset)}, ${displayHeight / 2 + margin})">${heightVal}"</text>

              <rect x="${margin}" y="${margin}" width="${displayWidth}" height="${displayHeight}"
                fill="white" stroke="black" stroke-width="4" />

          ${typeMarkup}

          <g opacity="0.3">
            <line x1="34" y1="34" x2="${26 + displayWidth}" y2="${26 + displayHeight}" stroke="lightblue" stroke-width="1" />
            <line x1="${26 + displayWidth}" y1="34" x2="34" y2="${26 + displayHeight}" stroke="lightblue" stroke-width="1" />
          </g>
        </svg>
      `;
    }

    function renderVisualizer() {
      const svgContainer = document.getElementById('viz-svg-container');
      if (!svgContainer) return;
      // Use a max dimension slightly smaller than the canvas to ensure padding fits
      // Reduce slightly so measurement labels never get cropped for tall windows
      const svg = buildVisualizerSvgString(vizWidth, vizHeight, vizWindowType, 340);
      svgContainer.innerHTML = svg;
    }

    function syncVisualizerFromInputs() {
      const widthField = document.getElementById('width');
      const heightField = document.getElementById('height');
      vizWidth = parseFloat(widthField.value) || vizWidth || 36;
      vizHeight = parseFloat(heightField.value) || vizHeight || 60;
      renderVisualizer();
    }

    function svgToDataUrl(svgString) {
      return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));
    }

    function buildAddonModalList() {
      const sourceNodes = Array.from(document.querySelectorAll('#addons-list .addon-checkbox'));
      if (sourceNodes.length === 0) return '<p style="margin:0; color: var(--text-secondary); font-size: 13px;">No addons available for this product.</p>';
      return sourceNodes.map(node => {
        const input = node.querySelector('input');
        const label = node.querySelector('label');
        const checked = input && input.checked ? 'checked' : '';
        const id = input ? input.id : '';
        const value = input ? input.value : '';
        const text = label ? label.innerHTML : '';
        const dataLabel = node.dataset.label || '';
        return `
          <div class="addon-checkbox" data-label="${dataLabel}">
            <input type="checkbox" id="modal-${id}" data-sync-id="${id}" value="${value}" ${checked}>
            <label for="modal-${id}" style="margin: 0; flex: 1; font-weight: 500; text-transform: none;">${text}</label>
          </div>
        `;
      }).join('');
    }

    function openAddonModal() {
      const modalHtml = `
        <div style="display:flex; flex-direction:column; gap:12px; max-height:60vh;">
          <input type="text" id="addon-search" placeholder="Search addons..." style="padding:10px 12px; border: var(--border); border-radius:6px; font-size:14px; background: var(--bg-input);">
          <div id="addon-modal-list" style="max-height:48vh; overflow-y:auto; border: var(--border); border-radius:6px; padding:8px; background: var(--bg-surface);">
            ${buildAddonModalList()}
          </div>
        </div>
      `;

      const modalId = showModal('Select Addons', modalHtml, [
        { label: 'Done', type: 'primary', onclick: () => {} }
      ]);

      // Wire syncing and filtering once modal is in DOM
      setTimeout(() => {
        const modalEl = document.getElementById(modalId);
        if (!modalEl) return;
        const modalList = modalEl.querySelector('#addon-modal-list');
        const searchInput = modalEl.querySelector('#addon-search');

        // Sync checkboxes back to hidden list and trigger change events
        modalList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.addEventListener('change', () => {
            const targetId = cb.dataset.syncId;
            const original = document.getElementById(targetId);
            if (original) {
              original.checked = cb.checked;
              try { original.dispatchEvent(new Event('change', { bubbles: true })); } catch (e) { /* ignore */ }
            }
          });
        });

        // Filter by label text
        if (searchInput) {
          searchInput.addEventListener('input', () => {
            const term = searchInput.value.trim().toLowerCase();
            modalList.querySelectorAll('.addon-checkbox').forEach(item => {
              const label = item.dataset.label || '';
              item.style.display = term === '' || label.includes(term) ? 'flex' : 'none';
            });
          });
        }
      }, 0);
    }

    function openColorModal() {
      const colors = [
        { id: 'white', name: 'White', hex: '#ffffff' },
        { id: 'tan', name: 'Tan', hex: '#d6c3a6' },
        { id: 'adobe', name: 'Adobe', hex: '#c58b68' },
        { id: 'black', name: 'Black', hex: '#222222' }
      ];

      const items = colors.map(c => `
        <button class="btn-secondary" data-color="${c.id}" style="display:flex; align-items:center; gap:8px; padding:8px;">
          <span class="color-swatch" style="background:${c.hex}; width:20px; height:20px; border-radius:4px;"></span>
          <span style="font-weight:600;">${c.name}</span>
        </button>
      `).join('');

      const modalHtml = `<div style="display:flex; gap:8px; flex-wrap:wrap;">${items}</div>`;
      const modalId = showModal('Select Frame Color', modalHtml, [ { label: 'Done', type: 'primary', onclick: () => {} } ]);

      // Wire selection
      setTimeout(() => {
        const modalEl = document.getElementById(modalId);
        if (!modalEl) return;
        modalEl.querySelectorAll('button[data-color]').forEach(btn => {
          btn.addEventListener('click', () => {
            const color = btn.dataset.color;
            const map = { white: '#ffffff', tan: '#d6c3a6', adobe: '#c58b68', black: '#222222' };
            const hidden = document.getElementById('frame-color');
            if (hidden) hidden.value = color;
            updateColorPreview();
            // Visual feedback inside modal
            modalEl.querySelectorAll('button[data-color]').forEach(b => b.style.boxShadow = 'none');
            btn.style.boxShadow = '0 4px 10px rgba(0,0,0,0.08)';
          });
        });
      }, 0);
    }

    function updateColorPreview() {
      const hidden = document.getElementById('frame-color');
      const swatch = document.getElementById('frame-color-swatch');
      const label = document.getElementById('frame-color-label');
      if (!hidden || !swatch || !label) return;
      const v = hidden.value || 'white';
      const map = { white: '#ffffff', tan: '#d6c3a6', adobe: '#c58b68', black: '#222222' };
      swatch.style.background = map[v] || v;
      label.textContent = v.charAt(0).toUpperCase() + v.slice(1);
      // keep button text color unchanged to remain readable on all swatches
    }

    // Render selected product addons under the notes area
    window.renderSelectedAddons = () => {
      const container = document.getElementById('selected-addons');
      if (!container) return;
      const checked = Array.from(document.querySelectorAll('.product-addon:checked'))
        .map(cb => cb.value);

      if (checked.length === 0) {
        container.innerHTML = '<p style="margin:0; color: var(--text-secondary); font-size: 13px;">No selected addons</p>';
        return;
      }

      const allAddons = DataStorage.getAddons();
      const ui = parseInt(document.getElementById('total-ui').value) || 0;

      const html = checked.map(id => {
        const addon = allAddons[id];
        if (!addon) return '';
        const price = addon.pricingModel === 'UI' ? `$${(ui * addon.uiRate).toFixed(2)}` : `$${(addon.flatPrice || 0).toFixed(2)}`;
        return `<div style="display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom: 1px dashed rgba(0,0,0,0.04);">
                  <div style="font-weight:500;">${addon.name}</div>
                  <div style="color:var(--text-secondary); font-size:13px; display:flex; gap:8px; align-items:center;">
                    <div>${price}</div>
                    <button class="btn-secondary" style="padding:4px 8px; font-size:12px;" onclick="(function(id){ const cb = document.getElementById('addon-'+id); if(cb){ cb.checked=false; cb.dispatchEvent(new Event('change',{bubbles:true})); } })('${id}')">Remove</button>
                  </div>
                </div>`;
      }).join('');

      container.innerHTML = html;
    };

    function toggleExtras() {
      const extras = document.getElementById('extras-section');
      const toggle = document.getElementById('extras-toggle');
      if (!extras || !toggle) return;
      const isHidden = extras.style.display === 'none' || extras.style.display === '';
      extras.style.display = isHidden ? 'block' : 'none';
      toggle.textContent = isHidden ? 'Hide Notes' : 'Show Notes';
    }

    function toggleStructural() {
      // Open structural options in a modal and sync changes back to the hidden fields
      const modalHtml = `
        <div style="display:flex; flex-direction:column; gap:12px;">
          <label style="font-size:12px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; margin:0;">Structural / Mulling</label>
          <select id="modal-mull" style="margin-top:4px; padding:8px;">
            <option value="">None</option>
            <option value="left">Left</option>
            <option value="right">Right</option>
            <option value="center">Center</option>
            <option value="above">Above</option>
            <option value="below">Below</option>
          </select>
          <div style="display:flex; gap:8px;">
            <div style="flex:1;">
              <label style="font-size:12px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; margin:0;">Hinge Side</label>
              <select id="modal-hinge" style="margin-top:4px; padding:8px; width:100%;">
                <option value="">Not Applicable</option>
                <option value="left">Left</option>
                <option value="right">Right</option>
              </select>
            </div>
            <div style="flex:1;">
              <label style="font-size:12px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; margin:0;">Swing</label>
              <select id="modal-swing" style="margin-top:4px; padding:8px; width:100%;">
                <option value="">Not Applicable</option>
                <option value="inswing">Inswing</option>
                <option value="outswing">Outswing</option>
              </select>
            </div>
          </div>
        </div>
      `;

      const modalId = showModal('Structural / Mulling', modalHtml, [ { label: 'Done', type: 'primary', onclick: () => {} } ]);

      // Wire sync: copy modal values back to main form selects as user changes them
      setTimeout(() => {
        const modalEl = document.getElementById(modalId);
        if (!modalEl) return;

        const mMull = modalEl.querySelector('#modal-mull');
        const mHinge = modalEl.querySelector('#modal-hinge');
        const mSwing = modalEl.querySelector('#modal-swing');

        const origMull = document.getElementById('mull-type');
        const origHinge = document.getElementById('hinge-side');
        const origSwing = document.getElementById('swing-type');

        if (origMull && mMull) mMull.value = origMull.value || '';
        if (origHinge && mHinge) mHinge.value = origHinge.value || '';
        if (origSwing && mSwing) mSwing.value = origSwing.value || '';

        [mMull, mHinge, mSwing].forEach(el => {
          if (!el) return;
          el.addEventListener('change', () => {
            try {
              const targetId = el.id === 'modal-mull' ? 'mull-type' : (el.id === 'modal-hinge' ? 'hinge-side' : 'swing-type');
              const orig = document.getElementById(targetId);
              if (orig) orig.value = el.value;
            } catch (err) {}
          });
        });
      }, 0);
    }

    // Expose UI toggles to inline handlers
    window.openAddonModal = openAddonModal;
    window.openColorModal = openColorModal;
    window.toggleExtras = toggleExtras;
    window.toggleStructural = toggleStructural;

    function deriveVisualizerType(product) {
      if (!product) return vizWindowType;
      const productLines = DataStorage.getProductLines();
      const line = productLines[product.productLineId];
      const code = (product.productTypeCode || '').toUpperCase();
      const name = (product.name || '').toUpperCase();
      const lineName = (line && line.name ? line.name : '').toUpperCase();
      const haystack = `${code} ${name} ${lineName}`;

      const contains = (s) => haystack.includes(s);

      if (contains('SLIDER') || code === 'SL' || code.startsWith('SL')) return 'slider';
      if (contains('DOUBLE') || code === 'DH' || code.startsWith('DH')) return 'double';
      if (contains('SINGLE') || code === 'SH' || code.startsWith('SH')) return 'single';
      if (contains('CASE') || contains('CAS') || code === 'CS' || code.startsWith('CA')) return 'casement';
      if (contains('AWNING') || code === 'AW' || code.startsWith('AW')) return 'awning';
      if (contains('PICTURE') || contains('FIX') || contains('FX') || code === 'PW' || code === 'FX') return 'fixed';
      if (contains('BAY') || contains('BOW')) return 'fixed';

      return vizWindowType;
    }

    // Intercept anchor clicks to present the save modal for in-app navigation
    document.addEventListener('click', (e) => {
      const a = e.target && e.target.closest ? e.target.closest('a') : null;
      if (!a) return;

      // If the anchor already has an inline onclick handler, skip interception to avoid duplicates
      if (a.hasAttribute && a.hasAttribute('onclick')) return;

      const href = a.getAttribute('href');
      if (!href) return;

      // Ignore anchors that are purely hash/navigation within page or explicitly opted-out
      if (href.startsWith('#') || href.startsWith('javascript:') || a.target === '_blank' || (a.dataset && a.dataset.noPrompt === 'true')) return;

      // Intercept navigation and show modal
      e.preventDefault();
      confirmLeaveAdmin(e, href);
    });

    window.newQuote = () => {
      if (currentQuote.lineItems.length > 0) {
        if (!confirm('Start a new quote? Current quote will be lost if not saved.')) return;
      }
      currentQuote = {
        id: `quote_${Date.now()}`,
        customerName: '',
        lineItems: [],
        salesUplift: 0,
        selectedJobAddonIds: []
      };
      document.getElementById('customer-name').value = '';
      document.getElementById('spouse-name').value = '';
      document.getElementById('customer-address').value = '';
      document.getElementById('customer-phone').value = '';
      document.getElementById('customer-email').value = '';
      document.getElementById('job-notes').value = '';
      // Set today's date
      try { document.getElementById('quote-date').value = new Date().toISOString().split('T')[0]; } catch (e) {}
      document.getElementById('sales-uplift').value = '0';
      updateQuoteDisplay();
    };

    window.saveQuote = () => {
      const customerName = document.getElementById('customer-name').value.trim();
      if (!customerName) {
        return showAlert('Please enter customer name');
      }
      if (currentQuote.lineItems.length === 0) {
        return showAlert('Quote must have at least one line item');
      }

      currentQuote.customerName = customerName;
      currentQuote.spouseName = document.getElementById('spouse-name').value.trim();
      currentQuote.address = document.getElementById('customer-address').value.trim();
      currentQuote.phone = document.getElementById('customer-phone').value.trim();
      currentQuote.email = document.getElementById('customer-email').value.trim();
      currentQuote.quoteDate = document.getElementById('quote-date').value;
      currentQuote.jobNotes = document.getElementById('job-notes').value.trim();
      currentQuote.salesUplift = parseFloat(document.getElementById('sales-uplift').value) || 0;

      try {
        // Calculate totals with selected job addons
        const allAddons = DataStorage.getAddons();
        const jobBasedAddons = currentQuote.selectedJobAddonIds.map(addonId => {
          const addon = allAddons[addonId];
          if (!addon) return null;
          
          let price = 0;
          if (addon.pricingModel === 'UI') {
            const totalUI = currentQuote.lineItems.reduce((sum, item) => sum + item.ui, 0);
            price = totalUI * addon.uiRate;
          } else {
            price = addon.flatPrice || 0;
          }
          
          return { id: addonId, name: addon.name, price };
        }).filter(a => a !== null);
        
        const quoteCalc = PricingEngine.calculateQuote({
          lineItems: currentQuote.lineItems,
          jobBasedAddons,
          salesUplift: currentQuote.salesUplift
        });

        // Create version
        const version = PricingEngine.createQuoteVersion({
          quoteId: currentQuote.id,
          lineItems: currentQuote.lineItems,
          jobBasedAddons,
          salesUplift: currentQuote.salesUplift,
          metadata: {
            customerName: currentQuote.customerName,
            ...quoteCalc
          }
        });

        // Save quote and version
        DataStorage.saveQuote(currentQuote);
        DataStorage.saveQuoteVersion(version);

        showAlert('Quote saved successfully!', 'success');
      } catch (error) {
        showAlert(error.message);
      }
    };

    window.showSavedQuotes = () => {
      const quotes = DataStorage.get(DataStorage.KEYS.QUOTES, {});
      const quoteList = Object.values(quotes);

      if (quoteList.length === 0) {
        return showAlert('No saved quotes found');
      }

      const html = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.35); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);" onclick="if(event.target === this) this.remove()">
          <div style="background: white; padding: 1.5rem; border-radius: 8px; max-width: 600px; width: 90%; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
            <h2 style="margin-top: 0; font-size: 1rem; font-weight: 600; letter-spacing: -0.01em; color: #18181b;">Load Quote</h2>
            <div class="saved-quotes">
              ${quoteList.map(q => {
                const versions = DataStorage.getQuoteVersions(q.id);
                const latestVersion = versions[versions.length - 1];
                return `
                  <div class="quote-item" onclick="loadQuote('${q.id}')">
                    <div class="quote-item-header">
                      <strong>${q.customerName || 'Unnamed Quote'}</strong>
                      <span>${latestVersion ? `$${latestVersion.finalPrice.toFixed(2)}` : ''}</span>
                    </div>
                    <div class="quote-item-meta">
                      ${q.id} • ${q.lineItems.length} items • ${versions.length} version(s)
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
            <button class="btn-secondary" style="margin-top: 1rem;" onclick="this.closest('div[style*=fixed]').remove()">Close</button>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
    };

    window.loadQuote = (quoteId) => {
      const quotes = DataStorage.get(DataStorage.KEYS.QUOTES, {});
      const quote = quotes[quoteId];
      if (!quote) return;

      currentQuote = JSON.parse(JSON.stringify(quote)); // Deep clone
      
      // Ensure mandatory job addons are included
      const allAddons = DataStorage.getAddons();
      const mandatoryJobAddonIds = Object.entries(allAddons)
        .filter(([id, addon]) => addon.isJobBased && addon.mandatory)
        .map(([id]) => id);
      currentQuote.selectedJobAddonIds = [...new Set([...(currentQuote.selectedJobAddonIds || []), ...mandatoryJobAddonIds])];
      
      document.getElementById('customer-name').value = quote.customerName || '';
      document.getElementById('spouse-name').value = quote.spouseName || '';
      document.getElementById('customer-address').value = quote.address || '';
      document.getElementById('customer-phone').value = quote.phone || '';
      document.getElementById('customer-email').value = quote.email || '';
      document.getElementById('quote-date').value = quote.quoteDate || new Date().toISOString().split('T')[0];
      document.getElementById('job-notes').value = quote.jobNotes || '';
      document.getElementById('sales-uplift').value = quote.salesUplift || 0;
      
      updateQuoteDisplay();
      document.querySelector('div[style*=fixed]')?.remove();
    };

    window.renderJobAddons = () => {
      const allAddons = DataStorage.getAddons();
      const jobAddons = Object.entries(allAddons)
        .filter(([id, addon]) => addon.isJobBased)
        .map(([id, addon]) => ({ id, ...addon }));

      // Ensure mandatory job addons are always selected
      const mandatoryJobAddonIds = jobAddons
        .filter(addon => addon.mandatory)
        .map(addon => addon.id);
      
      currentQuote.selectedJobAddonIds = [
        ...new Set([...currentQuote.selectedJobAddonIds, ...mandatoryJobAddonIds])
      ];

      if (jobAddons.length === 0) {
        document.getElementById('job-addons-section').innerHTML = '<p style="color: var(--text-secondary); font-size: 13px;">No job addons available</p>';
        return;
      }

      const addonHtml = jobAddons.map(addon => {
        const isSelected = currentQuote.selectedJobAddonIds.includes(addon.id);
        const isChecked = addon.mandatory || isSelected;
        const price = addon.pricingModel === 'UI' 
          ? '(UI-Based)' 
          : `$${addon.flatPrice.toFixed(2)}`;
        
        return `
          <div class="addon-checkbox">
            <input type="checkbox" id="job-addon-${addon.id}" class="job-addon" value="${addon.id}" ${isChecked ? 'checked' : ''} ${addon.mandatory ? 'disabled' : ''} onchange="updateJobAddonSelection()">
            <label for="job-addon-${addon.id}" style="margin: 0; flex: 1; font-weight: 500; text-transform: none;">
              ${addon.name} 
              <span style="color: var(--text-secondary); font-size: 12px;">${price}</span>
              ${addon.mandatory ? '<span style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: 600; margin-left: 8px;">MANDATORY</span>' : ''}
            </label>
          </div>
        `;
      }).join('');
      
      document.getElementById('job-addons-section').innerHTML = addonHtml;
    };

    window.updateJobAddonSelection = () => {
      currentQuote.selectedJobAddonIds = Array.from(document.querySelectorAll('.job-addon:checked'))
        .map(checkbox => checkbox.value);
      
      // Always include mandatory addons
      const allAddons = DataStorage.getAddons();
      const mandatoryJobAddonIds = Object.entries(allAddons)
        .filter(([id, addon]) => addon.isJobBased && addon.mandatory)
        .map(([id]) => id);
      
      currentQuote.selectedJobAddonIds = [...new Set([...currentQuote.selectedJobAddonIds, ...mandatoryJobAddonIds])];
      
      // Recalculate the quote total
      calculateQuoteTotal();
    };
    window.updateProductLineOptions = () => {
      const productLines = DataStorage.getProductLines();
      
      document.getElementById('product-line').innerHTML = 
        '<option value="">Select product line...</option>' +
        Object.values(productLines).map(pl => `<option value="${pl.id}">${pl.name}</option>`).join('');
      
      updateProductOptions();
    };

    window.updateProductOptions = () => {
      const productLineId = document.getElementById('product-line').value;
      const products = DataStorage.getProducts();
      const filtered = Object.values(products).filter(p => p.productLineId === productLineId);

      document.getElementById('product').innerHTML = 
        '<option value="">Select product...</option>' +
        filtered.map(p => `<option value="${p.id}">${p.productTypeCode} - ${p.name}</option>`).join('');
      
      updateProductInfo();
    };

    window.updateProductInfo = () => {
      const productId = document.getElementById('product').value;
      if (!productId) {
        document.getElementById('total-ui').value = '';
        document.getElementById('addons-section').style.display = 'none';
        return;
      }

      const products = DataStorage.getProducts();
      const product = products[productId];
      const allAddons = DataStorage.getAddons();

      // Auto-map visualizer type based on product
      const derivedViz = deriveVisualizerType(product);
      if (derivedViz && derivedViz !== vizWindowType) {
        vizWindowType = derivedViz;
        renderVisualizer();
      }
      
      // Calculate total UI from width + height
      const width = parseFloat(document.getElementById('width').value) || 0;
      const height = parseFloat(document.getElementById('height').value) || 0;
      const ui = Math.ceil(width + height);
      
      document.getElementById('total-ui').value = ui || '';
      
      // Get available addons for this product, excluding job-based addons
      const availableAddonIds = PricingEngine.getAvailableAddonsForProduct(product, ui, allAddons)
        .filter(addonId => !allAddons[addonId].isJobBased);
      
      if (availableAddonIds.length === 0) {
        document.getElementById('addons-section').style.display = 'none';
        return;
      }
      
      // Build addon checkboxes (kept hidden; surfaced via modal)
      const addonHtml = availableAddonIds.map(addonId => {
        const addon = allAddons[addonId];
        const price = addon.pricingModel === 'UI' 
          ? `$${(ui * addon.uiRate).toFixed(2)}` 
          : `$${addon.flatPrice.toFixed(2)}`;
        
        return `
          <div class="addon-checkbox" data-label="${addon.name.toLowerCase()}">
            <input type="checkbox" id="addon-${addonId}" class="product-addon" value="${addonId}">
            <label for="addon-${addonId}" style="margin: 0; flex: 1; font-weight: 500; text-transform: none;">
              ${addon.name} <span style="color: var(--text-secondary); font-size: 12px;">${price}</span>
            </label>
          </div>
        `;
      }).join('');
      
      document.getElementById('addons-list').innerHTML = addonHtml;
      document.getElementById('addons-section').style.display = 'block';

      // Attach change listeners so selected addons render under notes
      setTimeout(() => {
        document.querySelectorAll('.product-addon').forEach(cb => {
          cb.removeEventListener('change', renderSelectedAddons);
          cb.addEventListener('change', renderSelectedAddons);
        });
        renderSelectedAddons();
      }, 0);
    };

    window.addLineItem = () => {
      const roomLabel = document.getElementById('room-label').value.trim();
      const productId = document.getElementById('product').value;
      const frameColor = document.getElementById('frame-color') ? document.getElementById('frame-color').value : 'white';
      const width = parseFloat(document.getElementById('width').value);
      const height = parseFloat(document.getElementById('height').value);
      const mullType = document.getElementById('mull-type').value;
      const hingeSide = document.getElementById('hinge-side') ? document.getElementById('hinge-side').value : '';
      const swingType = document.getElementById('swing-type') ? document.getElementById('swing-type').value : '';

      if (!roomLabel || !productId || !width || !height) {
        return showAlert('Please fill all required fields');
      }

      const products = DataStorage.getProducts();
      const product = products[productId];
      const globalSettings = DataStorage.getGlobalSettings();
      const allAddons = DataStorage.getAddons();

      // Get selected addons
      const selectedAddonIds = Array.from(document.querySelectorAll('.product-addon:checked'))
        .map(checkbox => checkbox.value);

      try {
        // Calculate UI
        const ui = Math.ceil(width + height);
        
        // Validate against global minimum UI
        if (ui < globalSettings.minimumUI) {
          return showAlert(`Total UI (${ui}) must be at least ${globalSettings.minimumUI} inches`);
        }

        // Validate size limits if product has them
        const validation = PricingEngine.validateSize({ product, width, height });
        if (!validation.valid) {
          return showAlert(validation.errors.join(', '));
        }

        // Calculate line item with selected addons
        const lineItemCalc = PricingEngine.calculateLineItem({
          product,
          width,
          height,
          selectedAddonIds,
          allAddons
        });

        // Capture a downsized visualizer snapshot for the line item
        const vizSvg = buildVisualizerSvgString(width, height, vizWindowType, 160);
        const vizDataUrl = svgToDataUrl(vizSvg);

        // Add to quote
        currentQuote.lineItems.push({
          id: `item_${Date.now()}`,
          productId,
          roomLabel,
          width,
          height,
          ui,
          mullType,
          frameColor,
          hingeSide,
          swingType,
          vizType: vizWindowType,
          vizDataUrl,
          ...lineItemCalc
        });

        // Reset form
        document.getElementById('room-label').value = '';
        document.getElementById('product-line').value = '';
        document.getElementById('product').value = '';
        document.getElementById('width').value = '';
        document.getElementById('height').value = '';
        document.getElementById('total-ui').value = '';
        document.getElementById('mull-type').value = '';
        if (document.getElementById('hinge-side')) document.getElementById('hinge-side').value = '';
        if (document.getElementById('swing-type')) document.getElementById('swing-type').value = '';
        if (document.getElementById('frame-color')) { document.getElementById('frame-color').value = 'white'; updateColorPreview(); }
        document.getElementById('extra-notes').value = '';
        // Keep notes visible by design
        try { renderSelectedAddons(); } catch (e) {}
        const structuralSection = document.getElementById('structural-section');
        if (structuralSection) structuralSection.style.display = 'none';
        const structuralToggle = document.getElementById('structural-toggle');
        if (structuralToggle) structuralToggle.textContent = '⧉ Structural';
        document.getElementById('addons-list').innerHTML = '';
        document.getElementById('addons-section').style.display = 'none';

        updateQuoteDisplay();
      } catch (error) {
        showAlert(error.message);
      }
    };

    window.removeLineItem = (index) => {
      currentQuote.lineItems.splice(index, 1);
      updateQuoteDisplay();
    };

    window.calculateQuoteTotal = () => {
      updateQuoteDisplay();
    };

    function updateQuoteDisplay() {
      document.getElementById('quote-id').value = currentQuote.id;

      // Render job addons section
      renderJobAddons();

      // Render line items table
      if (currentQuote.lineItems.length === 0) {
        document.getElementById('line-items-table').innerHTML = '<p>No items added yet.</p>';
      } else {
        const products = DataStorage.getProducts();
        
        const html = `
          <table>
            <thead>
              <tr>
                <th style="width:48px;">#</th>
                <th>Room</th>
                <th>Product</th>
                <th>Color</th>
                <th>Size</th>
                <th>UI</th>
                <th>Preview</th>
                <th>Mulling</th>
                <th>Hinge</th>
                <th>Swing</th>
                <th>Addons</th>
                <th>Price</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${currentQuote.lineItems.map((item, index) => {
                const product = products[item.productId];
                const productName = product ? product.name : 'Unknown';
                const productCode = product ? product.productTypeCode : 'N/A';
                const mullLabel = {
                  'left': 'Left',
                  'right': 'Right',
                  'center': 'Center',
                  'above': 'Above',
                  'below': 'Below'
                };
                const mullText = item.mullType ? (mullLabel[item.mullType] || item.mullType) : 'None';
                
                // Display only visible addons
                const visibleAddons = item.appliedAddons.filter(a => !a.hidden);
                const addonsText = visibleAddons.length > 0 
                  ? visibleAddons.map(a => a.name).join(', ')
                  : 'None';
                const previewImg = item.vizDataUrl ? `<img src="${item.vizDataUrl}" alt="Preview" style="width: 120px; max-width: 120px; height: auto; display: block; border: 1px solid rgba(0,0,0,0.08); border-radius: 4px; background: #fafafa;">` : '<span style="color: #9ca3af; font-size: 11px;">No preview</span>';
                
                return `
                  <tr>
                    <td>${index + 1}</td>
                    <td>${item.roomLabel}</td>
                    <td>${productCode} - ${productName}</td>
                    <td><span class="color-swatch" style="background:${(function(){ const map={white:'#ffffff',tan:'#d6c3a6',adobe:'#c58b68',black:'#222222'}; return map[item.frameColor]||item.frameColor||'#ffffff'; })()}"></span>${item.frameColor ? (item.frameColor.charAt(0).toUpperCase()+item.frameColor.slice(1)) : 'N/A'}</td>
                    <td>${item.width}" × ${item.height}"</td>
                    <td>${item.ui}</td>
                    <td>${previewImg}</td>
                    <td>${mullText}</td>
                    <td>${item.hingeSide ? (item.hingeSide.charAt(0).toUpperCase() + item.hingeSide.slice(1)) : 'N/A'}</td>
                    <td>${item.swingType ? (item.swingType === 'inswing' ? 'Inswing' : item.swingType === 'outswing' ? 'Outswing' : item.swingType) : 'N/A'}</td>
                    <td><small>${addonsText}</small></td>
                    <td>$${item.lineItemParTotal.toFixed(2)}</td>
                    <td><button class="btn-danger" onclick="removeLineItem(${index})">Remove</button></td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
        document.getElementById('line-items-table').innerHTML = html;
      }

      // Calculate total with job addons (always, even with no line items)
      try {
        const salesUplift = parseFloat(document.getElementById('sales-uplift').value) || 0;
        const allAddons = DataStorage.getAddons();
        
        // Build job-based addons with their calculated prices
        const jobBasedAddons = currentQuote.selectedJobAddonIds.map(addonId => {
          const addon = allAddons[addonId];
          if (!addon) return null;
          
          let price = 0;
          if (addon.pricingModel === 'UI') {
            // For UI-based job addons, calculate based on total UI of all items
            const totalUI = currentQuote.lineItems.reduce((sum, item) => sum + item.ui, 0);
            price = totalUI * addon.uiRate;
          } else {
            price = addon.flatPrice || 0;
          }
          
          return { id: addonId, name: addon.name, price };
        }).filter(a => a !== null);
        
        const quoteCalc = PricingEngine.calculateQuote({
          lineItems: currentQuote.lineItems,
          jobBasedAddons,
          salesUplift
        });
        document.getElementById('final-price').textContent = `$${quoteCalc.finalPrice.toFixed(2)}`;
      } catch (error) {
        showAlert(error.message);
      }
    }

    window.generateQuoteDocument = () => {
      const customerName = document.getElementById('customer-name').value.trim();
      if (!customerName) {
        return showAlert('Please enter customer name');
      }

      // Ensure currentQuote captures latest contact/job fields even if not saved
      try {
        currentQuote.spouseName = document.getElementById('spouse-name').value.trim();
        currentQuote.address = document.getElementById('customer-address').value.trim();
        currentQuote.phone = document.getElementById('customer-phone').value.trim();
        currentQuote.email = document.getElementById('customer-email').value.trim();
        currentQuote.quoteDate = document.getElementById('quote-date').value;
        currentQuote.jobNotes = document.getElementById('job-notes').value.trim();
      } catch (e) {}

      try {
        const salesUplift = parseFloat(document.getElementById('sales-uplift').value) || 0;
        const allAddons = DataStorage.getAddons();
        
        const jobBasedAddons = currentQuote.selectedJobAddonIds.map(addonId => {
          const addon = allAddons[addonId];
          if (!addon) return null;
          
          let price = 0;
          if (addon.pricingModel === 'UI') {
            const totalUI = currentQuote.lineItems.reduce((sum, item) => sum + item.ui, 0);
            price = totalUI * addon.uiRate;
          } else {
            price = addon.flatPrice || 0;
          }
          
          return { id: addonId, name: addon.name, price };
        }).filter(a => a !== null);
        
        const quoteCalc = PricingEngine.calculateQuote({
          lineItems: currentQuote.lineItems,
          jobBasedAddons,
          salesUplift
        });

        // Generate simple text quote
        let doc = `QUOTE: ${currentQuote.id}\n`;
        doc += `Customer: ${customerName}\n`;
        if (currentQuote.spouseName) doc += `Co-Owner: ${currentQuote.spouseName}\n`;
        doc += `Date: ${currentQuote.quoteDate || new Date().toLocaleDateString()}\n`;
        if (currentQuote.address) doc += `Address: ${currentQuote.address}\n`;
        if (currentQuote.phone) doc += `Phone: ${currentQuote.phone}\n`;
        if (currentQuote.email) doc += `Email: ${currentQuote.email}\n`;
        if (currentQuote.jobNotes) doc += `Job Notes: ${currentQuote.jobNotes}\n`;
        doc += `\n`;
        doc += `LINE ITEMS:\n`;
        doc += `${'='.repeat(80)}\n`;

        const products = DataStorage.getProducts();
        currentQuote.lineItems.forEach((item, index) => {
          const product = products[item.productId];
          const productName = product ? product.name : 'Unknown';
          const productCode = product ? product.productTypeCode : 'N/A';
          
          doc += `${index + 1}. [${item.roomLabel}] ${productCode} - ${productName}\n`;
          doc += `   Size: ${item.width}" × ${item.height}" (${item.ui} UI)\n`;
            if (item.frameColor) {
              doc += `   Color: ${item.frameColor.charAt(0).toUpperCase() + item.frameColor.slice(1)}\n`;
            }
          
          if (item.mullType) {
            const mullLabel = {
              'left': 'Left',
              'right': 'Right',
              'center': 'Center',
              'above': 'Above',
              'below': 'Below'
            };
            doc += `   Mulling: ${mullLabel[item.mullType] || item.mullType}\n`;
          }
          if (item.hingeSide) {
            doc += `   Hinge Side: ${item.hingeSide.charAt(0).toUpperCase() + item.hingeSide.slice(1)}\n`;
          }
          if (item.swingType) {
            doc += `   Swing: ${item.swingType === 'inswing' ? 'Inswing' : item.swingType === 'outswing' ? 'Outswing' : item.swingType}\n`;
          }
          
          const visibleAddons = item.appliedAddons.filter(a => !a.hidden);
          if (visibleAddons.length > 0) {
            doc += `   Options: ${visibleAddons.map(a => a.name).join(', ')}\n`;
          }
          doc += `   Price: $${item.lineItemParTotal.toFixed(2)}\n\n`;
        });

        if (jobBasedAddons.length > 0) {
          doc += `${'='.repeat(80)}\n`;
          doc += `JOB ADDONS:\n`;
          jobBasedAddons.forEach(addon => {
            doc += `  - ${addon.name}: $${addon.price.toFixed(2)}\n`;
          });
        }

        doc += `${'='.repeat(60)}\n`;
        doc += `TOTAL: $${quoteCalc.finalPrice.toFixed(2)}\n`;

        // Download as text file
        const blob = new Blob([doc], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `quote-${currentQuote.id}.txt`;
        a.click();
      } catch (error) {
        showAlert(error.message);
      }
    };

    // Initialize
    function init() {
      // Debug: Check what data we have
      const productLines = DataStorage.getProductLines();
      const products = DataStorage.getProducts();
      console.log('Product Lines:', productLines);
      console.log('Products:', products);

      // Initialize mandatory job addons
      const allAddons = DataStorage.getAddons();
      const mandatoryJobAddonIds = Object.entries(allAddons)
        .filter(([id, addon]) => addon.isJobBased && addon.mandatory)
        .map(([id]) => id);
      currentQuote.selectedJobAddonIds = [...new Set([...currentQuote.selectedJobAddonIds, ...mandatoryJobAddonIds])];

      // Populate product lines
      updateProductLineOptions();
      
      // Add event listeners to width/height to update UI
      const widthField = document.getElementById('width');
      const heightField = document.getElementById('height');
      widthField.addEventListener('input', () => { updateProductInfo(); syncVisualizerFromInputs(); });
      heightField.addEventListener('input', () => { updateProductInfo(); syncVisualizerFromInputs(); });

      // Initialize width/height defaults for visualizer if empty
      if (!widthField.value) widthField.value = vizWidth;
      if (!heightField.value) heightField.value = vizHeight;

      // Ensure quote date defaults to today if not set
      try {
        const qd = document.getElementById('quote-date');
        if (qd && !qd.value) qd.value = new Date().toISOString().split('T')[0];
      } catch (e) {}

      // Initialize frame color picker
      try {
        const fc = document.getElementById('frame-color');
        if (fc) {
          if (!fc.value) fc.value = 'white';
          fc.addEventListener('change', updateColorPreview);
          updateColorPreview();
        }
      } catch (e) {}

      renderVisualizer();
      
      updateQuoteDisplay();

      // Clean up any leftover modal overlays (can persist when navigating back via bfcache)
      try {
        document.querySelectorAll('[id^="modal-"]').forEach(m => m.remove());
      } catch (err) {
        console.warn('Modal cleanup failed', err);
      }

      // Refresh product data when page becomes visible (returns from admin panel)
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          updateProductLineOptions();
          // Remove any stray modal overlays that might block input when returning
          document.querySelectorAll('[id^="modal-"]').forEach(m => m.remove());
        }
      });

      // pageshow can fire when returning from bfcache; ensure overlays are removed
      window.addEventListener('pageshow', () => {
        document.querySelectorAll('[id^="modal-"]').forEach(m => m.remove());
      });
    }

    init();
  </script>
</body>
</html>
